{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Школьная Платформа</title>
    
    <!-- Подключаем иконки Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- ПОДКЛЮЧАЕМ ВСЕ СТИЛИ ЗДЕСЬ -->
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/admin_panel.css' %}">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/school_structure.css' %}">
    <style>
        /* Добавляем стиль для скрытия неактивных страниц */
        .page-content {
            display: none;
        }
    </style>
</head>
<body>
    
    <div class="container">
        <!-- ===================================================================== -->
        <!-- === ОБЩАЯ ШАПКА (видна на всех страницах) === -->
        <!-- ===================================================================== -->
        <header class="site-header">
            <div class="logo-section">
                <div class="logo-icon">ШП</div>
                <div class="logo-text">
                    <h1>Школьная Платформа</h1>
                    <span>Система управления учебным процессом</span>
                </div>
            </div>
            <div class="user-section">
                <div class="user-profile">
                    <div class="user-info">
                        <p>Кузнецов Дмитрий Александрович</p>
                        <span>Администратор</span>
                    </div>
                    <div class="user-avatar">ДА</div>
                </div>
                <div class="role-switcher">
                    <i class="fa-solid fa-chalkboard-user"></i>
                    <span>Ученик</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
            </div>
        </header>

        <!-- ===================================================================== -->
        <!-- === ОБЩАЯ НАВИГАЦИЯ (видна на всех страницах) === -->
        <!-- ===================================================================== -->
        <nav class="main-nav">
            <ul>
                <!-- data-target используется JS для переключения контента -->
                <li><a href="#" data-target="home"><i class="fa-solid fa-house"></i> Главная</a></li>
                <li><a href="#" data-target="users" class="active"><i class="fa-solid fa-users"></i> Пользователи</a></li>
                <li><a href="#" data-target="structure"><i class="fa-solid fa-sitemap"></i> Структура школы</a></li>
                <li><a href="#" data-target="assignments"><i class="fa-solid fa-tags"></i> Назначения</a></li>
                <li><a href="#" data-target="settings"><i class="fa-solid fa-gear"></i> Настройки</a></li>
            </ul>
        </nav>

        <!-- ===================================================================== -->
        <!-- === ОСНОВНОЙ КОНТЕЙНЕР ДЛЯ ДИНАМИЧЕСКОГО КОНТЕНТА === -->
        <!-- ===================================================================== -->
        <main id="app-content">
            
            <!-- СТРАНИЦА "УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ" -->
            <div id="page-users" class="page-content">
                <div class="page-header">
                    <div class="page-title">
                        <h2>Управление пользователями</h2>
                        <p>Создание, редактирование и управление учетными записями</p>
                    </div>
                    <button class="btn-primary" id="create-user-btn">
                        <i class="fa-solid fa-plus"></i>
                        Создать пользователя
                    </button>
                </div>
        
                <div class="content-card">
                    <form method="GET" action="{% url 'admin_panel' %}" class="filters-toolbar">
                        <!-- Добавлен для получения токена в JS -->
                        {% csrf_token %}
                        <div class="search-group">
                            <i class="fa-solid fa-search"></i>
                            <input type="text" name="q" placeholder="Поиск по имени или email..." value="{{ search_query }}">
                        </div>
                        <select name="role" class="filter-select">
                            <option value="">Все роли</option>
                            {% for value, display_name in role_choices %}
                                <option value="{{ value }}" {% if role_filter == value %}selected{% endif %}>
                                    {{ display_name }}
                                </option>
                            {% endfor %}
                        </select>
                        <select name="status" class="filter-select">
                            <option value="">Все статусы</option>
                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Активен</option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Заблокирован</option>
                        </select>
                        <button type="submit" class="btn-primary">Применить</button>
                        <a href="{% url 'admin_panel' %}" class="btn-secondary">Сбросить</a>
                    </form>
        
                    <nav class="content-tabs">
                        <ul>
                            <li>
                                <a href="#" class="active">
                                    Пользователи
                                    <span class="count-badge">{{ users.count }}</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
        
                    <div class="table-wrapper">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>ФИО</th>
                                    <th>Email</th>
                                    <th>Телефон</th>
                                    <th>Роль</th>
                                    <th>Статус</th>
                                    <th>Последний вход</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_obj in users %}
                                <!-- ИЗМЕНЕНИЕ: Добавлен data-атрибут для легкого поиска строки -->
                                <tr data-user-row-id="{{ user_obj.id }}">
                                    <td>{{ user_obj.get_full_name|default:user_obj.username }}</td>
                                    <td class="user-name-cell">
                                        <span>{{ user_obj.email|default:"-" }}</span>
                                        {% if user_obj.email %}<i class="fa-regular fa-envelope"></i>{% endif %}
                                    </td>
                                    <td>
                                        {{ user_obj.profile.phone_number|default:"-" }}
                                    </td>
                                    <td>
                                        {% if user_obj.profile and user_obj.profile.role %}
                                            {% if user_obj.profile.role == 'teacher' %}
                                                <span class="role-badge role-teacher">{{ user_obj.profile.get_role_display }}</span>
                                            {% elif user_obj.profile.role == 'student' %}
                                                <span class="role-badge role-student">{{ user_obj.profile.get_role_display }}</span>
                                            {% elif user_obj.profile.role == 'headteacher' %}
                                                <span class="role-badge role-headteacher">{{ user_obj.profile.get_role_display }}</span>
                                            {% else %}
                                                <span>{{ user_obj.profile.get_role_display }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span>-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user_obj.is_active %}
                                            <span class="status-badge status-active">Активен</span>
                                        {% else %}
                                            <span class="status-badge status-blocked">Заблокирован</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ user_obj.last_login|date:"Y-m-d H:i"|default:"Никогда" }}</td>
                                    <td class="action-icons">
                                        <!-- ИЗМЕНЕНИЕ: Оборачиваем все иконки в теги <a> и добавляем классы/атрибуты -->
                                        <a href="#" class="edit-btn" data-user-id="{{ user_obj.id }}" title="Редактировать"><i class="fa-solid fa-pencil"></i></a>
                                        <a href="#" class="block-user-btn" data-user-id="{{ user_obj.id }}" title="{% if user_obj.is_active %}Заблокировать{% else %}Разблокировать{% endif %}">
                                            <i class="fa-solid fa-lock{% if not user_obj.is_active %}-open{% endif %}"></i>
                                        </a>
                                        <a href="#" class="delete-user-btn" data-user-id="{{ user_obj.id }}" title="Удалить"><i class="fa-solid fa-trash-can"></i></a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 24px;">Пользователи не найдены.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- СТРАНИЦА "СТРУКТУРА ШКОЛЫ" (ИНТЕГРИРОВАННЫЙ ОБНОВЛЕННЫЙ КОД) -->
            <div id="page-structure" class="page-content">
                <div class="page-header">
                    <h2><i class="fa-solid fa-graduation-cap"></i> Управление структурой школы</h2>
                    <p>Создание и редактирование классов и предметов</p>
                </div>
        
                <div class="content-card">
                    <div class="card-header">
                        <nav class="content-tabs">
                            <a href="#" class="active"><i class="fa-solid fa-people-roof"></i> Классы <span class="count-badge">{{ structure_school_classes.count }}</span></a>
                            <a href="#"><i class="fa-solid fa-book"></i> Предметы <span class="count-badge">{{ subjects.count }}</span></a>
                        </nav>
                        <button class="btn-success" id="create-class-btn"><i class="fa-solid fa-plus"></i> Создать класс</button>
                    </div>
        
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Класс</th>
                                <th>Количество учеников</th>
                                <th>Классный руководитель</th>
                                <th style="text-align: end;">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for s_class in structure_school_classes %}
                            <tr>
                                <td><strong>{{ s_class.name }}</strong></td>
                                <td class="student-count-cell"><i class="fa-solid fa-user-group"></i> {{ s_class.student_count }}</td>
                                <td>{{ s_class.class_teacher.user.get_full_name|default:"Не назначен" }}</td>
                                <td class="action-icons" style="justify-content: end; gap:40px;">
                                    <!-- ОБНОВЛЕНО: Добавлены data-атрибуты для JS -->
                                    <a href="#" class="edit-class-btn" data-class-id="{{ s_class.id }}"><i class="fa-solid fa-pencil"></i></a>
                                    <a href="#" class="delete-class-btn" data-class-id="{{ s_class.id }}"><i class="fa-solid fa-trash-can"></i></a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" style="text-align: center; padding: 24px;">Классы еще не созданы.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Другие страницы (заглушки) -->
            <div id="page-home" class="page-content">
                 <div class="content-card"><h2>Главная страница</h2><p>Этот контент находится в разработке.</p></div>
            </div>
            <div id="page-assignments" class="page-content">
                 <div class="content-card"><h2>Назначения</h2><p>Этот контент находится в разработке.</p></div>
            </div>
            <div id="page-settings" class="page-content">
                 <div class="content-card"><h2>Настройки</h2><p>Этот контент находится в разработке.</p></div>
            </div>

        </main>
    </div>

    <!-- ===================================================================== -->
    <!-- === МОДАЛЬНОЕ ОКНО ДЛЯ ПОЛЬЗОВАТЕЛЕЙ (без изменений) === -->
    <!-- ===================================================================== -->
    <div class="modal-overlay" id="user-modal-overlay">
        <div class="modal-container">
            <button class="close-btn" id="close-modal-btn">&times;</button>
            <div class="modal-header">
                <h2 id="modal-title">Создать пользователя</h2>
                <p>Заполните информацию о пользователе</p>
            </div>
            
            <form id="user-form" novalidate>
                {% csrf_token %}
                <input type="hidden" name="user_id" id="id_user_id">
                
                <div class="form-group">
                    <label for="id_full_name">ФИО</label>
                    <input type="text" name="full_name" id="id_full_name" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="id_email">Email</label>
                        <input type="email" name="email" id="id_email" required>
                    </div>
                    <div class="form-group">
                        <label for="id_phone_number">Телефон</label>
                        <input type="tel" name="phone_number" id="id_phone_number">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="id_role">Роль</label>
                        <select name="role" id="id_role" required>
                            {% for value, display_name in role_choices %}
                                <option value="{{ value }}">{{ display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_is_active">Статус</label>
                        <select name="is_active" id="id_is_active" required>
                            <option value="True">Активен</option>
                            <option value="False">Заблокирован</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="class-field-wrapper" style="display: none;">
                    <label for="id_school_class">Класс</label>
                    <select name="school_class" id="id_school_class">
                        <option value="">Выберите класс</option>
                        {% for class in school_classes %}
                            <option value="{{ class.id }}">{{ class.name }} ({{ class.school.name }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" id="subject-field-wrapper" style="display: none;">
                    <label for="id_subjects">Предметы</label>
                    <select name="subjects" id="id_subjects" multiple>
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancel-btn">Отмена</button>
                    <button type="submit" class="btn-submit" id="submit-btn">Создать</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ===================================================================== -->
    <!-- === НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ РЕДАКТИРОВАНИЯ КЛАССА (без изменений) === -->
    <!-- ===================================================================== -->
    <div class="modal-overlay" id="class-modal-overlay">
        <div class="modal-container">
            <button class="close-btn" id="close-class-modal-btn">&times;</button>
            <div class="modal-header">
                <h2 id="class-modal-title">Редактировать класс</h2>
                <p>Заполните информацию о классе</p>
            </div>
            
            <form id="class-form" novalidate>
                {% csrf_token %}
                <input type="hidden" name="class_id" id="id_class_id">
                
                <!-- === НОВОЕ ПОЛЕ ДЛЯ ВЫБОРА ШКОЛЫ === -->
                <div class="form-group">
                    <label for="id_school_for_class">Школа</label>
                    <select name="school" id="id_school_for_class" required>
                        <option value="">-- Выберите школу --</option>
                        {% for school in all_schools %}
                            <option value="{{ school.id }}">{{ school.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="id_class_name">Название класса</label>
                    <input type="text" name="name" id="id_class_name" placeholder="Например, 10Б" required>
                </div>

                <div class="form-group">
                    <label for="id_class_teacher">Классный руководитель</label>
                    <select name="class_teacher" id="id_class_teacher">
                        <option value="">Не назначен</option>
                        {% for teacher in all_teachers %}
                            <option value="{{ teacher.user.id }}">{{ teacher.user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Количество учеников</label>
                    <p id="student-count-display" style="font-weight: bold; margin-top: 8px;">-</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancel-class-btn">Отмена</button>
                    <button type="submit" class="btn-submit" id="submit-class-btn">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===================================================================== -->
    <!-- === JAVASCRIPT === -->
    <!-- ===================================================================== -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('.main-nav a');
        const contentPages = document.querySelectorAll('.page-content');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const initUserManagementScripts = () => {
            const page = document.getElementById('page-users');
            if (!page) return;

            const modalOverlay = document.getElementById('user-modal-overlay');
            const form = document.getElementById('user-form');
            const modalTitle = document.getElementById('modal-title');
            const submitBtn = document.getElementById('submit-btn');
            const roleSelect = document.getElementById('id_role');
            const classField = document.getElementById('class-field-wrapper');
            const subjectField = document.getElementById('subject-field-wrapper');

            const openModal = () => modalOverlay.style.display = 'flex';
            const closeModal = () => modalOverlay.style.display = 'none';

            const toggleConditionalFields = () => {
                const role = roleSelect.value;
                classField.style.display = (role === 'student') ? 'block' : 'none';
                subjectField.style.display = (role === 'teacher') ? 'block' : 'none';
            };

            document.getElementById('create-user-btn').addEventListener('click', () => {
                form.reset();
                form.querySelector('#id_user_id').value = '';
                modalTitle.textContent = 'Создать пользователя';
                submitBtn.textContent = 'Создать';
                toggleConditionalFields();
                openModal();
            });

            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            roleSelect.addEventListener('change', toggleConditionalFields);

            page.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    const userId = button.dataset.userId;
                    const response = await fetch(`/api/user/${userId}/details/`);
                    if (response.ok) {
                        const data = await response.json();
                        form.querySelector('#id_user_id').value = data.id;
                        form.querySelector('#id_full_name').value = data.full_name;
                        form.querySelector('#id_email').value = data.email;
                        form.querySelector('#id_phone_number').value = data.phone_number || '';
                        form.querySelector('#id_role').value = data.role;
                        form.querySelector('#id_is_active').value = data.is_active ? 'True' : 'False';
                        if (data.school_class_id) form.querySelector('#id_school_class').value = data.school_class_id;
                        const subjectSelect = form.querySelector('#id_subjects');
                        Array.from(subjectSelect.options).forEach(opt => opt.selected = data.subject_ids.includes(parseInt(opt.value)));
                        modalTitle.textContent = 'Редактировать пользователя';
                        submitBtn.textContent = 'Сохранить';
                        toggleConditionalFields();
                        openModal();
                    }
                });
            });

            form.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(form);
                const subjectSelect = document.getElementById('id_subjects');
                if (subjectSelect.style.display !== 'none') {
                    formData.delete('subjects');
                    Array.from(subjectSelect.selectedOptions).forEach(opt => formData.append('subjects', opt.value));
                }
                const response = await fetch("/api/user/manage/", { method: 'POST', body: formData, headers: {'X-CSRFToken': csrfToken}});
                if (response.ok) location.reload();
                else alert('Ошибка валидации');
            });

            page.querySelectorAll('.block-user-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    const userId = button.dataset.userId;
                    const response = await fetch(`/api/user/${userId}/toggle-status/`, { method: 'POST', headers: {'X-CSRFToken': csrfToken }});
                    if (response.ok) {
                        const result = await response.json();
                        const row = document.querySelector(`tr[data-user-row-id="${userId}"]`);
                        const statusBadge = row.querySelector('.status-badge');
                        const lockIcon = button.querySelector('i');
                        if (result.is_active) {
                            statusBadge.textContent = 'Активен';
                            statusBadge.className = 'status-badge status-active';
                            lockIcon.className = 'fa-solid fa-lock';
                            button.title = 'Заблокировать';
                        } else {
                            statusBadge.textContent = 'Заблокирован';
                            statusBadge.className = 'status-badge status-blocked';
                            lockIcon.className = 'fa-solid fa-lock-open';
                            button.title = 'Разблокировать';
                        }
                    }
                });
            });

            page.querySelectorAll('.delete-user-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                        const userId = button.dataset.userId;
                        const response = await fetch(`/api/user/${userId}/delete/`, { method: 'POST', headers: {'X-CSRFToken': csrfToken }});
                        if (response.ok) button.closest('tr').remove();
                        else alert('Не удалось удалить пользователя.');
                    }
                });
            });
        };

        const initSchoolStructureScripts = () => {
            const page = document.getElementById('page-structure');
            if (!page) return;

            const modalOverlay = document.getElementById('class-modal-overlay');
            const form = document.getElementById('class-form');
            const modalTitle = document.getElementById('class-modal-title');
            const submitBtn = document.getElementById('submit-class-btn');
            const studentCount = document.getElementById('student-count-display');
            
            const openModal = () => modalOverlay.style.display = 'flex';
            const closeModal = () => modalOverlay.style.display = 'none';

            document.getElementById('create-class-btn').addEventListener('click', () => {
                form.reset();
                form.querySelector('#id_class_id').value = '';
                modalTitle.textContent = 'Создать новый класс';
                submitBtn.textContent = 'Создать';
                studentCount.textContent = '0';
                openModal();
            });

            document.getElementById('close-class-modal-btn').addEventListener('click', closeModal);
            document.getElementById('cancel-class-btn').addEventListener('click', closeModal);
            
            page.querySelectorAll('.edit-class-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    const classId = button.dataset.classId;
                    try {
                        const response = await fetch(`/api/class/${classId}/details/`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const data = await response.json();

                        form.querySelector('#id_class_id').value = data.id;
                        form.querySelector('#id_class_name').value = data.name;
                        form.querySelector('#id_school_for_class').value = data.school_id; // Установка школы
                        form.querySelector('#id_class_teacher').value = data.class_teacher_id || '';
                        studentCount.textContent = data.student_count;
                        modalTitle.textContent = 'Редактировать класс';
                        submitBtn.textContent = 'Сохранить';
                        openModal();
                    } catch (error) {
                         console.error("Ошибка при загрузке данных класса:", error);
                         alert("Не удалось загрузить данные класса.");
                    }
                });
            });

            form.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(form);
                try {
                    const response = await fetch("/api/class/manage/", {
                        method: 'POST',
                        body: formData,
                        headers: {'X-CSRFToken': csrfToken}
                    });
                    if (response.ok) {
                        closeModal();
                        location.reload();
                    } else {
                        const result = await response.json();
                        alert('Ошибка валидации: ' + JSON.stringify(result.errors));
                    }
                } catch (error) {
                    console.error("Ошибка при отправке формы класса:", error);
                    alert("Произошла сетевая ошибка.");
                }
            });

            page.querySelectorAll('.delete-class-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    if (confirm('Вы уверены, что хотите удалить класс?')) {
                        const classId = button.dataset.classId;
                        const response = await fetch(`/api/class/${classId}/delete/`, { method: 'POST', headers: {'X-CSRFToken': csrfToken}});
                        if (response.ok) button.closest('tr').remove();
                        else alert('Не удалось удалить класс.');
                    }
                });
            });

            const tabsNav = document.getElementById('structure-tabs-nav');
            const actionButtons = document.getElementById('structure-action-buttons');
            const tabPanes = page.querySelectorAll('.content-tab-pane');
            tabsNav.querySelectorAll('a').forEach(tabLink => {
                tabLink.addEventListener('click', e => {
                    e.preventDefault();
                    const targetTab = tabLink.dataset.tab;
                    tabsNav.querySelectorAll('a').forEach(link => link.classList.remove('active'));
                    tabLink.classList.add('active');
                    tabPanes.forEach(pane => pane.classList.toggle('active', pane.id === `tab-${targetTab}`));
                    actionButtons.querySelectorAll('button').forEach(btn => btn.style.display = 'none');
                    const targetBtn = document.getElementById(`create-${targetTab.slice(0, -1)}-btn`);
                    if (targetBtn) targetBtn.style.display = 'inline-flex';
                });
            });
        };
        
        const initSchoolManagementScripts = () => {
            const page = document.getElementById('page-structure');
            if (!page) return;

            // Элементы модального окна для школ
            const modalOverlay = document.getElementById('school-modal-overlay');
            const form = document.getElementById('school-form');
            const modalTitle = document.getElementById('school-modal-title');
            const submitBtn = document.getElementById('submit-school-btn');

            // Кнопки управления
            const createSchoolBtn = document.getElementById('create-school-btn');
            const closeModalBtn = document.getElementById('close-school-modal-btn');
            const cancelBtn = document.getElementById('cancel-school-btn');
            
            // Кнопки в таблице
            const editButtons = page.querySelectorAll('.edit-school-btn');
            const deleteButtons = page.querySelectorAll('.delete-school-btn');

            if (!modalOverlay || !form || !createSchoolBtn) {
                console.error("Не найдены ключевые элементы для модального окна школ.");
                return;
            }

            const openModal = () => modalOverlay.style.display = 'flex';
            const closeModal = () => modalOverlay.style.display = 'none';

            // Обработчики для закрытия модального окна
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);

            // Обработчик для кнопки "Создать школу"
            createSchoolBtn.addEventListener('click', () => {
                form.reset();
                form.querySelector('#id_school_id').value = '';
                modalTitle.textContent = 'Создать новую школу';
                submitBtn.textContent = 'Создать';
                openModal();
            });

            // Обработчики для кнопок "Редактировать" в каждой строке таблицы
            editButtons.forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    const schoolId = button.dataset.schoolId;
                    try {
                        const response = await fetch(`/api/school/${schoolId}/details/`);
                        if (response.ok) {
                            const data = await response.json();
                            form.querySelector('#id_school_id').value = data.id;
                            form.querySelector('#id_school_name').value = data.name;
                            form.querySelector('#id_school_address').value = data.address || '';
                            modalTitle.textContent = 'Редактировать школу';
                            submitBtn.textContent = 'Сохранить';
                            openModal();
                        } else {
                            alert('Не удалось загрузить данные школы.');
                        }
                    } catch (error) {
                        console.error("Ошибка при загрузке данных школы:", error);
                        alert("Произошла сетевая ошибка.");
                    }
                });
            });

            // Обработчик отправки формы (работает и для создания, и для редактирования)
            form.addEventListener('submit', async e => {
                e.preventDefault();
                try {
                    const response = await fetch('/api/school/manage/', {
                        method: 'POST',
                        body: new FormData(form),
                        headers: { 'X-CSRFToken': csrfToken }
                    });
                    if (response.ok) {
                        location.reload(); // Перезагружаем страницу для обновления данных
                    } else {
                        const result = await response.json();
                        alert('Ошибка валидации: ' + JSON.stringify(result.errors));
                    }
                } catch (error) {
                    console.error("Ошибка при отправке формы школы:", error);
                    alert("Произошла сетевая ошибка.");
                }
            });

            // Обработчики для кнопок "Удалить" в каждой строке
            deleteButtons.forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    if (confirm('Вы уверены, что хотите удалить эту школу? Все связанные данные могут быть утеряны.')) {
                        const schoolId = button.dataset.schoolId;
                        try {
                            const response = await fetch(`/api/school/${schoolId}/delete/`, {
                                method: 'POST',
                                headers: { 'X-CSRFToken': csrfToken }
                            });
                            if (response.ok) {
                                // Удаляем строку из таблицы без перезагрузки страницы
                                button.closest('tr').remove();
                            } else {
                                alert('Не удалось удалить школу.');
                            }
                        } catch (error) {
                            console.error("Ошибка при удалении школы:", error);
                            alert("Произошла сетевая ошибка.");
                        }
                    }
                });
            });
        };

        const navigateTo = (pageId) => {
            contentPages.forEach(page => page.style.display = 'none');
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) targetPage.style.display = 'block';
            navLinks.forEach(link => link.classList.toggle('active', link.dataset.target === pageId));
        };

        navLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                navigateTo(e.currentTarget.dataset.target);
            });
        });

        navigateTo('users');
        initUserManagementScripts();
        initSchoolStructureScripts();
        initSchoolManagementScripts();
    });
    </script>
</body>
</html>