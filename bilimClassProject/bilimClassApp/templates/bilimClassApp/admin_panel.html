{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Школьная Платформа</title>
    
    <!-- Подключаем иконки Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    
    <!-- ПОДКЛЮЧАЕМ ВСЕ СТИЛИ ЗДЕСЬ -->
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/admin_panel.css' %}">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/school_structure.css' %}">
    <style>
        /* Добавляем стиль для скрытия неактивных страниц и вкладок */
        .page-content, .content-tab-pane {
            display: none;
        }
        .page-content.active, .content-tab-pane.active {
            display: block;
        }

        .td-user-section { display: flex; align-items: center; gap: 16px; }
        .td-user-info { text-align: right; } .td-user-info h3 { font-weight: 600; }
        .td-user-info p { font-size: 14px; color: var(--text-secondary); }
        .td-user-link { text-decoration: none; color: inherit; }
        .td-user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #D8B4FE; color: #581C87; display: grid; place-items: center; font-weight: 600; }
    </style>
</head>
<body>
    
    <div class="container">
        <!-- ===================================================================== -->
        <!-- === ОБЩАЯ ШАПКА (видна на всех страницах) === -->
        <!-- ===================================================================== -->
        <header class="site-header">
            <div class="logo-section">
                <div class="logo-icon">ШП</div>
                <div class="logo-text">
                    <h1>Школьная Платформа</h1>
                    <span>Система управления учебным процессом</span>
                </div>
            </div>
            <div class="td-user-section">
                <div class="td-user-info">
                    <a href="{% url 'profile' %}" class="td-user-link">
                        <h3>{{ user.get_full_name }}</h3>
                    </a>
                    <p>Ученик</p>
                    <a href="{% url 'logout' %}" class="logout-link" style="font-size: 14px; color: #6B7280;" title="Выйти из аккаунта">
                        Выйти
                    </a>
                </div>
                <a href="{% url 'profile' %}" class="td-user-link">
                    <div class="td-user-avatar">{{ user.first_name|first }}{{ user.last_name|first }}</div>
                </a>
            </div>
        </header>

        <!-- ===================================================================== -->
        <!-- === ОБЩАЯ НАВИГАЦИЯ (видна на всех страницах) === -->
        <!-- ===================================================================== -->
        <nav class="main-nav">
            <ul>
                <!-- data-target используется JS для переключения контента -->
                <li><a href="#" data-target="home"><i class="fa-solid fa-house"></i> Главная</a></li>
                <li><a href="#" data-target="users" class="active"><i class="fa-solid fa-users"></i> Пользователи</a></li>
                <li><a href="#" data-target="structure"><i class="fa-solid fa-sitemap"></i> Структура школы</a></li>
                <li><a href="#" data-target="assignments"><i class="fa-solid fa-user-tag"></i> Назначения</a></li>
                <li><a href="#" data-target="settings"><i class="fa-solid fa-gear"></i> Настройки</a></li>
            </ul>
        </nav>

        <!-- ===================================================================== -->
        <!-- === ОСНОВНОЙ КОНТЕЙНЕР ДЛЯ ДИНАМИЧЕСКОГО КОНТЕНТА === -->
        <!-- ===================================================================== -->
        <main id="app-content">
            
            <!-- СТРАНИЦА "УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ" -->
            <div id="page-users" class="page-content active">
                <div class="page-header">
                    <div class="page-title">
                        <h2>Управление пользователями</h2>
                        <p>Создание, редактирование и управление учетными записями</p>
                    </div>
                    <button class="btn-primary" id="create-user-btn">
                        <i class="fa-solid fa-plus"></i>
                        Создать пользователя
                    </button>
                </div>
        
                <div class="content-card">
                    <form method="GET" action="{% url 'admin_panel' %}" class="filters-toolbar">
                        <!-- Добавлен для получения токена в JS -->
                        {% csrf_token %}
                        <div class="search-group">
                            <i class="fa-solid fa-search"></i>
                            <input type="text" name="q" placeholder="Поиск по имени или email..." value="{{ search_query }}">
                        </div>
                        <select name="role" class="filter-select">
                            <option value="">Все роли</option>
                            {% for value, display_name in role_choices %}
                                <option value="{{ value }}" {% if role_filter == value %}selected{% endif %}>
                                    {{ display_name }}
                                </option>
                            {% endfor %}
                        </select>
                        <select name="status" class="filter-select">
                            <option value="">Все статусы</option>
                            <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Активен</option>
                            <option value="inactive" {% if status_filter == 'inactive' %}selected{% endif %}>Заблокирован</option>
                        </select>
                        <button type="submit" class="btn-primary">Применить</button>
                        <a href="{% url 'admin_panel' %}" class="btn-secondary">Сбросить</a>
                    </form>
        
                    <nav class="content-tabs">
                        <ul>
                            <li>
                                <a href="#" class="active">
                                    Пользователи
                                    <span class="count-badge">{{ users.count }}</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
        
                    <div class="table-wrapper">
                        <table class="users-table">
                            <thead>
                                <tr>
                                    <th>ФИО</th>
                                    <th>Email</th>
                                    <th>Телефон</th>
                                    <th>Роль</th>
                                    <th>Статус</th>
                                    <th>Последний вход</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user_obj in users %}
                                <!-- ИЗМЕНЕНИЕ: Добавлен data-атрибут для легкого поиска строки -->
                                <tr data-user-row-id="{{ user_obj.id }}">
                                    <td>{{ user_obj.get_full_name|default:user_obj.username }}</td>
                                    <td class="user-name-cell">
                                        <span>{{ user_obj.email|default:"-" }}</span>
                                        {% if user_obj.email %}<i class="fa-regular fa-envelope"></i>{% endif %}
                                    </td>
                                    <td>
                                        {{ user_obj.profile.phone_number|default:"-" }}
                                    </td>
                                    <td>
                                        {% if user_obj.profile and user_obj.profile.role %}
                                            {% if user_obj.profile.role == 'teacher' %}
                                                <span class="role-badge role-teacher">{{ user_obj.profile.get_role_display }}</span>
                                            {% elif user_obj.profile.role == 'student' %}
                                                <span class="role-badge role-student">{{ user_obj.profile.get_role_display }}</span>
                                            {% elif user_obj.profile.role == 'headteacher' %}
                                                <span class="role-badge role-headteacher">{{ user_obj.profile.get_role_display }}</span>
                                            {% else %}
                                                <span>{{ user_obj.profile.get_role_display }}</span>
                                            {% endif %}
                                        {% else %}
                                            <span>-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if user_obj.is_active %}
                                            <span class="status-badge status-active">Активен</span>
                                        {% else %}
                                            <span class="status-badge status-blocked">Заблокирован</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ user_obj.last_login|date:"Y-m-d H:i"|default:"Никогда" }}</td>
                                    <td class="action-icons">
                                        <!-- ИЗМЕНЕНИЕ: Оборачиваем все иконки в теги <a> и добавляем классы/атрибуты -->
                                        <a href="#" class="edit-btn" data-user-id="{{ user_obj.id }}" title="Редактировать"><i class="fa-solid fa-pencil"></i></a>
                                        <a href="#" class="block-user-btn" data-user-id="{{ user_obj.id }}" title="{% if user_obj.is_active %}Заблокировать{% else %}Разблокировать{% endif %}">
                                            <i class="fa-solid fa-lock{% if not user_obj.is_active %}-open{% endif %}"></i>
                                        </a>
                                        <a href="#" class="delete-user-btn" data-user-id="{{ user_obj.id }}" title="Удалить"><i class="fa-solid fa-trash-can"></i></a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 24px;">Пользователи не найдены.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- СТРАНИЦА "СТРУКТУРА ШКОЛЫ" -->
            <div id="page-structure" class="page-content">
                <div class="page-header">
                    <h2><i class="fa-solid fa-graduation-cap"></i> Управление структурой школы</h2>
                    <p>Создание и редактирование классов и предметов</p>
                </div>
        
                <div class="content-card">
                    <div class="card-header" id="structure-card-header">
                        <nav class="content-tabs" id="structure-tabs-nav">
                            <!-- ИЗМЕНЕНИЕ: Добавлены data-атрибуты для JS -->
                            <a href="#" data-tab="classes" class="active"><i class="fa-solid fa-people-roof"></i> Классы <span class="count-badge">{{ structure_school_classes.count }}</span></a>
                            <a href="#" data-tab="subjects"><i class="fa-solid fa-book"></i> Предметы <span class="count-badge">{{ subjects.count }}</span></a>
                        </nav>
                        <!-- ИЗМЕНЕНИЕ: Кнопки для создания вынесены в отдельный контейнер для удобства переключения -->
                        <div id="structure-action-buttons">
                            <button class="btn-success" id="create-class-btn" style="display: flex;"><i class="fa-solid fa-plus"></i> Создать класс</button>
                            <button class="btn-info btn-primary" id="create-subject-btn" style="display: none;"><i class="fa-solid fa-plus"></i> Создать предмет</button>
                        </div>
                    </div>
                    
                    <!-- ИЗМЕНЕНИЕ: Контент для вкладок обернут в отдельные div -->
                    <div id="tab-classes" class="content-tab-pane active">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Класс</th>
                                    <th>Количество учеников</th>
                                    <th>Классный руководитель</th>
                                    <th style="text-align: end;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for s_class in structure_school_classes %}
                                <tr data-class-row-id="{{ s_class.id }}">
                                    <td><strong>{{ s_class.name }}</strong></td>
                                    <td class="student-count-cell"><i class="fa-solid fa-user-group"></i> {{ s_class.student_count }}</td>
                                    <td>{{ s_class.class_teacher.user.get_full_name|default:"Не назначен" }}</td>
                                    <td class="action-icons" style="justify-content: end; gap:40px;">
                                        <a href="#" class="edit-class-btn" data-class-id="{{ s_class.id }}"><i class="fa-solid fa-pencil"></i></a>
                                        <a href="#" class="delete-class-btn" data-class-id="{{ s_class.id }}"><i class="fa-solid fa-trash-can"></i></a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="4" style="text-align: center; padding: 24px;">Классы еще не созданы.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <div id="tab-subjects" class="content-tab-pane">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Название предмета</th>
                                    <th style="text-align: end;">Действия</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for subject in subjects %}
                                <tr data-subject-row-id="{{ subject.id }}">
                                    <td><strong>{{ subject.name }}</strong></td>
                                    <td class="action-icons" style="justify-content: end; gap:40px;">
                                        <a href="#" class="edit-subject-btn" data-subject-id="{{ subject.id }}"><i class="fa-solid fa-pencil"></i></a>
                                        <a href="#" class="delete-subject-btn" data-subject-id="{{ subject.id }}"><i class="fa-solid fa-trash-can"></i></a>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr><td colspan="2" style="text-align: center; padding: 24px;">Предметы еще не созданы.</td></tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
            
            <!-- ========================================================== -->
            <!-- === ОБНОВЛЕННАЯ СТРАНИЦА "НАЗНАЧЕНИЯ" === -->
            <!-- ========================================================== -->
            <div id="page-assignments" class="page-content">
                <div class="page-header">
                    <div>
                        <h2><i class="fa-solid fa-user-tag"></i> Назначение учителей</h2>
                        <p>Распределение учителей по классам и предметам</p>
                    </div>
                    <button class="btn-primary" id="create-assignment-btn">
                        <i class="fa-solid fa-plus"></i>
                        Создать назначение
                    </button>
                </div>
                <div class="content-card">
                    <div class="card-header">
                        <nav class="content-tabs">
                            <a href="#" class="active">Все назначения</a>
                        </nav>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Учитель</th>
                                <th>Класс</th>
                                <th>Предмет</th>
                                <th>Часов в неделю</th>
                                <th style="text-align: end;">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in all_assignments %}
                            <tr data-assignment-row-id="{{ assignment.id }}">
                                <td><strong>{{ assignment.teacher.user.get_full_name }}</strong></td>
                                <td><i class="fa-solid fa-user-group"></i> {{ assignment.school_class.name }}</td>
                                <td><i class="fa-solid fa-book"></i> {{ assignment.subject.name }}</td>
                                <td>{{ assignment.hours_per_week|default:"-" }}</td>
                                <td class="action-icons" style="justify-content: end;">
                                    <a href="#" class="delete-assignment-btn" data-assignment-id="{{ assignment.id }}" title="Удалить назначение"><i class="fa-solid fa-trash-can"></i></a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5" style="text-align: center; padding: 24px;">Назначения еще не созданы.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ========================================================== -->
            <!-- === НОВАЯ СТРАНИЦА "НАСТРОЙКИ" === -->
            <!-- ========================================================== -->
            <div id="page-settings" class="page-content">
                <div class="page-header">
                    <div>
                        <h2><i class="fa-solid fa-calendar-days"></i> Управление выходными</h2>
                        <p>Добавьте праздничные или нерабочие дни в календарь</p>
                    </div>
                    <button class="btn-primary" id="create-holiday-btn">
                        <i class="fa-solid fa-plus"></i>
                        Добавить день
                    </button>
                </div>
                <div class="content-card">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Название / Причина</th>
                                <th style="text-align: end;">Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for holiday in all_holidays %}
                            <tr data-holiday-row-id="{{ holiday.id }}">
                                <td><strong>{{ holiday.date|date:"d.m.Y" }}</strong></td>
                                <td>{{ holiday.name }}</td>
                                <td class="action-icons" style="justify-content: end; gap:40px;">
                                    <a href="#" class="edit-holiday-btn" data-holiday-id="{{ holiday.id }}" title="Редактировать"><i class="fa-solid fa-pencil"></i></a>
                                    <a href="#" class="delete-holiday-btn" data-holiday-id="{{ holiday.id }}" title="Удалить"><i class="fa-solid fa-trash-can"></i></a>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" style="text-align: center; padding: 24px;">Выходные дни еще не добавлены.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Другие страницы (заглушки) -->
            <div id="page-home" class="page-content">
                 <div class="content-card"><h2>Главная страница</h2><p>Этот контент находится в разработке.</p></div>
            </div>

        </main>
    </div>

    <!-- ===================================================================== -->
    <!-- === МОДАЛЬНОЕ ОКНО ДЛЯ ПОЛЬЗОВАТЕЛЕЙ === -->
    <!-- ===================================================================== -->
    <div class="modal-overlay" id="user-modal-overlay">
        <div class="modal-container">
            <button class="close-btn" id="close-modal-btn">&times;</button>
            <div class="modal-header">
                <h2 id="modal-title">Создать пользователя</h2>
                <p>Заполните информацию о пользователе</p>
            </div>
            
            <form id="user-form" novalidate>
                {% csrf_token %}
                <input type="hidden" name="user_id" id="id_user_id">
                
                <div class="form-group">
                    <label for="id_full_name">ФИО</label>
                    <input type="text" name="full_name" id="id_full_name" required>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="id_email">Email</label>
                        <input type="email" name="email" id="id_email" required>
                    </div>
                    <div class="form-group">
                        <label for="id_phone_number">Телефон</label>
                        <input type="tel" name="phone_number" id="id_phone_number">
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div class="form-group">
                        <label for="id_role">Роль</label>
                        <select name="role" id="id_role" required>
                            {% for value, display_name in role_choices %}
                                <option value="{{ value }}">{{ display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="id_is_active">Статус</label>
                        <select name="is_active" id="id_is_active" required>
                            <option value="True">Активен</option>
                            <option value="False">Заблокирован</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="class-field-wrapper" style="display: none;">
                    <label for="id_school_class">Класс</label>
                    <select name="school_class" id="id_school_class">
                        <option value="">Выберите класс</option>
                        {% for class in school_classes %}
                            <option value="{{ class.id }}">{{ class.name }} ({{ class.school.name }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group" id="subject-field-wrapper" style="display: none;">
                    <label for="id_subjects">Предметы</label>
                    <select name="subjects" id="id_subjects" multiple>
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancel-btn">Отмена</button>
                    <button type="submit" class="btn-submit" id="submit-btn">Создать</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- ===================================================================== -->
    <!-- === МОДАЛЬНОЕ ОКНО ДЛЯ РЕДАКТИРОВАНИЯ КЛАССА === -->
    <!-- ===================================================================== -->
    <div class="modal-overlay" id="class-modal-overlay">
        <div class="modal-container">
            <button class="close-btn" id="close-class-modal-btn">&times;</button>
            <div class="modal-header">
                <h2 id="class-modal-title">Редактировать класс</h2>
                <p>Заполните информацию о классе</p>
            </div>
            
            <form id="class-form" novalidate>
                {% csrf_token %}
                <input type="hidden" name="class_id" id="id_class_id">
                
                <div class="form-group">
                    <label for="id_school_for_class">Школа</label>
                    <select name="school" id="id_school_for_class" required>
                        <option value="">-- Выберите школу --</option>
                        {% for school in all_schools %}
                            <option value="{{ school.id }}">{{ school.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="id_class_name">Название класса</label>
                    <input type="text" name="name" id="id_class_name" placeholder="Например, 10Б" required>
                </div>

                <div class="form-group">
                    <label for="id_class_teacher">Классный руководитель</label>
                    <select name="class_teacher" id="id_class_teacher">
                        <option value="">Не назначен</option>
                        {% for teacher in all_teachers %}
                            <option value="{{ teacher.user.id }}">{{ teacher.user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Количество учеников</label>
                    <p id="student-count-display" style="font-weight: bold; margin-top: 8px;">-</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancel-class-btn">Отмена</button>
                    <button type="submit" class="btn-submit" id="submit-class-btn">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================================== -->
    <!-- === НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ПРЕДМЕТОВ === -->
    <!-- ========================================================== -->
    <div class="modal-overlay" id="subject-modal-overlay">
        <div class="modal-container">
            <button class="close-btn" id="close-subject-modal-btn">&times;</button>
            <div class="modal-header">
                <h2 id="subject-modal-title">Создать предмет</h2>
                <p>Введите название учебного предмета</p>
            </div>
            <form id="subject-form" novalidate>
                {% csrf_token %}
                <input type="hidden" name="subject_id" id="id_subject_id">
                <div class="form-group">
                    <label for="id_subject_name">Название предмета</label>
                    <input type="text" name="name" id="id_subject_name" placeholder="Например, Алгебра" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancel-subject-btn">Отмена</button>
                    <button type="submit" class="btn-submit" id="submit-subject-btn">Создать</button>
                </div>
            </form>
        </div>
    </div>


    <!-- ========================================================== -->
    <!-- === НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ НАЗНАЧЕНИЙ === -->
    <!-- ========================================================== -->
    <div class="modal-overlay" id="assignment-modal-overlay">
        <div class="modal-container">
            <button class="close-btn" id="close-assignment-modal-btn">&times;</button>
            <div class="modal-header">
                <h2 id="assignment-modal-title">Создать назначение</h2>
                <p>Назначьте учителя на класс и предмет</p>
            </div>
            <form id="assignment-form" novalidate>
                {% csrf_token %}
                <div class="form-group">
                    <label for="id_assignment_teacher">Учитель</label>
                    <select name="teacher" id="id_assignment_teacher" required>
                        <option value="">Выберите учителя</option>
                        {% for teacher in all_teachers %}
                        <script>console.log("{{teacher.id}}")</script>
                        <option value="{{ teacher.id }}">{{ teacher.user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="id_assignment_class">Класс</label>
                    <select name="school_class" id="id_assignment_class" required>
                        <option value="">Выберите класс</option>
                        {% for s_class in school_classes %}
                        <option value="{{ s_class.id }}">{{ s_class.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="id_assignment_subject">Предмет</label>
                    <select name="subject" id="id_assignment_subject" required>
                        <option value="">Выберите предмет</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}">{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="form-group">
                    <label for="id_assignment_hours">Часов в неделю (необязательно)</label>
                    <input type="number" name="hours_per_week" id="id_assignment_hours" min="1" placeholder="Например, 3">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancel-assignment-btn">Отмена</button>
                    <button type="submit" class="btn-submit" id="submit-assignment-btn">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========================================================== -->
    <!-- === НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ВЫХОДНЫХ === -->
    <!-- ========================================================== -->
    <div class="modal-overlay" id="holiday-modal-overlay">
        <div class="modal-container">
            <button class="close-btn" id="close-holiday-modal-btn">&times;</button>
            <div class="modal-header">
                <h2 id="holiday-modal-title">Добавить выходной день</h2>
                <p>Укажите дату и причину</p>
            </div>
            <form id="holiday-form" novalidate>
                {% csrf_token %}
                <input type="hidden" name="holiday_id" id="id_holiday_id">
                <div class="form-group">
                    <label for="id_holiday_date">Дата</label>
                    <input type="date" name="date" id="id_holiday_date" required>
                </div>
                <div class="form-group">
                    <label for="id_holiday_name">Название / Причина</label>
                    <input type="text" name="name" id="id_holiday_name" placeholder="Например, День Учителя" required>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancel-holiday-btn">Отмена</button>
                    <button type="submit" class="btn-submit" id="submit-holiday-btn">Создать</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ===================================================================== -->
    <!-- === JAVASCRIPT === -->
    <!-- ===================================================================== -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const navLinks = document.querySelectorAll('.main-nav a');
        const contentPages = document.querySelectorAll('.page-content');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // --- УПРАВЛЕНИЕ ПОЛЬЗОВАТЕЛЯМИ (без изменений) ---
        const initUserManagementScripts = () => {
            const page = document.getElementById('page-users');
            if (!page) return;

            const modalOverlay = document.getElementById('user-modal-overlay');
            const form = document.getElementById('user-form');
            const modalTitle = document.getElementById('modal-title');
            const submitBtn = document.getElementById('submit-btn');
            const roleSelect = document.getElementById('id_role');
            const classField = document.getElementById('class-field-wrapper');
            const subjectField = document.getElementById('subject-field-wrapper');

            const openModal = () => modalOverlay.style.display = 'flex';
            const closeModal = () => modalOverlay.style.display = 'none';

            const toggleConditionalFields = () => {
                const role = roleSelect.value;
                classField.style.display = (role === 'student') ? 'block' : 'none';
                subjectField.style.display = (role === 'teacher') ? 'block' : 'none';
            };

            document.getElementById('create-user-btn').addEventListener('click', () => {
                form.reset();
                form.querySelector('#id_user_id').value = '';
                modalTitle.textContent = 'Создать пользователя';
                submitBtn.textContent = 'Создать';
                toggleConditionalFields();
                openModal();
            });

            document.getElementById('close-modal-btn').addEventListener('click', closeModal);
            document.getElementById('cancel-btn').addEventListener('click', closeModal);
            roleSelect.addEventListener('change', toggleConditionalFields);

            page.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    const userId = button.dataset.userId;
                    const response = await fetch(`/api/user/${userId}/details/`);
                    if (response.ok) {
                        const data = await response.json();
                        form.querySelector('#id_user_id').value = data.id;
                        form.querySelector('#id_full_name').value = data.full_name;
                        form.querySelector('#id_email').value = data.email;
                        form.querySelector('#id_phone_number').value = data.phone_number || '';
                        form.querySelector('#id_role').value = data.role;
                        form.querySelector('#id_is_active').value = data.is_active ? 'True' : 'False';
                        if (data.school_class_id) form.querySelector('#id_school_class').value = data.school_class_id;
                        const subjectSelect = form.querySelector('#id_subjects');
                        Array.from(subjectSelect.options).forEach(opt => opt.selected = data.subject_ids.includes(parseInt(opt.value)));
                        modalTitle.textContent = 'Редактировать пользователя';
                        submitBtn.textContent = 'Сохранить';
                        toggleConditionalFields();
                        openModal();
                    }
                });
            });

            form.addEventListener('submit', async e => {
                e.preventDefault();
                const formData = new FormData(form);
                const subjectSelect = document.getElementById('id_subjects');
                if (subjectSelect.style.display !== 'none') {
                    formData.delete('subjects');
                    Array.from(subjectSelect.selectedOptions).forEach(opt => formData.append('subjects', opt.value));
                }
                const response = await fetch("{% url 'api_manage_user' %}", { method: 'POST', body: formData, headers: {'X-CSRFToken': csrfToken}});
                if (response.ok) location.reload();
                else alert('Ошибка валидации');
            });

            page.querySelectorAll('.block-user-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    const userId = button.dataset.userId;
                    const response = await fetch(`/api/user/${userId}/toggle-status/`, { method: 'POST', headers: {'X-CSRFToken': csrfToken }});
                    if (response.ok) {
                        const result = await response.json();
                        const row = document.querySelector(`tr[data-user-row-id="${userId}"]`);
                        const statusBadge = row.querySelector('.status-badge');
                        const lockIcon = button.querySelector('i');
                        if (result.is_active) {
                            statusBadge.textContent = 'Активен';
                            statusBadge.className = 'status-badge status-active';
                            lockIcon.className = 'fa-solid fa-lock';
                            button.title = 'Заблокировать';
                        } else {
                            statusBadge.textContent = 'Заблокирован';
                            statusBadge.className = 'status-badge status-blocked';
                            lockIcon.className = 'fa-solid fa-lock-open';
                            button.title = 'Разблокировать';
                        }
                    }
                });
            });

            page.querySelectorAll('.delete-user-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    if (confirm('Вы уверены, что хотите удалить этого пользователя?')) {
                        const userId = button.dataset.userId;
                        const response = await fetch(`/api/user/${userId}/delete/`, { method: 'POST', headers: {'X-CSRFToken': csrfToken }});
                        if (response.ok) button.closest('tr').remove();
                        else alert('Не удалось удалить пользователя.');
                    }
                });
            });
        };
        
        // --- ОБНОВЛЕННАЯ ФУНКЦИЯ ДЛЯ СТРУКТУРЫ ШКОЛЫ ---
        const initSchoolStructureScripts = () => {
            const page = document.getElementById('page-structure');
            if (!page) return;
        
            // --- Переменные для управления классами ---
            const classModalOverlay = document.getElementById('class-modal-overlay');
            const classForm = document.getElementById('class-form');
            const classModalTitle = document.getElementById('class-modal-title');
            const classSubmitBtn = document.getElementById('submit-class-btn');
            const studentCount = document.getElementById('student-count-display');
            const createClassBtn = document.getElementById('create-class-btn');
        
            // --- НОВЫЕ переменные для управления предметами ---
            const subjectModalOverlay = document.getElementById('subject-modal-overlay');
            const subjectForm = document.getElementById('subject-form');
            const subjectModalTitle = document.getElementById('subject-modal-title');
            const subjectSubmitBtn = document.getElementById('submit-subject-btn');
            const createSubjectBtn = document.getElementById('create-subject-btn');
        
            // --- Переменные для навигации по вкладкам ---
            const tabsNav = document.getElementById('structure-tabs-nav');
            const actionButtons = document.getElementById('structure-action-buttons');
            const tabPanes = page.querySelectorAll('.content-tab-pane');
        
            // --- Функции для модальных окон ---
            const openClassModal = () => classModalOverlay.style.display = 'flex';
            const closeClassModal = () => classModalOverlay.style.display = 'none';
            const openSubjectModal = () => subjectModalOverlay.style.display = 'flex';
            const closeSubjectModal = () => subjectModalOverlay.style.display = 'none';
        
            // --- ЛОГИКА ПЕРЕКЛЮЧЕНИЯ ВКЛАДОК ---
            tabsNav.querySelectorAll('a').forEach(tabLink => {
                tabLink.addEventListener('click', e => {
                    e.preventDefault();
                    const targetTab = tabLink.dataset.tab;
        
                    tabsNav.querySelectorAll('a').forEach(link => link.classList.remove('active'));
                    tabLink.classList.add('active');
        
                    tabPanes.forEach(pane => pane.classList.toggle('active', pane.id === `tab-${targetTab}`));
        
                    // --- ИЗМЕНЕНИЕ ---
                    // Кнопка "Создать класс" теперь всегда видна и не затрагивается.
                    // Управляем видимостью только кнопки "Создать предмет".
                    const createClassBtn = document.getElementById('create-class-btn');
                    const createSubjectBtn = document.getElementById('create-subject-btn');
                    createSubjectBtn.style.display = (targetTab === 'subjects') ? 'inline-flex' : 'none';

                    if (createSubjectBtn.style.display === 'inline-flex') {
                        createClassBtn.style.display = 'none';
                    } else {
                        createClassBtn.style.display = 'inline-flex';
                    }
                });
            });
        
            // --- ЛОГИКА ДЛЯ КЛАССОВ ---
            createClassBtn.addEventListener('click', () => {
                classForm.reset();
                classForm.querySelector('#id_class_id').value = '';
                classModalTitle.textContent = 'Создать новый класс';
                classSubmitBtn.textContent = 'Создать';
                studentCount.textContent = '0';
                openClassModal();
            });
        
            document.getElementById('close-class-modal-btn').addEventListener('click', closeClassModal);
            document.getElementById('cancel-class-btn').addEventListener('click', closeClassModal);
        
            page.querySelectorAll('.edit-class-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    const classId = button.dataset.classId;
                    const response = await fetch(`/api/class/${classId}/details/`);
                    if (response.ok) {
                        const data = await response.json();
                        classForm.querySelector('#id_class_id').value = data.id;
                        classForm.querySelector('#id_class_name').value = data.name;
                        classForm.querySelector('#id_school_for_class').value = data.school_id;
                        classForm.querySelector('#id_class_teacher').value = data.class_teacher_id || '';
                        studentCount.textContent = data.student_count;
                        classModalTitle.textContent = 'Редактировать класс';
                        classSubmitBtn.textContent = 'Сохранить';
                        openClassModal();
                    } else {
                        alert("Не удалось загрузить данные класса.");
                    }
                });
            });
        
            classForm.addEventListener('submit', async e => {
                e.preventDefault();
                const response = await fetch("{% url 'manage_class_api' %}", {
                    method: 'POST', body: new FormData(classForm), headers: {'X-CSRFToken': csrfToken}
                });
                if (response.ok) location.reload();
                else alert('Ошибка валидации формы класса.');
            });
        
            page.querySelectorAll('.delete-class-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    if (confirm('Вы уверены, что хотите удалить этот класс?')) {
                        const classId = button.dataset.classId;
                        const response = await fetch(`/api/class/${classId}/delete/`, { method: 'POST', headers: {'X-CSRFToken': csrfToken}});
                        if (response.ok) {
                             button.closest('tr').remove();
                             // Можно добавить обновление счетчика, но проще перезагрузить
                             location.reload(); 
                        } else {
                             alert('Не удалось удалить класс.');
                        }
                    }
                });
            });
        
            // === НОВАЯ ЛОГИКА ДЛЯ ПРЕДМЕТОВ ===
            createSubjectBtn.addEventListener('click', () => {
                subjectForm.reset();
                subjectForm.querySelector('#id_subject_id').value = '';
                subjectModalTitle.textContent = 'Создать предмет';
                subjectSubmitBtn.textContent = 'Создать';
                openSubjectModal();
            });
        
            document.getElementById('close-subject-modal-btn').addEventListener('click', closeSubjectModal);
            document.getElementById('cancel-subject-btn').addEventListener('click', closeSubjectModal);
        
            subjectForm.addEventListener('submit', async e => {
                e.preventDefault();
                const response = await fetch("{% url 'api_manage_subject' %}", {
                    method: 'POST', body: new FormData(subjectForm), headers: {'X-CSRFToken': csrfToken}
                });
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Ошибка валидации. Проверьте, что название предмета уникально.');
                }
            });
        
            page.querySelectorAll('.edit-subject-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    const subjectId = button.dataset.subjectId;
                    const response = await fetch(`/api/subject/${subjectId}/details/`);
                    if (response.ok) {
                        const data = await response.json();
                        subjectForm.querySelector('#id_subject_id').value = data.id;
                        subjectForm.querySelector('#id_subject_name').value = data.name;
                        subjectModalTitle.textContent = 'Редактировать предмет';
                        subjectSubmitBtn.textContent = 'Сохранить';
                        openSubjectModal();
                    } else {
                        alert('Не удалось загрузить данные предмета.');
                    }
                });
            });
        
            page.querySelectorAll('.delete-subject-btn').forEach(button => {
                button.addEventListener('click', async e => {
                    e.preventDefault();
                    if (confirm('Вы уверены, что хотите удалить этот предмет?')) {
                        const subjectId = button.dataset.subjectId;
                        const response = await fetch(`/api/subject/${subjectId}/delete/`, {
                            method: 'POST', headers: {'X-CSRFToken': csrfToken}
                        });
                        if (response.ok) {
                            button.closest('tr').remove();
                            // Можно добавить обновление счетчика, но проще перезагрузить
                            location.reload();
                        } else {
                            alert('Не удалось удалить предмет. Возможно, он используется в расписании или назначениях.');
                        }
                    }
                });
            });
        };

        // --- ФУНКЦИЯ ДЛЯ УПРАВЛЕНИЯ НАЗНАЧЕНИЯМИ (без изменений) ---
        const initAssignmentsScripts = () => {
            const page = document.getElementById('page-assignments');
            if (!page) return;

            const modalOverlay = document.getElementById('assignment-modal-overlay');
            const form = document.getElementById('assignment-form');
            const createBtn = document.getElementById('create-assignment-btn');
            const closeModalBtn = document.getElementById('close-assignment-modal-btn');
            const cancelBtn = document.getElementById('cancel-assignment-btn');
            const deleteButtons = page.querySelectorAll('.delete-assignment-btn');

            const openModal = () => { modalOverlay.style.display = 'flex'; };
            const closeModal = () => { modalOverlay.style.display = 'none'; };

            createBtn.addEventListener('click', () => {
                form.reset();
                openModal();
            });
            closeModalBtn.addEventListener('click', closeModal);
            cancelBtn.addEventListener('click', closeModal);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const response = await fetch("{% url 'manage_assignment_api' %}", {
                    method: 'POST',
                    body: formData,
                    headers: {'X-CSRFToken': csrfToken}
                });
                if (response.ok) {
                    location.reload();
                } else {
                    const result = await response.json();
                    alert(`Ошибка: ${result.message || JSON.stringify(result)}`);
                }
            });

            deleteButtons.forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (confirm('Вы уверены, что хотите удалить это назначение?')) {
                        const assignmentId = button.dataset.assignmentId;
                        const response = await fetch(`/api/assignment/${assignmentId}/delete/`, {
                            method: 'POST',
                            headers: {'X-CSRFToken': csrfToken}
                        });
                        if (response.ok) {
                            button.closest('tr').remove();
                        } else {
                            alert('Не удалось удалить назначение.');
                        }
                    }
                });
            });
        };

        // === НОВАЯ ФУНКЦИЯ ДЛЯ УПРАВЛЕНИЯ ВЫХОДНЫМИ ===
        const initHolidayManagementScripts = () => {
            const page = document.getElementById('page-settings');
            if (!page) return;

            const modalOverlay = document.getElementById('holiday-modal-overlay');
            const form = document.getElementById('holiday-form');
            const modalTitle = document.getElementById('holiday-modal-title');
            const submitBtn = document.getElementById('submit-holiday-btn');

            const openModal = () => modalOverlay.style.display = 'flex';
            const closeModal = () => modalOverlay.style.display = 'none';

            document.getElementById('create-holiday-btn').addEventListener('click', () => {
                form.reset();
                form.querySelector('#id_holiday_id').value = '';
                modalTitle.textContent = 'Добавить выходной день';
                submitBtn.textContent = 'Создать';
                openModal();
            });

            document.getElementById('close-holiday-modal-btn').addEventListener('click', closeModal);
            document.getElementById('cancel-holiday-btn').addEventListener('click', closeModal);

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const response = await fetch("{% url 'api_manage_holiday' %}", {
                    method: 'POST', body: new FormData(form), headers: {'X-CSRFToken': csrfToken}
                });
                if (response.ok) {
                    location.reload();
                } else {
                    alert('Ошибка валидации. Проверьте, что все поля заполнены.');
                }
            });

            page.querySelectorAll('.edit-holiday-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const holidayId = button.dataset.holidayId;
                    const response = await fetch(`/api/holiday/${holidayId}/details/`);
                    if (response.ok) {
                        const data = await response.json();
                        form.querySelector('#id_holiday_id').value = data.id;
                        form.querySelector('#id_holiday_date').value = data.date;
                        form.querySelector('#id_holiday_name').value = data.name;
                        modalTitle.textContent = 'Редактировать выходной день';
                        submitBtn.textContent = 'Сохранить';
                        openModal();
                    }
                });
            });

            page.querySelectorAll('.delete-holiday-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (confirm('Вы уверены, что хотите удалить этот день?')) {
                        const holidayId = button.dataset.holidayId;
                        const response = await fetch(`/api/holiday/${holidayId}/delete/`, {
                            method: 'POST', headers: {'X-CSRFToken': csrfToken}
                        });
                        if (response.ok) {
                            button.closest('tr').remove();
                        } else {
                            alert('Не удалось удалить запись.');
                        }
                    }
                });
            });
        };

        // --- ОБЩАЯ НАВИГАЦИЯ И ИНИЦИАЛИЗАЦИЯ ---
        const navigateTo = (pageId) => {
            contentPages.forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) targetPage.classList.add('active');
            navLinks.forEach(link => link.classList.toggle('active', link.dataset.target === pageId));
        };

        navLinks.forEach(link => {
            link.addEventListener('click', e => {
                e.preventDefault();
                const pageId = e.currentTarget.dataset.target;
                navigateTo(pageId);
                // Сохраняем активную вкладку в URL для перезагрузки страницы
                window.history.pushState({page: pageId}, '', `?page=${pageId}`);
            });
        });

        // --- Определение активной страницы при загрузке ---
        const urlParams = new URLSearchParams(window.location.search);
        const pageFromUrl = urlParams.get('page') || 'users'; // по умолчанию 'users'
        navigateTo(pageFromUrl);
        
        // --- ВЫЗЫВАЕМ ВСЕ ФУНКЦИИ ИНИЦИАЛИЗАЦИИ ---
        initUserManagementScripts();
        initSchoolStructureScripts();
        initAssignmentsScripts();
        initHolidayManagementScripts(); // <-- ВЫЗОВ НОВОЙ ФУНКЦИИ
    });
    </script>
</body>
</html>