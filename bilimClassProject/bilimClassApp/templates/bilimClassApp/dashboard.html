<!-- bilimClassApp/templates/bilimClassApp/dashboard.html (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø) -->
{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–∞—à–±–æ—Ä–¥ - Bilim Class</title>
    <!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–±—Ä–∞–Ω –ª–∏—à–Ω–∏–π style.css, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–∑—ã–≤–∞–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/base.css' %}">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/student_dashboard.css' %}">
    <style>
        .td-user-section { display: flex; align-items: center; gap: 16px; }
        .td-user-info { text-align: right; } .td-user-info h3 { font-weight: 600; }
        .td-user-info p { font-size: 14px; color: var(--text-secondary); }
        .td-user-link { text-decoration: none; color: inherit; }
        .td-user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #D8B4FE; color: #581C87; display: grid; place-items: center; font-weight: 600; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: –ö–ª–∞—Å—Å—ã –≤ —à–∞–ø–∫–µ —Ç–µ–ø–µ—Ä—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç base.css -->
        <header class="site-header">
            <div class="logo-section">
                <div class="logo-icon">üéì</div>
                <div>
                    <h1>Bilim Class</h1>
                    <span>{{ user_role }}</span>
                </div>
            </div>
           <div class="td-user-section">
                <div class="td-user-info">
                    <a href="{% url 'profile' %}" class="td-user-link">
                        <h3>{{ user.get_full_name }}</h3>
                    </a>
                    <p>–£—á–µ–Ω–∏–∫</p>
                </div>
                <a href="{% url 'profile' %}" class="td-user-link">
                    <div class="td-user-avatar">{{ user.first_name|first }}{{ user.last_name|first }}</div>
                </a>
            </div>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <main class="dashboard-main">
            <div class="welcome-section">
                <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {{ request.user.first_name }}!</h1>
                <p>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç {{ user_role|lower }}–∞</p>
            </div>

            <!-- –¢–∞–±—ã –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
            <nav class="main-tabs">
                <ul>
                    <li data-tab="schedule" class="{% if active_tab == 'schedule' or not active_tab %}active{% endif %}"><a href="#">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a></li>
                    <li data-tab="dnevnik" class="{% if active_tab == 'dnevnik' %}active{% endif %}"><a href="#">–î–Ω–µ–≤–Ω–∏–∫</a></li>
                    <li data-tab="homework" class="{% if active_tab == 'homework' %}active{% endif %}"><a href="#">–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a></li>
                    <li data-tab="profile" class="{% if active_tab == 'profile' %}active{% endif %}"><a href="#">–ü—Ä–æ—Ñ–∏–ª—å</a></li>
                </ul>
            </nav>

            <!-- –í–ö–õ–ê–î–ö–ê: –†–ê–°–ü–ò–°–ê–ù–ò–ï -->
            <div id="tab-content-schedule" class="tab-pane {% if active_tab == 'schedule' or not active_tab %}active{% endif %}">
                 <section class="schedule-section">
                    <h3>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Ä–æ–∫–æ–≤</h3>
                    <p>–í–∞—à–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é</p>
                    <nav class="day-tabs">
                        <ul><li data-day="1" class="active">–ü–ù</li><li data-day="2">–í–¢</li><li data-day="3">–°–†</li><li data-day="4">–ß–¢</li><li data-day="5">–ü–¢</li><li data-day="6">–°–ë</li></ul>
                    </nav>
                    <div class="schedule-content">
                        {% for day, lessons in schedule_by_day.items %}
                            <div id="day-{{ day }}" class="day-schedule {% if forloop.first %}active{% endif %}">
                                {% for lesson in lessons %}
                                    <div class="lesson-card">
                                        <div class="lesson-info">
                                            <div class="lesson-number">{{ forloop.counter }}</div>
                                            <div>
                                                <p class="lesson-title">{{ lesson.subject.name }}</p>
                                                <div class="lesson-details">
                                                    <span><i class="far fa-clock"></i> {{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</span>
                                                    <span><i class="fas fa-map-marker-alt"></i> –ö–∞–±–∏–Ω–µ—Ç {{ lesson.classroom }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="lesson-start-time">{{ lesson.start_time|time:"H:i" }}</div>
                                    </div>
                                {% empty %}
                                    <p class="no-lessons">–í —ç—Ç–æ—Ç –¥–µ–Ω—å —É—Ä–æ–∫–æ–≤ –Ω–µ—Ç.</p>
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </section>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê: –î–ù–ï–í–ù–ò–ö -->
            <div id="tab-content-dnevnik" class="tab-pane {% if active_tab == 'dnevnik' %}active{% endif %}">
                <div class="stats-cards-grid-v2">
                    <div class="stat-card-v2">
                        <div class="stat-icon-v2 icon-green"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-info-v2"><p>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</p><span>{{ average_grade|floatformat:2 }}</span></div><small>–æ–±—â–∏–π</small>
                    </div>
                    <div class="stat-card-v2">
                        <div class="stat-icon-v2 icon-blue"><i class="fas fa-book-open"></i></div>
                        <div class="stat-info-v2"><p>–í—Å–µ–≥–æ –æ—Ü–µ–Ω–æ–∫</p><span>{{ total_grades_count }}</span></div><small>–∑–∞ –ø–µ—Ä–∏–æ–¥</small>
                    </div>
                    <div class="stat-card-v2">
                        <div class="stat-icon-v2 icon-red"><i class="fas fa-user-clock"></i></div>
                        <div class="stat-info-v2"><p>–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</p><span>{{ attendance_percentage|floatformat:1 }}%</span></div><small>{{ total_absences }} –ø—Ä–æ–ø—É—Å–∫–æ–≤</small>
                    </div>
                </div>

                <!-- <div class="grades-by-subject-widget-v2">
                    <div class="widget-header"><h2>–û—Ü–µ–Ω–∫–∏ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h2><p>–í–∞—à–∞ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥</p></div> -->
                <div class="grades-by-subject-widget-v2">
                    <div class="widget-header">
                        <h2>–û—Ü–µ–Ω–∫–∏ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</h2>
                        <p>–í–∞—à–∞ —É—Å–ø–µ–≤–∞–µ–º–æ—Å—Ç—å –∑–∞ —Ç–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥</p>
                    </div>

                    <!-- ===== –ù–ê–ß–ê–õ–û –ù–û–í–û–ì–û –ë–õ–û–ö–ê –° –§–ò–õ–¨–¢–†–ê–ú–ò ===== -->
                    <div class="dnevnik-filters">
                        <a href="?tab=dnevnik&period=week" class="{% if active_period == 'week' %}active{% endif %}">–ó–∞ –Ω–µ–¥–µ–ª—é</a>
                        <a href="?tab=dnevnik&period=month" class="{% if active_period == 'month' %}active{% endif %}">–ó–∞ –º–µ—Å—è—Ü</a>
                        <a href="?tab=dnevnik&period=all" class="{% if active_period == 'all' %}active{% endif %}">–ó–∞ –≤—Å—ë –≤—Ä–µ–º—è</a>
                    </div>
                    <!-- –∂–∂ -->
                    <table class="grades-table-v2">
                        <thead><tr><th>–ü—Ä–µ–¥–º–µ—Ç</th><th>–û—Ü–µ–Ω–∫–∏</th><th style="text-align: right;">–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th></tr></thead>
                        <tbody>
                            {% for subject_data in grades_by_subject %}
                            <tr>
                                <td>
                                    <p class="subject-name">{{ subject_data.subject_name }}</p>
                                    <span class="teacher-name">{{ subject_data.teacher_name }}</span>
                                </td>
                                <td class="grades-list">
                                    {% for grade in subject_data.grades %}
                                        <!-- –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω—ã data-comment –∏ data-date, —É–±—Ä–∞–Ω title -->
                                        <div class="grade-badge-wrapper" 
                                             data-comment="{{ grade.comment|default:'' }}" 
                                             data-date="{{ grade.date|date:'d.m.Y' }}">
                                            <div class="grade-badge {% if grade.grade >= 85 %}grade-5{% elif grade.grade >= 65 %}grade-4{% else %}grade-3{% endif %}">{{ grade.grade }}</div>
                                            {% if grade.comment %}<span class="grade-comment-icon">üí¨</span>{% endif %}
                                        </div>
                                    {% empty %}
                                        <span class="no-grades">-</span>
                                    {% endfor %}
                                </td>
                                <td style="text-align: right;">
                                    <span class="average-grade">{{ subject_data.average|floatformat:2|default:"-" }}</span>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" style="text-align: center; padding: 30px; color: var(--text-secondary);">–û—Ü–µ–Ω–æ–∫ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –ø–æ–∫–∞ –Ω–µ—Ç.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê: –î–û–ú–ê–®–ù–ò–ï –ó–ê–î–ê–ù–ò–Ø -->
            <div id="tab-content-homework" class="tab-pane {% if active_tab == 'homework' %}active{% endif %}">
                <div class="homework-widget">
                    <div class="widget-header"><h2>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2><p>–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</p></div>
                    <div class="stats-grid">
                        <div class="stat-card stat-card-pending"><div class="stat-icon">üïí</div><div><div class="stat-value">{{ not_submitted_list.count }}</div><p class="stat-label">–ù–µ —Å–¥–∞–Ω–æ</p></div></div>
                        <div class="stat-card stat-card-review"><div class="stat-icon">üìÑ</div><div><div class="stat-value">{{ in_review_list.count }}</div><p class="stat-label">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</p></div></div>
                        <div class="stat-card stat-card-checked"><div class="stat-icon">‚úì</div><div><div class="stat-value">{{ checked_list.count }}</div><p class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</p></div></div>
                    </div>
                    <div class="homework-tabs">
                        <button class="tab-btn active" data-tab="not_submitted">–ù–µ —Å–¥–∞–Ω–æ ({{ not_submitted_list.count }})</button>
                        <button class="tab-btn" data-tab="in_review">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ ({{ in_review_list.count }})</button>
                        <button class="tab-btn" data-tab="checked">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ ({{ checked_list.count }})</button>
                    </div>
                    <div class="homework-list" id="homework-list-container">
                        <div id="tab-content-not_submitted" class="tab-pane active">
                            {% for hw in not_submitted_list %}
                            <div class="homework-card">
                                <div class="hw-card-header"><h3>{{ hw.title }}</h3><span class="hw-status-tag tag-pending">–ù–µ —Å–¥–∞–Ω–æ</span></div>
                                <p class="hw-meta">{{ hw.subject.name }} ‚Ä¢ {{ hw.teacher.user.get_full_name }}</p>
                                <p class="hw-description">{{ hw.description }}</p>
                                {% if hw.attached_file %}
                                    <a href="{{ hw.attached_file.url }}" class="hw-attachment" target="_blank">
                                        <i class="fas fa-paperclip"></i>
                                        <span>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª</span>
                                    </a>
                                {% endif %}
                                <div class="hw-footer">
                                    <div class="hw-deadline"><i class="far fa-clock"></i> –°—Ä–æ–∫ —Å–¥–∞—á–∏: {{ hw.due_date|date:"d.m.Y H:i" }}</div>
                                    <button class="btn-submit open-submission-modal" data-hw-pk="{{ hw.pk }}" data-hw-title="{{ hw.title }}" data-hw-subject="{{ hw.subject.name }}" data-hw-description="{{ hw.description }}">–°–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
                                </div>
                            </div>
                            {% empty %} <p style="text-align:center; padding: 20px; color: var(--text-secondary);">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Å–¥–∞—Ç—å.</p> {% endfor %}
                        </div>
                        <div id="tab-content-in_review" class="tab-pane">
                            {% for submission in in_review_list %}
                            <div class="homework-card">
                                <div class="hw-card-header"><h3>{{ submission.homework.title }}</h3><span class="hw-status-tag tag-review">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span></div>
                                <p class="hw-meta">{{ submission.homework.subject.name }} ‚Ä¢ {{ submission.homework.teacher.user.get_full_name }}</p>
                                <div class="hw-footer">
                                    <div class="hw-deadline"><i class="far fa-calendar-check"></i> –°–¥–∞–Ω–æ: {{ submission.submitted_at|date:"d.m.Y" }}</div>
                                    <button class="btn-submit btn-submitted" disabled>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
                                </div>
                            </div>
                            {% empty %} <p style="text-align:center; padding: 20px; color: var(--text-secondary);">–ù–µ—Ç —Ä–∞–±–æ—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ.</p> {% endfor %}
                        </div>
                        <div id="tab-content-checked" class="tab-pane">
                            {% for submission in checked_list %}
                            <div class="homework-card">
                                 <div class="hw-card-header"><h3>{{ submission.homework.title }}</h3><span class="hw-status-tag tag-checked">–û—Ü–µ–Ω–∫–∞: {{ submission.grade }}</span></div>
                                <p class="hw-meta">{{ submission.homework.subject.name }} ‚Ä¢ {{ submission.homework.teacher.user.get_full_name }}</p>
                                <p class="hw-description"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è:</strong> {{ submission.teacher_comment|default:"-" }}</p>
                                <div class="hw-footer">
                                    <div class="hw-deadline"><i class="far fa-calendar-check"></i> –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: {{ submission.checked_at|date:"d.m.Y" }}</div>
                                    <button class="btn-submit btn-checked" disabled>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</button>
                                </div>
                            </div>
                            {% empty %} <p style="text-align:center; padding: 20px; color: var(--text-secondary);">–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç.</p> {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- –í–ö–õ–ê–î–ö–ê: –ü–†–û–§–ò–õ–¨ -->
            <div id="tab-content-profile" class="tab-pane {% if active_tab == 'profile' %}active{% endif %}">
                <p>–†–∞–∑–¥–µ–ª "–ü—Ä–æ—Ñ–∏–ª—å" –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ.</p>
            </div>
        </main>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–¥–∞—á–∏ –î–ó -->
    <div class="modal-overlay" id="submission-modal">
        <div class="modal-container">
            <button class="close-btn" id="close-submission-modal">&times;</button>
            <div class="modal-header">
                <h2 id="modal-hw-title">–°–¥–∞—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
                <p id="modal-hw-subject">–ü—Ä–µ–¥–º–µ—Ç ‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</p>
            </div>
            <form id="submission-form" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="task-description" id="modal-hw-description"></div>
                <div class="form-group">
                    <label for="submission_file_input">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã</label>
                    <div class="file-drop-area" id="file-drop-area">
                        <i class="fas fa-upload"></i>
                        <p id="file-drop-text">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</p>
                        <span id="file-drop-hint">PDF, DOC, DOCX, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å. 10 –ú–ë)</span>
                        <input type="file" id="submission_file_input" name="submission_file" style="display: none;" multiple>
                    </div>
                </div>
                <div class="form-group">
                    <label for="submission_text">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                    <textarea id="submission_text" name="submission_text" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–∞–±–æ—Ç–µ..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" id="cancel-submission-btn">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ—Ç–∞–ª–µ–π –æ—Ü–µ–Ω–∫–∏ -->
    <div class="modal-overlay" id="grade-details-modal-overlay">
        <div class="grade-modal-container">
            <div class="grade-modal-header">
                <h2>–î–µ—Ç–∞–ª–∏ –æ—Ü–µ–Ω–∫–∏</h2>
                <button class="close-btn" id="close-grade-modal">&times;</button>
            </div>
            <div class="grade-modal-body">
                <div class="grade-modal-info-item"><span>–î–∞—Ç–∞</span><p id="modal-grade-date">--.--.----</p></div>
                <div class="grade-modal-info-item"><span>–û—Ü–µ–Ω–∫–∞</span><p id="modal-grade-value">--</p></div>
                <div class="grade-modal-comment-item"><span>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è</span><p id="modal-grade-comment">–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è...</p></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –¢–ê–ë–û–í ---
    function setupTabs(tabButtonsSelector, tabPanesSelector, activeClass = 'active') {
        const tabs = document.querySelectorAll(tabButtonsSelector);
        const panes = document.querySelectorAll(tabPanesSelector);
        if (tabs.length === 0 || panes.length === 0) return;
        tabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                const tabId = this.dataset.tab || this.dataset.day;
                tabs.forEach(t => t.classList.remove(activeClass));
                this.classList.add(activeClass);
                panes.forEach(p => {
                    const paneId = p.id.split('-').pop();
                    const dayId = p.id.replace('day-', '');
                    p.classList.toggle(activeClass, paneId === tabId || dayId === tabId);
                });
            });
        });
    }
    setupTabs('.main-tabs li', '.dashboard-main > .tab-pane');
    setupTabs('.day-tabs li', '.schedule-content .day-schedule');
    setupTabs('.homework-tabs .tab-btn', '#tab-content-homework .tab-pane');

    // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –°–î–ê–ß–ò –î–ó ---
    const submissionModal = document.getElementById('submission-modal');
    const dashboardMain = document.querySelector('.dashboard-main');
    if (submissionModal && dashboardMain) {
        const submissionForm = document.getElementById('submission-form');
        const fileInput = document.getElementById('submission_file_input');
        const fileDropArea = document.getElementById('file-drop-area');
        const fileDropText = document.getElementById('file-drop-text');

        dashboardMain.addEventListener('click', function(e) {
            const openBtn = e.target.closest('.open-submission-modal');
            if (openBtn) {
                const { hwPk, hwTitle, hwSubject, hwDescription } = openBtn.dataset;
                submissionModal.querySelector('#modal-hw-title').textContent = hwTitle;
                submissionModal.querySelector('#modal-hw-subject').textContent = hwSubject;
                submissionModal.querySelector('#modal-hw-description').innerHTML = `<p><strong>–ó–∞–¥–∞–Ω–∏–µ:</strong> ${hwDescription}</p>`;
                submissionForm.action = `/api/homework/${hwPk}/submit/`;
                submissionModal.classList.add('visible');
            }
        });

        const closeSubmissionModal = () => {
            submissionModal.classList.remove('visible');
            submissionForm.reset();
            fileDropText.textContent = '–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞';
            fileInput.value = '';
        };
        submissionModal.querySelector('#close-submission-modal').addEventListener('click', closeSubmissionModal);
        submissionModal.querySelector('#cancel-submission-btn').addEventListener('click', closeSubmissionModal);
        submissionModal.addEventListener('click', (e) => { if (e.target === submissionModal) closeSubmissionModal(); });

        submissionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const submitButton = this.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });
                const result = await response.json();
                if (response.ok) {
                    alert(result.message || '–†–∞–±–æ—Ç–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
                    window.location.reload();
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É.'}`);
                }
            } catch(error) {
                console.error("Fetch Error:", error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É';
            }
        });

        fileDropArea.addEventListener('click', () => fileInput.click());
        const handleFiles = (files) => {
            if (files.length > 0) {
                 fileDropText.textContent = files.length > 1 ? `–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${files.length}` : files[0].name;
            } else {
                fileDropText.textContent = '–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞';
            }
        };
        fileInput.addEventListener('change', () => handleFiles(fileInput.files));
        fileDropArea.addEventListener('dragover', (e) => { e.preventDefault(); fileDropArea.style.backgroundColor = '#EEF2FF'; });
        fileDropArea.addEventListener('dragleave', () => { fileDropArea.style.backgroundColor = 'transparent'; });
        fileDropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileDropArea.style.backgroundColor = 'transparent';
            fileInput.files = e.dataTransfer.files;
            handleFiles(fileInput.files);
        });
    }

    // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê –° –î–ï–¢–ê–õ–Ø–ú–ò –û–¶–ï–ù–ö–ò ---
    const gradeModalOverlay = document.getElementById('grade-details-modal-overlay');
    const closeGradeModalBtn = document.getElementById('close-grade-modal');
    const modalGradeDate = document.getElementById('modal-grade-date');
    const modalGradeValue = document.getElementById('modal-grade-value');
    const modalGradeComment = document.getElementById('modal-grade-comment');

    const closeGradeModal = () => {
        gradeModalOverlay.classList.remove('visible');
    };

    if (dashboardMain && gradeModalOverlay) {
        dashboardMain.addEventListener('click', (event) => {
            const wrapper = event.target.closest('.grade-badge-wrapper');

            // –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –£—Å–ª–æ–≤–∏–µ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—â–µ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –¥–ª—è –õ–Æ–ë–û–ô –æ—Ü–µ–Ω–∫–∏.
            if (wrapper) {
                const date = wrapper.dataset.date;
                const gradeValue = wrapper.querySelector('.grade-badge').textContent.trim();
                const comment = wrapper.dataset.comment.trim();

                // 1. –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–∞–Ω–Ω—ã–º–∏
                modalGradeDate.textContent = date;
                modalGradeValue.textContent = gradeValue;
                
                // –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø—É—Å—Ç–æ–π, –≤—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç-–∑–∞–≥–ª—É—à–∫—É.
                if (comment) {
                    modalGradeComment.textContent = comment;
                } else {
                    modalGradeComment.textContent = "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ—Ç —É—á–∏—Ç–µ–ª—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.";
                }
                
                // 2. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                gradeModalOverlay.classList.add('visible');
            }
        });

        // –ù–∞–≤–µ—à–∏–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ (–∫–æ–¥ –æ—Å—Ç–∞–ª—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
        closeGradeModalBtn.addEventListener('click', closeGradeModal);
        gradeModalOverlay.addEventListener('click', (event) => {
            if (event.target === gradeModalOverlay) {
                closeGradeModal();
            }
        });
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && gradeModalOverlay.classList.contains('visible')) {
                closeGradeModal();
            }
        });
    }

    // --- –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF-—Ç–æ–∫–µ–Ω–∞ ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è –Ω–µ–Ω—É–∂–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è setupGradeTooltips
});
</script>

</body>
</html>