{% extends "bilimClassApp/base_dashboard.html" %}
{% load static %}
{% load custom_filters %} {# Загрузка кастомного фильтра #}

{% block title %}Расписание школы{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/schedule_head_school.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        .page-header { margin-bottom: 24px; }
        .page-title h2 { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .page-title p { color: var(--text-secondary); margin-top: 4px; }
        .content-card { background-color: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,.05), 0 2px 4px -2px rgba(0,0,0,.05); }
        .filters-toolbar { display: flex; gap: 16px; margin-bottom: 24px; }
        .filter-select { padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-main); }
        
        /* Скрываем контент вкладок по умолчанию */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Стили для УСПЕВАЕМОСТИ */
        :root {
            --accent-purple-light: #F5F3FF; --accent-purple-dark: #5B21B6; --accent-green-light: #F0FDF4;
            --accent-green-dark: #166534; --accent-blue-light: #EFF6FF; --accent-blue-dark: #1E40AF;
            --accent-yellow-light: #FEFCE8; --accent-yellow-dark: #854D0E; --accent-red-light: #FEF2F2; --accent-red-dark: #991B1B;
        }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .summary-card { padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .summary-card .value { font-size: 28px; font-weight: 700; }
        .summary-card .label { color: var(--text-secondary); }
        .summary-card .icon { font-size: 24px; }
        .card-grade { background-color: var(--accent-blue-light); color: var(--accent-blue-dark); }
        .card-attendance { background-color: var(--accent-green-light); color: var(--accent-green-dark); }
        .card-students { background-color: var(--accent-purple-light); color: var(--accent-purple-dark); }
        .performance-table { width: 100%; border-collapse: collapse; }
        .performance-table th, .performance-table td { padding: 14px 8px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .performance-table .avg-grade { font-weight: 600; color: var(--accent-primary); }
        .progress-bar { width: 80px; height: 8px; background-color: #e9ecef; border-radius: 99px; overflow: hidden; }
        .progress { height: 100%; background-color: var(--accent-green-dark); border-radius: 99px; }
        .grade-dist-cell { display: flex; align-items: center; gap: 16px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 13px; }
        .badge-excellent { background-color: var(--accent-green-light); color: var(--accent-green-dark); }
        .badge-good { background-color: var(--accent-blue-light); color: var(--accent-blue-dark); }
        .badge-satisfactory { background-color: var(--accent-yellow-light); color: var(--accent-yellow-dark); }
        .badge-poor { background-color: var(--accent-red-light); color: var(--accent-red-dark); }
        .placeholder { text-align: center; padding: 60px; color: var(--text-secondary); }
        .placeholder i { font-size: 48px; margin-bottom: 16px; }

        /* Стили для РАСПИСАНИЯ */
        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .day-column { background-color: var(--bg-main); border-radius: 12px; padding: 16px; }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .lesson-card { background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .performance-table .progress-bar-container {
            width: 100%;
            min-width: 100px;
            background-color: #e9ecef; /* Цвет фона (трека) */
            border-radius: 8px;
            position: relative;
            height: 24px;
            display: flex;
            align-items: center;
            overflow: hidden; /* Скрываем все, что выходит за рамки */
        }

        .performance-table .progress-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.6s ease-in-out; /* Плавная анимация */
        }

        /* Цвета для прогресс-бара */
        .bg-success { background-color: #10B981; } /* Зеленый */
        
        .bg-warning { background-color: #ffc107; } /* Желтый */
        .bg-danger  { background-color: #dc3545; } /* Красный */

        .performance-table .progress-bar-container span {
            position: absolute;
            width: 100%;
            text-align: center;
            color: #000;
            font-weight: bold;
            font-size: 13px;
            /* Тень для лучшей читаемости текста на любом фоне */
            text-shadow: 0 0 2px white, 0 0 4px white; 
        }

        /* === НОВЫЕ СТИЛИ ДЛЯ МОДАЛЬНОГО ОКНА ДЕТАЛИЗАЦИИ === */
    #student-details-modal-overlay .data-table {
        width: 100%;
        border-collapse: collapse; /* Убираем двойные рамки */
        table-layout: fixed; /* Ключевое свойство для выравнивания колонок! */
    }

    #student-details-modal-overlay .data-table th,
    #student-details-modal-overlay .data-table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0; /* Легкая линия-разделитель */
    }

    #student-details-modal-overlay .data-table thead th {
        color: #6c757d; /* Серый цвет для заголовков */
        font-weight: 500;
        font-size: 14px;
        border-bottom: 1px solid #dee2e6; /* Более жирная линия под заголовком */
    }
    
    /* Убираем линию у последней строки для чистоты */
    #student-details-modal-overlay .data-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Задаем ширину колонок и выравнивание для чисел */
    #student-details-modal-overlay .student-name-col { width: 50%; }
    #student-details-modal-overlay .grade-col,
    #student-details-modal-overlay .attendance-col {
        width: 25%;
        text-align: right; /* Выравниваем числовые значения по правому краю */
    }
    #student-details-modal-overlay .modal-divider {
        border: none;
        border-top: 1px solid #e9ecef;
        margin: 16px 0;
    }

    <link rel="stylesheet" href="{% static 'bilimClassApp/css/schedule_head_school.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        .page-header { margin-bottom: 24px; }
        .page-title h2 { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .page-title p { color: var(--text-secondary); margin-top: 4px; }
        .content-card { background-color: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,.05), 0 2px 4px -2px rgba(0,0,0,.05); }
        .filters-toolbar { background-color: var(--bg-main); padding: 20px; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center; margin-bottom: 24px; }
        .filter-group label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 8px; }
        .filter-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #FFFFFF; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* === СТИЛИ ДЛЯ УТВЕРЖДЕНИЯ ПЛАНОВ (НОВЫЕ) === */
        .status-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .status-tab { padding: 10px 16px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); position: relative; display: flex; align-items: center; gap: 8px; }
        .status-tab .count-badge { background-color: #e5e7eb; color: #4b5563; border-radius: 99px; padding: 2px 8px; font-size: 12px; }
        .status-tab.active { color: var(--accent-primary); }
        .status-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background-color: var(--accent-primary); }
        .status-tab.active .count-badge { background-color: var(--accent-light); color: var(--accent-primary); }

        .plans-table { width: 100%; border-collapse: collapse; }
        .plans-table th, .plans-table td { padding: 14px 8px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .plans-table th { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); }
        .actions-cell .btn-group { display: flex; gap: 8px; justify-content: flex-start; }
        .actions-cell .action-btn { background: none; border: 1px solid transparent; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: grid; place-items: center; transition: background-color 0.2s; }
        .actions-cell .action-btn.view { color: var(--text-secondary); }
        .actions-cell .action-btn.approve { color: var(--accent-green); }
        .actions-cell .action-btn.reject { color: var(--accent-red); }
        .actions-cell .action-btn:hover { background-color: #f3f4f6; }

        .page-header { margin-bottom: 24px; }
        .page-title h2 { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .page-title p { color: var(--text-secondary); margin-top: 4px; }
        .content-card { background-color: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,.05), 0 2px 4px -2px rgba(0,0,0,.05); }
        .filters-toolbar { background-color: var(--bg-main); padding: 20px; border-radius: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: center; margin-bottom: 24px; }
        .filter-group label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 8px; }
        .filter-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #FFFFFF; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .status-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .status-tab-link { text-decoration: none; padding: 10px 16px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); position: relative; display: flex; align-items: center; gap: 8px; }
        .status-tab-link .count-badge { background-color: #e5e7eb; color: #4b5563; border-radius: 99px; padding: 2px 8px; font-size: 12px; }
        .status-tab-link.active { color: var(--accent-primary); }
        .status-tab-link.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background-color: var(--accent-primary); }
        .status-tab-link.active .count-badge { background-color: var(--accent-light); color: var(--accent-primary); }

        .plans-table { width: 100%; border-collapse: collapse; }
        .plans-table th, .plans-table td { padding: 14px 8px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .plans-table th { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); }
        .actions-cell .btn-group { display: flex; gap: 8px; justify-content: flex-start; }
        .actions-cell .action-btn { background: none; border: 1px solid transparent; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: grid; place-items: center; transition: all 0.2s; }
        .actions-cell .action-btn.view { color: var(--text-secondary); }
        .actions-cell .action-btn.approve { color: var(--accent-green); }
        .actions-cell .action-btn.reject { color: var(--accent-red); }
        .actions-cell .action-btn:hover { background-color: #f3f4f6; }
        .plans-table tr { transition: opacity 0.3s ease-out; }

    </style>
{% endblock %}

{% block content %}
<div class="content-card">
    
    <!-- === КОНТЕНТ ВКЛАДКИ "УСПЕВАЕМОСТЬ" === -->
    <div id="performance-content" class="tab-content">
        <div class="page-header">
            <div class="page-title">
                <h2><i class="fa-solid fa-chart-line"></i> Успеваемость по школе</h2>
                <p>Сводная ведомость успеваемости по классам, предметам и ученикам</p>
            </div>
        </div>
        <form method="GET" class="filters-toolbar">
            <input type="hidden" name="tab" value="performance">
            <select name="school_id" class="filter-select" onchange="this.form.submit()">
                <option value="">-- Выберите школу --</option>
                {% for school in all_schools %}
                    <option value="{{ school.id }}" {% if school.id == selected_school_id %}selected{% endif %}>{{ school.name }}</option>
                {% endfor %}
            </select>
        </form>

        {% if selected_school_id %}
            {% if performance_data %}
                <div class="summary-cards">
                    <div class="summary-card card-grade">
                        <div>
                            <div class="label">Средний балл</div>
                            <div class="value">{{ performance_data.overall_avg_grade|floatformat:2|default:"-" }}</div>
                        </div>
                        <div class="icon"><i class="fa-solid fa-award"></i></div>
                    </div>
                    <div class="summary-card card-attendance">
                        <div>
                            <div class="label">Средняя посещаемость</div>
                            <div class="value">{{ performance_data.overall_attendance|floatformat:0 }}%</div>
                        </div>
                         <div class="icon"><i class="fa-solid fa-user-check"></i></div>
                    </div>
                    <div class="summary-card card-students">
                        <div>
                            <div class="label">Всего учеников</div>
                            <div class="value">{{ performance_data.total_students }}</div>
                        </div>
                         <div class="icon"><i class="fa-solid fa-users"></i></div>
                    </div>
                </div>

                <table class="performance-table">
                    <thead>
                        <tr>
                            <th>Класс</th>
                            <th>Учеников</th>
                            <th>Средний балл</th>
                            <th>Посещаемость</th>
                            <th>Отличники</th>
                            <th>Хорошисты</th>
                            <th>Троечники</th>
                            <th>Неуспевающие</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in performance_data.class_stats %}
                        <tr>
                            <td>
                                <b><a href="#" class="class-details-link" data-class-id="{{ stat.class_id }}">{{ stat.class_name }}</a></b>
                            </td>
                            <td>{{ stat.student_count }}</td>
                            <td>{{ stat.avg_grade|floatformat:2 }}</td>
                            <td>
                                <div class="progress-bar-container">
                                    <!-- ============================================= -->
                                    <!-- === ИЗМЕНЕНИЕ ЗДЕСЬ: Добавлены классы и цвет === -->
                                    <!-- ============================================= -->
                                    <div class="progress-bar 
                                        {% if stat.attendance_percentage > 90 %}
                                            bg-success
                                        {% elif stat.attendance_percentage > 70 %}
                                            bg-warning
                                        {% else %}
                                            bg-danger
                                        {% endif %}"
                                        style="width: {{ stat.attendance_percentage|floatformat:1 }}%;">
                                    </div>
                                    <span>{{ stat.attendance_percentage|floatformat:1 }}%</span>
                                </div>
                            </td>
                            <td>{{ stat.excellent_students }}</td>
                            <td>{{ stat.good_students }}</td>
                            <td>{{ stat.satisfactory_students }}</td>
                            <td>{{ stat.poor_students }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 24px;">
                                Нет данных для отображения. Выберите школу.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="placeholder"><p>Нет данных для отображения.</p></div>
            {% endif %}
        {% else %}
            <div class="placeholder"><i class="fa-solid fa-school"></i><p>Выберите школу для просмотра статистики успеваемости.</p></div>
        {% endif %}
    </div>

    <!-- === КОНТЕНТ ВКЛАДКИ "РАСПИСАНИЕ ШКОЛЫ" === -->
    <div id="schedule-content" class="tab-content">
        <div class="page-header">
            <div class="page-title">
                <h2><i class="fa-solid fa-calendar-days"></i> Управление расписанием школы</h2>
                <p>Создание и редактирование расписания для всех классов</p>
            </div>
        </div>
        <form method="GET" id="schedule-filter-form" class="filters-toolbar">
            <input type="hidden" name="tab" value="schedule">
            <select name="school_id" id="school-select" class="filter-select">
                <option value="">-- Выберите школу --</option>
                {% for school in all_schools %}
                    <option value="{{ school.id }}" {% if school.id == selected_school_id %}selected{% endif %}>{{ school.name }}</option>
                {% endfor %}
            </select>
            <select name="class_id" id="class-select" class="filter-select" {% if not selected_school_id %}disabled{% endif %}>
                <option value="">-- Сначала выберите школу --</option>
                {% for s_class in classes_in_school %}
                     <option value="{{ s_class.id }}" {% if s_class.id == selected_class_id %}selected{% endif %}>{{ s_class.name }}</option>
                {% endfor %}
            </select>
        </form>

        {% if selected_class_id %}
            <div class="schedule-grid">
                {% for day_id, day_name in days_of_week.items %}
                    <div class="day-column">
                        <div class="day-header">
                            <h3>{{ day_name }}</h3>
                            <button class="add-lesson-to-day-btn" data-day-id="{{ day_id }}" data-day-name="{{ day_name }}">+</button>
                        </div>
                        <div class="lessons-list">
                            {% for lesson in schedule_by_day|get_item:day_id %}
                                <div class="lesson-card" data-lesson-id="{{ lesson.id }}">
                                    <div class="lesson-card" data-lesson-id="{{ lesson.id }}">
                                        <div class="lesson-time">{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</div>
                                        <div class="lesson-subject">{{ lesson.subject.name }}</div>
                                        <div class="lesson-details">
                                            <p class="lesson-teacher">
                                                <i class="fa-solid fa-chalkboard-user"></i>
                                                {{ lesson.teacher.user.get_full_name|default:"Не назначен" }}
                                            </p>
                                            <p class="lesson-classroom">
                                                <i class="fa-solid fa-location-dot"></i>
                                                Каб. {{ lesson.classroom|default:"-" }}
                                            </p>
                                        </div>
                                        
                                        <!-- Кнопки управления, которые будут работать с вашим JS -->
                                        <div class="lesson-actions">
                                            <button class="edit-lesson-btn" title="Редактировать"><i class="fa-solid fa-pencil"></i></button>
                                            <button class="delete-lesson-btn" title="Удалить"><i class="fa-solid fa-trash-can"></i></button>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <p class="no-lessons">Нет уроков</p>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% elif selected_school_id %}
             <div class="placeholder"><i class="fa-regular fa-calendar-check"></i><p>Теперь выберите класс, чтобы увидеть расписание.</p></div>
        {% else %}
             <div class="placeholder"><i class="fa-solid fa-school"></i><p>Выберите школу для управления расписанием.</p></div>
        {% endif %}
    </div>

    <!-- === КОНТЕНТ ВКЛАДКИ "УТВЕРЖДЕНИЕ ПЛАНОВ" === -->
    <div id="plan-approval-content" class="tab-content">
        <div class="page-header">
            <div class="page-title">
                <h2><i class="fa-solid fa-check-to-slot"></i> Утверждение учебных планов</h2>
                <p>Просмотр и утверждение поурочных планов, поданных учителями</p>
            </div>
        </div>

        <form method="GET" id="plan-filters-form">
            <input type="hidden" name="tab" value="plan-approval">
            <input type="hidden" name="status" value="{{ current_status|default:'pending' }}">
            <div class="filters-toolbar">
                <div class="filter-group">
                    <label for="subject-filter"><i class="fa-solid fa-filter" style="color: var(--text-secondary);"></i> Предмет</label>
                    <select id="subject-filter" name="subject_id" class="filter-select" onchange="this.form.submit()">
                        <option value="">Все предметы</option>
                        {% for subject in subjects_for_filter %}
                        <option value="{{ subject.pk }}" {% if subject.pk == selected_subject_id %}selected{% endif %}>{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="filter-group">
                    <label for="teacher-filter">Учитель</label>
                    <select id="teacher-filter" name="teacher_id" class="filter-select" onchange="this.form.submit()">
                        <option value="">Все учителя</option>
                        {% for teacher in teachers_for_filter %}
                        <option value="{{ teacher.pk }}" {% if teacher.pk == selected_teacher_id %}selected{% endif %}>{{ teacher.user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>

        <div class="status-tabs">
            <a href="?tab=plan-approval&status=pending" class="status-tab-link {% if current_status == 'pending' %}active{% endif %}">
                На рассмотрении <span class="count-badge">{{ status_counts.pending }}</span>
            </a>
            <a href="?tab=plan-approval&status=approved" class="status-tab-link {% if current_status == 'approved' %}active{% endif %}">
                Утвержденные <span class="count-badge">{{ status_counts.approved }}</span>
            </a>
            <a href="?tab=plan-approval&status=rejected" class="status-tab-link {% if current_status == 'rejected' %}active{% endif %}">
                Отклоненные <span class="count-badge">{{ status_counts.rejected }}</span>
            </a>
        </div>

        <table class="plans-table">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Учитель</th>
                    <th>Класс</th>
                    <th>Предмет</th>
                    <th>Дата урока</th>
                    <th>Подан</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="plans-table-body">
                {% for plan in lesson_plans %}
                <tr id="plan-row-{{ plan.pk }}">
                    <td><b>{{ plan.name }}</b></td>
                    <td>{{ plan.teacher.user.get_full_name }}</td>
                    <td>{{ plan.school_class.name }}</td>
                    <td>{{ plan.subject.name }}</td>
                    <td>{{ plan.date|date:"Y-m-d" }}</td>
                    <td>{{ plan.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="actions-cell">
                        <div class="btn-group">
                            <button class="action-btn view" data-plan-id="{{ plan.pk }}" title="Просмотреть"><i class="fa-solid fa-eye"></i></button>
                            {% if current_status == 'pending' %}
                            <button class="action-btn approve" data-plan-id="{{ plan.pk }}" title="Утвердить"><i class="fa-solid fa-circle-check"></i></button>
                            <button class="action-btn reject" data-plan-id="{{ plan.pk }}" title="Отклонить"><i class="fa-solid fa-circle-xmark"></i></button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align:center; padding: 40px; color: var(--text-secondary);">
                        Нет планов, соответствующих выбранным фильтрам.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


{% block modals %}
<!-- ===================================================================== -->
<!-- === МОДАЛЬНОЕ ОКНО ДЛЯ ДОБАВЛЕНИЯ/РЕДАКТИРОВАНИЯ УРОКА === -->
<!-- ===================================================================== -->
<div class="modal-overlay" id="lesson-modal-overlay">
    <div class="modal-container">
        <button class="modal-close-btn" id="close-lesson-modal-btn">&times;</button>
        <div class="modal-header">
            <h2 id="lesson-modal-title">Добавить урок</h2>
            <p id="lesson-modal-subtitle">Заполните информацию об уроке</p>
        </div>
        
        <form id="lesson-form" class="modal-form" novalidate>
            {% csrf_token %}
            <!-- Скрытые поля для отправки на сервер -->
            <input type="hidden" name="schedule_id" id="id_schedule_id">
            <input type="hidden" name="school_class_id" value="{{ selected_class_id }}">
            <input type="hidden" name="school_id" value="{{ selected_school_id }}">
            <input type="hidden" name="day_of_week" id="id_day_of_week">
            
            <div class="form-grid">
                <div class="form-group">
                    {{ schedule_form.start_time.label_tag }}
                    {{ schedule_form.start_time }}
                </div>
                <div class="form-group">
                    {{ schedule_form.end_time.label_tag }}
                    {{ schedule_form.end_time }}
                </div>
            </div>

            <div class="form-group">
                {{ schedule_form.subject.label_tag }}
                {{ schedule_form.subject }}
            </div>
            <div class="form-group">
                {{ schedule_form.teacher.label_tag }}
                {{ schedule_form.teacher }}
            </div>
            <div class="form-group">
                {{ schedule_form.classroom.label_tag }}
                {{ schedule_form.classroom }}
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancel-lesson-btn">Отмена</button>
                <button type="submit" class="btn-primary" id="submit-lesson-btn">Добавить</button>
            </div>
        </form>
    </div>
</div>

<!-- ========================================================== -->
<!-- === НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ДЕТАЛЕЙ ПО КЛАССУ (вставить в конце файла, перед ) === -->
<!-- ========================================================== -->
<div class="modal-overlay" id="student-details-modal-overlay" style="display: none;">
    <div class="modal-container modal-lg"> <!-- Добавлен класс modal-lg для ширины -->
        <button class="close-btn" id="close-student-details-modal-btn">&times;</button>
        <div class="modal-header">
            <h2 id="modal-class-name">Успеваемость класса</h2>
            <p>Детальная информация по каждому ученику</p>
        </div>
        
        <div class="table-wrapper" style="max-height: 60vh; overflow-y: auto;">
            <!-- Спиннер для индикации загрузки -->
            <div id="modal-loader" style="text-align: center; padding: 40px; display: none;">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
                <p>Загрузка данных...</p>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ФИО Ученика</th>
                        <th>Средний балл</th>
                        <th>Посещаемость</th>
                    </tr>
                </thead>
                <tbody id="student-details-tbody">
                    <!-- Данные будут вставлены сюда с помощью JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-secondary" id="cancel-student-details-btn">Закрыть</button>
        </div>
    </div>
</div>

{% endblock %}



{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- ГЛАВНЫЙ СКРИПТ УПРАВЛЕНИЯ ВКЛАДКАМИ ---
    const navLinks = document.querySelectorAll('.main-nav a[data-page="headteacher"]');
    const tabContents = document.querySelectorAll('.tab-content');

    function switchTab(tabName) {
        // Устанавливаем active класс на ссылке в навигации
        navLinks.forEach(link => {
            link.classList.toggle('active', link.dataset.tab === tabName);
        });

        // Показываем нужный контент
        tabContents.forEach(content => {
            content.classList.toggle('active', content.id === tabName + '-content');
        });
    }

    // Обработчик кликов по ссылкам навигации
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault(); // Отменяем стандартный переход
            const tabName = this.dataset.tab;
            switchTab(tabName);
            // Обновляем URL в браузере без перезагрузки
            window.history.pushState({}, '', this.href);
        });
    });

    // Активируем нужную вкладку при первоначальной загрузке страницы
    const initialTab = '{{ active_tab }}';
    switchTab(initialTab);

    // --- БЛОК 1: УПРАВЛЕНИЕ ФИЛЬТРАМИ (ШКОЛА И КЛАСС) ---
    const schoolSelect = document.getElementById('school-select');
    const classSelect = document.getElementById('class-select');
    const filterForm = document.getElementById('schedule-filter-form');

    schoolSelect.addEventListener('change', async function() {
        const schoolId = this.value;
        classSelect.innerHTML = '<option value="">Загрузка...</option>';
        classSelect.disabled = true;

        if (schoolId) {
            try {
                const response = await fetch(`/api/school/${schoolId}/classes/`);
                if (!response.ok) throw new Error('Network response was not ok');
                const classes = await response.json();
                
                classSelect.innerHTML = '<option value="">-- Выберите класс --</option>';
                classes.forEach(function(s_class) {
                    const option = new Option(s_class.name, s_class.id);
                    classSelect.add(option);
                });
                classSelect.disabled = false;
            } catch (error) {
                console.error('Failed to fetch classes:', error);
                classSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            }
        } else {
            classSelect.innerHTML = '<option value="">-- Сначала выберите школу --</option>';
        }
    });

    classSelect.addEventListener('change', function() {
        if (this.value) {
            filterForm.submit();
        }
    });

    // --- БЛОК 2: УПРАВЛЕНИЕ МОДАЛЬНЫМ ОКНОМ УРОКА ---
    const modalOverlay = document.getElementById('lesson-modal-overlay');
    if (modalOverlay) {
        const modalTitle = document.getElementById('lesson-modal-title');
        const modalSubtitle = document.getElementById('lesson-modal-subtitle');
        const lessonForm = document.getElementById('lesson-form');
        const submitBtn = document.getElementById('submit-lesson-btn');
        const scheduleIdInput = document.getElementById('id_schedule_id');
        const dayOfWeekInput = document.getElementById('id_day_of_week');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const openModal = () => modalOverlay.style.display = 'flex';
        const closeModal = () => modalOverlay.style.display = 'none';

        document.getElementById('close-lesson-modal-btn').addEventListener('click', closeModal);
        document.getElementById('cancel-lesson-btn').addEventListener('click', closeModal);

        // Открытие модального окна для СОЗДАНИЯ урока
        document.querySelectorAll('.add-lesson-to-day-btn').forEach(button => {
            button.addEventListener('click', () => {
                lessonForm.reset();
                scheduleIdInput.value = '';
                dayOfWeekInput.value = button.dataset.dayId;
                
                modalTitle.textContent = 'Добавить урок';
                const selectedClassText = document.querySelector("#class-select option:checked").textContent.trim();
                modalSubtitle.textContent = `${button.dataset.dayName}, ${selectedClassText}`;
                submitBtn.textContent = 'Добавить';
                
                openModal();
            });
        });

        // Открытие модального окна для РЕДАКТИРОВАНИЯ урока
        document.querySelectorAll('.edit-lesson-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const lessonCard = button.closest('.lesson-card');
                const lessonId = lessonCard.dataset.lessonId;
                
                const response = await fetch(`/api/schedule/${lessonId}/details/`);
                if (response.ok) {
                    const data = await response.json();
                    lessonForm.reset();
                    scheduleIdInput.value = data.id;

                    // === ИЗМЕНЕНИЕ ЗДЕСЬ: УСТАНАВЛИВАЕМ ЗНАЧЕНИЕ ДЛЯ СКРЫТОГО ПОЛЯ ===
                    dayOfWeekInput.value = data.day_of_week; 
                    // ================================================================
                    
                    document.getElementById('id_start_time').value = data.start_time;
                    document.getElementById('id_end_time').value = data.end_time;
                    document.getElementById('id_subject').value = data.subject;
                    document.getElementById('id_teacher').value = data.teacher;
                    document.getElementById('id_classroom').value = data.classroom;
                    
                    modalTitle.textContent = 'Редактировать урок';
                    modalSubtitle.textContent = 'Измените данные урока';
                    submitBtn.textContent = 'Сохранить';
                    
                    openModal();
                } else {
                    alert('Не удалось загрузить данные урока.');
                }
            });
        });
        
        // Обработка отправки формы
        lessonForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(lessonForm);
            const response = await fetch("{% url 'api_manage_schedule_item' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            });
            
            if (response.ok) {
                location.reload();
            } else {
                const result = await response.json();
                const errorMessages = Object.values(result.errors).map(err => err[0]).join('\n');
                alert('Ошибка валидации:\n' + errorMessages);
            }
        });

        // Удаление урока
        document.querySelectorAll('.delete-lesson-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm('Вы уверены, что хотите удалить этот урок?')) {
                    const lessonCard = button.closest('.lesson-card');
                    const lessonId = lessonCard.dataset.lessonId;
                    
                    const response = await fetch(`/api/schedule/${lessonId}/delete/`, {
                        method: 'POST',
                        headers: {'X-CSRFToken': csrfToken}
                    });

                    if (response.ok) {
                        lessonCard.remove();
                    } else {
                        alert('Не удалось удалить урок.');
                    }
                }
            });
        });
    }

    const modalOverlayNew = document.getElementById('student-details-modal-overlay');
    const modalTbody = document.getElementById('student-details-tbody');
    const modalTitle = document.getElementById('modal-class-name');
    const modalLoader = document.getElementById('modal-loader');
    
    const openModal = () => {
        modalOverlayNew.style.display = 'flex';
    };
    const closeModal = () => {
        modalOverlayNew.style.display = 'none';
        modalTbody.innerHTML = ''; // Очищаем таблицу при закрытии
    };

    // Закрытие по кнопке и по клику на фон
    document.getElementById('close-student-details-modal-btn').addEventListener('click', closeModal);
    document.getElementById('cancel-student-details-btn').addEventListener('click', closeModal);
    modalOverlayNew.addEventListener('click', (e) => {
        if (e.target === modalOverlayNew) {
            closeModal();
        }
    });

    document.querySelectorAll('.class-details-link').forEach(link => {
        link.addEventListener('click', async (e) => {
            e.preventDefault();
            
            const classId = e.currentTarget.dataset.classId;
            
            // 1. Открыть модальное окно и показать спиннер
            openModal();
            modalLoader.style.display = 'block';
            modalTbody.innerHTML = ''; // Очищаем старые данные
            modalTitle.textContent = 'Загрузка...';

            try {
                // 2. Сделать запрос к API
                const response = await fetch(`/api/class/${classId}/performance/`);
                
                if (!response.ok) {
                    throw new Error('Ошибка сети или сервера');
                }
                
                const data = await response.json();
                
                // 3. Заполнить заголовок
                modalTitle.textContent = `Успеваемость класса: ${data.class_name}`;

                // 4. Заполнить таблицу данными
                if (data.students && data.students.length > 0) {
                    data.students.forEach(student => {
                        const row = document.createElement('tr');
                        
                        // Ячейка с ФИО
                        const nameCell = document.createElement('td');
                        nameCell.innerHTML = `<strong>${student.full_name}</strong>`;
                        
                        // Ячейка со средним баллом
                        const gradeCell = document.createElement('td');
                        gradeCell.textContent = student.avg_grade;
                        
                        // Ячейка с посещаемостью
                        const attendanceCell = document.createElement('td');
                        attendanceCell.textContent = `${student.attendance_percentage}%`;

                        row.appendChild(nameCell);
                        row.appendChild(gradeCell);
                        row.appendChild(attendanceCell);
                        
                        modalTbody.appendChild(row);
                    });
                } else {
                    modalTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 24px;">В этом классе нет учеников.</td></tr>';
                }

            } catch (error) {
                console.error("Ошибка при загрузке данных о классе:", error);
                modalTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 24px; color: red;">Не удалось загрузить данные.</td></tr>';
            } finally {
                // 5. Скрыть спиннер
                modalLoader.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}