{% extends "bilimClassApp/base_dashboard.html" %}
{% load static %}
{% load custom_filters %} {# Загрузка кастомного фильтра #}

{% block title %}Расписание школы{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/schedule_head_school.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        .page-header { margin-bottom: 24px; }
        .page-title h2 { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .page-title p { color: var(--text-secondary); margin-top: 4px; }
        .content-card { background-color: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,.05), 0 2px 4px -2px rgba(0,0,0,.05); }
        .filters-toolbar { display: flex; gap: 16px; margin-bottom: 24px; }
        .filter-select { padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--bg-main); }
        
        /* Скрываем контент вкладок по умолчанию */
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Стили для УСПЕВАЕМОСТИ */
        :root {
            --accent-purple-light: #F5F3FF; --accent-purple-dark: #5B21B6; --accent-green-light: #F0FDF4;
            --accent-green-dark: #166534; --accent-blue-light: #EFF6FF; --accent-blue-dark: #1E40AF;
            --accent-yellow-light: #FEFCE8; --accent-yellow-dark: #854D0E; --accent-red-light: #FEF2F2; --accent-red-dark: #991B1B;
        }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .summary-card { padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .summary-card .value { font-size: 28px; font-weight: 700; }
        .summary-card .label { color: var(--text-secondary); }
        .summary-card .icon { font-size: 24px; }
        .card-grade { background-color: var(--accent-blue-light); color: var(--accent-blue-dark); }
        .card-attendance { background-color: var(--accent-green-light); color: var(--accent-green-dark); }
        .card-students { background-color: var(--accent-purple-light); color: var(--accent-purple-dark); }
        .performance-table { width: 100%; border-collapse: collapse; }
        .performance-table th, .performance-table td { padding: 14px 8px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .performance-table .avg-grade { font-weight: 600; color: var(--accent-primary); }
        .progress-bar { width: 80px; height: 8px; background-color: #e9ecef; border-radius: 99px; overflow: hidden; }
        .progress { height: 100%; background-color: var(--accent-green-dark); border-radius: 99px; }
        .grade-dist-cell { display: flex; align-items: center; gap: 16px; }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 13px; }
        .badge-excellent { background-color: var(--accent-green-light); color: var(--accent-green-dark); }
        .badge-good { background-color: var(--accent-blue-light); color: var(--accent-blue-dark); }
        .badge-satisfactory { background-color: var(--accent-yellow-light); color: var(--accent-yellow-dark); }
        .badge-poor { background-color: var(--accent-red-light); color: var(--accent-red-dark); }
        .placeholder { text-align: center; padding: 60px; color: var(--text-secondary); }
        .placeholder i { font-size: 48px; margin-bottom: 16px; }

        /* Стили для РАСПИСАНИЯ */
        .schedule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .day-column { background-color: var(--bg-main); border-radius: 12px; padding: 16px; }
        .day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .lesson-card { background: white; border-radius: 8px; padding: 12px; margin-bottom: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .performance-table .progress-bar-container {
            width: 100%;
            min-width: 100px;
            background-color: #e9ecef; /* Цвет фона (трека) */
            border-radius: 8px;
            position: relative;
            height: 24px;
            display: flex;
            align-items: center;
            overflow: hidden; /* Скрываем все, что выходит за рамки */
        }

        .performance-table .progress-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.6s ease-in-out; /* Плавная анимация */
        }

        /* Цвета для прогресс-бара */
        .bg-success { background-color: #10B981; } /* Зеленый */
        
        .bg-warning { background-color: #ffc107; } /* Желтый */
        .bg-danger  { background-color: #dc3545; } /* Красный */

        .performance-table .progress-bar-container span {
            position: absolute;
            width: 100%;
            text-align: center;
            color: #000;
            font-weight: bold;
            font-size: 13px;
            /* Тень для лучшей читаемости текста на любом фоне */
            text-shadow: 0 0 2px white, 0 0 4px white; 
        }

        /* === НОВЫЕ СТИЛИ ДЛЯ МОДАЛЬНОГО ОКНА ДЕТАЛИЗАЦИИ === */
    #student-details-modal-overlay .data-table {
        width: 100%;
        border-collapse: collapse; /* Убираем двойные рамки */
        table-layout: fixed; /* Ключевое свойство для выравнивания колонок! */
    }

    #student-details-modal-overlay .data-table th,
    #student-details-modal-overlay .data-table td {
        padding: 12px 16px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0; /* Легкая линия-разделитель */
    }

    #student-details-modal-overlay .data-table thead th {
        color: #6c757d; /* Серый цвет для заголовков */
        font-weight: 500;
        font-size: 14px;
        border-bottom: 1px solid #dee2e6; /* Более жирная линия под заголовком */
    }
    
    /* Убираем линию у последней строки для чистоты */
    #student-details-modal-overlay .data-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Задаем ширину колонок и выравнивание для чисел */
    #student-details-modal-overlay .student-name-col { width: 50%; }
    #student-details-modal-overlay .grade-col,
    #student-details-modal-overlay .attendance-col {
        width: 25%;
        text-align: right; /* Выравниваем числовые значения по правому краю */
    }
    #student-details-modal-overlay .modal-divider {
        border: none;
        border-top: 1px solid #e9ecef;
        margin: 16px 0;
    }
    
        .page-header { margin-bottom: 24px; }
        .page-title h2 { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .page-title p { color: var(--text-secondary); margin-top: 4px; }
        .content-card { background-color: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,.05), 0 2px 4px -2px rgba(0,0,0,.05); }
        .filters-toolbar { background-color: var(--bg-main); padding: 20px; border-radius: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center; margin-bottom: 24px; }
        .filter-group label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 8px; }
        .filter-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #FFFFFF; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* === СТИЛИ ДЛЯ УТВЕРЖДЕНИЯ ПЛАНОВ (НОВЫЕ) === */
        .status-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .status-tab { padding: 10px 16px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); position: relative; display: flex; align-items: center; gap: 8px; }
        .status-tab .count-badge { background-color: #e5e7eb; color: #4b5563; border-radius: 99px; padding: 2px 8px; font-size: 12px; }
        .status-tab.active { color: var(--accent-primary); }
        .status-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background-color: var(--accent-primary); }
        .status-tab.active .count-badge { background-color: var(--accent-light); color: var(--accent-primary); }

        .plans-table { width: 100%; border-collapse: collapse; }
        .plans-table th, .plans-table td { padding: 14px 8px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .plans-table th { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); }
        .actions-cell .btn-group { display: flex; gap: 8px; justify-content: flex-start; }
        .actions-cell .action-btn { background: none; border: 1px solid transparent; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: grid; place-items: center; transition: background-color 0.2s; }
        .actions-cell .action-btn.view { color: var(--text-secondary); }
        .actions-cell .action-btn.approve { color: var(--accent-green); }
        .actions-cell .action-btn.reject { color: var(--accent-red); }
        .actions-cell .action-btn:hover { background-color: #f3f4f6; }

        .page-header { margin-bottom: 24px; }
        .page-title h2 { font-size: 24px; font-weight: 700; display: flex; align-items: center; gap: 12px; }
        .page-title p { color: var(--text-secondary); margin-top: 4px; }
        .content-card { background-color: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,.05), 0 2px 4px -2px rgba(0,0,0,.05); }
        .filters-toolbar { background-color: var(--bg-main); padding: 20px; border-radius: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; align-items: center; margin-bottom: 24px; }
        .filter-group label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 8px; }
        .filter-select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background-color: #FFFFFF; }
        
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .status-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .status-tab-link { text-decoration: none; padding: 10px 16px; border: none; background: none; cursor: pointer; font-weight: 600; color: var(--text-secondary); position: relative; display: flex; align-items: center; gap: 8px; }
        .status-tab-link .count-badge { background-color: #e5e7eb; color: #4b5563; border-radius: 99px; padding: 2px 8px; font-size: 12px; }
        .status-tab-link.active { color: var(--accent-primary); }
        .status-tab-link.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background-color: var(--accent-primary); }
        .status-tab-link.active .count-badge { background-color: var(--accent-light); color: var(--accent-primary); }

        .plans-table { width: 100%; border-collapse: collapse; }
        .plans-table th, .plans-table td { padding: 14px 8px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .plans-table th { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); }
        .actions-cell .btn-group { display: flex; gap: 8px; justify-content: flex-start; }
        .actions-cell .action-btn { background: none; border: 1px solid transparent; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: grid; place-items: center; transition: all 0.2s; }
        .actions-cell .action-btn.view { color: var(--text-secondary); }
        .actions-cell .action-btn.approve { color: var(--accent-green); }
        .actions-cell .action-btn.reject { color: var(--accent-red); }
        .actions-cell .action-btn:hover { background-color: #f3f4f6; }
        .plans-table tr { transition: opacity 0.3s ease-out; }

        /* bilimClassApp/css/schedule_head_school.css или в <style> */

.lp-view-details {
    margin-top: 24px;
}
.lp-view-details dt {
    font-weight: 600;
    color: var(--text-secondary);
    margin-top: 16px;
    font-size: 14px;
}
.lp-view-details dd {
    margin-top: 4px;
    white-space: pre-wrap; /* Сохраняет переносы строк из поля textarea */
    word-wrap: break-word; /* Переносит длинные слова */
    font-size: 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid #f0f0f0;
}
.lp-view-details dd:last-of-type {
    border-bottom: none;
}
.file-link {
    color: var(--accent-primary);
    text-decoration: none;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: color 0.2s;
}
.file-link:hover {
    color: #4338CA; /* Более темный оттенок */
}

/* Контейнер модального окна */
#plan-view-modal .modal-container {
    position: relative;
    padding: 32px;
    width: 100%;
    max-width: 500px; /* Ограничиваем ширину для лучшего вида */
}

/* --- Иконка закрытия в правом верхнем углу --- */
/* Эта кнопка заменяет текстовую кнопку "Закрыть" согласно вашему запросу */
#plan-view-modal .close-btn {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%; /* Круглая форма */
    background-color: var(--bg-main); /* Светло-серый фон */
    color: var(--text-secondary);
    font-size: 20px;
    line-height: 1;
    cursor: pointer;
    display: grid;
    place-items: center;
    transition: all 0.2s ease-in-out;
}

#plan-view-modal .close-btn:hover {
    background-color: #E5E7EB; /* Темнее при наведении */
    transform: rotate(90deg);
}

/* Полностью скрываем футер, так как иконка его заменяет */
#plan-view-modal .modal-footer {
    display: none;
}

/* --- Заголовок модального окна --- */
#plan-view-modal .modal-header {
    text-align: center;
    border-bottom: 1px solid var(--border-color);
    padding-bottom: 16px;
    margin-bottom: 16px;
}

/* Главный заголовок (например, "1" на скриншоте) */
#plan-view-modal  {
    font-size: 48px;
    font-weight: 700;
    line-height: 1.1;
    margin-bottom: 8px;
}

#view-plan-title {
    font-size: 30px;
    font-weight: 700;
    line-height: 1.1;
    margin-bottom: 8px;
}

/* Подзаголовок (Класс, Предмет, Дата) */
#plan-view-modal .modal-header p {
    font-size: 16px;
    color: var(--text-secondary);
    margin: 0;
}

/* --- Содержимое (детали плана) --- */
#plan-view-modal .lp-view-details dt {
    font-size: 13px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-top: 20px;
    border: none;
    padding: 0;
}

#plan-view-modal .lp-view-details dd {
    font-size: 16px;
    margin-top: 6px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
    min-height: 20px;
    white-space: pre-wrap; /* Сохраняет переносы строк */
    word-wrap: break-word; /* Переносит длинные слова */
}

/* Убираем линию у последнего элемента */
#plan-view-modal .lp-view-details dd:last-of-type {
    border-bottom: none;
    padding-bottom: 0;
}

/* Ссылка на файл */
#plan-view-modal .file-link {
    color: var(--accent-primary); /* Используем переменную для цвета */
    font-weight: 500;
}
#plan-view-modal .file-link:hover {
    color: #4338CA;
}

.td-user-section { display: flex; align-items: center; gap: 16px; }
.td-user-info { text-align: right; } .td-user-info h3 { font-weight: 600; }
.td-user-info p { font-size: 14px; color: var(--text-secondary); }
.td-user-link { text-decoration: none; color: inherit; }
.td-user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #D8B4FE; color: #581C87; display: grid; place-items: center; font-weight: 600; }

    </style>
{% endblock %}

{% block content %}
<div class="content-card">
    
    <!-- === КОНТЕНТ ВКЛАДКИ "УСПЕВАЕМОСТЬ" === -->
    <div id="performance-content" class="tab-content">
        <div class="page-header">
            <div class="page-title">
                <h2><i class="fa-solid fa-chart-line"></i> Успеваемость по школе</h2>
                <p>Сводная ведомость успеваемости по классам, предметам и ученикам</p>
            </div>
        </div>
        <form method="GET" class="filters-toolbar">
            <input type="hidden" name="tab" value="performance">
            <select name="school_id" class="filter-select" onchange="this.form.submit()">
                <option value="">-- Выберите школу --</option>
                {% for school in all_schools %}
                    <option value="{{ school.id }}" {% if school.id == selected_school_id %}selected{% endif %}>{{ school.name }}</option>
                {% endfor %}
            </select>
        </form>

        {% if selected_school_id %}
            {% if performance_data %}
                <div class="summary-cards">
                    <div class="summary-card card-grade">
                        <div>
                            <div class="label">Средний балл</div>
                            <div class="value">{{ performance_data.overall_avg_grade|floatformat:2|default:"-" }}</div>
                        </div>
                        <div class="icon"><i class="fa-solid fa-award"></i></div>
                    </div>
                    <div class="summary-card card-attendance">
                        <div>
                            <div class="label">Средняя посещаемость</div>
                            <div class="value">{{ performance_data.overall_attendance|floatformat:0 }}%</div>
                        </div>
                         <div class="icon"><i class="fa-solid fa-user-check"></i></div>
                    </div>
                    <div class="summary-card card-students">
                        <div>
                            <div class="label">Всего учеников</div>
                            <div class="value">{{ performance_data.total_students }}</div>
                        </div>
                         <div class="icon"><i class="fa-solid fa-users"></i></div>
                    </div>
                </div>

                <table class="performance-table">
                    <thead>
                        <tr>
                            <th>Класс</th>
                            <th>Учеников</th>
                            <th>Средний балл</th>
                            <th>Посещаемость</th>
                            <th>Отличники</th>
                            <th>Хорошисты</th>
                            <th>Троечники</th>
                            <th>Неуспевающие</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stat in performance_data.class_stats %}
                        <tr>
                            <td>
                                <b><a href="#" class="class-details-link" data-class-id="{{ stat.class_id }}">{{ stat.class_name }}</a></b>
                            </td>
                            <td>{{ stat.student_count }}</td>
                            <td>{{ stat.avg_grade|floatformat:2 }}</td>
                            <td>
                                <div class="progress-bar-container">
                                    <!-- ============================================= -->
                                    <!-- === ИЗМЕНЕНИЕ ЗДЕСЬ: Добавлены классы и цвет === -->
                                    <!-- ============================================= -->
                                    <div class="progress-bar 
                                        {% if stat.attendance_percentage > 90 %}
                                            bg-success
                                        {% elif stat.attendance_percentage > 70 %}
                                            bg-warning
                                        {% else %}
                                            bg-danger
                                        {% endif %}"
                                        style="width: {{ stat.attendance_percentage|floatformat:1 }}%;">
                                    </div>
                                    <span>{{ stat.attendance_percentage|floatformat:1 }}%</span>
                                </div>
                            </td>
                            <td>{{ stat.excellent_students }}</td>
                            <td>{{ stat.good_students }}</td>
                            <td>{{ stat.satisfactory_students }}</td>
                            <td>{{ stat.poor_students }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 24px;">
                                Нет данных для отображения. Выберите школу.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <div class="placeholder"><p>Нет данных для отображения.</p></div>
            {% endif %}
        {% else %}
            <div class="placeholder"><i class="fa-solid fa-school"></i><p>Выберите школу для просмотра статистики успеваемости.</p></div>
        {% endif %}
    </div>

    <!-- === КОНТЕНТ ВКЛАДКИ "РАСПИСАНИЕ ШКОЛЫ" === -->
    <div id="schedule-content" class="tab-content">
        <div class="page-header">
            <div class="page-title">
                <h2><i class="fa-solid fa-calendar-days"></i> Управление расписанием школы</h2>
                <p>Создание и редактирование расписания для всех классов</p>
            </div>
        </div>
        <form method="GET" id="schedule-filter-form" class="filters-toolbar">
            <input type="hidden" name="tab" value="schedule">
            <select name="school_id" id="school-select" class="filter-select">
                <option value="">-- Выберите школу --</option>
                {% for school in all_schools %}
                    <option value="{{ school.id }}" {% if school.id == selected_school_id %}selected{% endif %}>{{ school.name }}</option>
                {% endfor %}
            </select>
            <select name="class_id" id="class-select" class="filter-select" {% if not selected_school_id %}disabled{% endif %}>
                <option value="">-- Сначала выберите школу --</option>
                {% for s_class in classes_in_school %}
                     <option value="{{ s_class.id }}" {% if s_class.id == selected_class_id %}selected{% endif %}>{{ s_class.name }}</option>
                {% endfor %}
            </select>
        </form>

        {% if selected_class_id %}
            <div class="schedule-grid">
                {% for day_id, day_name in days_of_week.items %}
                    <div class="day-column">
                        <div class="day-header">
                            <h3>{{ day_name }}</h3>
                            <button class="add-lesson-to-day-btn" data-day-id="{{ day_id }}" data-day-name="{{ day_name }}">+</button>
                        </div>
                        <div class="lessons-list">
                            {% for lesson in schedule_by_day|get_item:day_id %}
                                <div class="lesson-card" data-lesson-id="{{ lesson.id }}">
                                    <div class="lesson-card" data-lesson-id="{{ lesson.id }}">
                                        <div class="lesson-time">{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</div>
                                        <div class="lesson-subject">{{ lesson.subject.name }}</div>
                                        <div class="lesson-details">
                                            <p class="lesson-teacher">
                                                <i class="fa-solid fa-chalkboard-user"></i>
                                                {{ lesson.teacher.user.get_full_name|default:"Не назначен" }}
                                            </p>
                                            <p class="lesson-classroom">
                                                <i class="fa-solid fa-location-dot"></i>
                                                Каб. {{ lesson.classroom|default:"-" }}
                                            </p>
                                        </div>
                                        
                                        <!-- Кнопки управления, которые будут работать с вашим JS -->
                                        <div class="lesson-actions">
                                            <button class="edit-lesson-btn" title="Редактировать"><i class="fa-solid fa-pencil"></i></button>
                                            <button class="delete-lesson-btn" title="Удалить"><i class="fa-solid fa-trash-can"></i></button>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <p class="no-lessons">Нет уроков</p>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% elif selected_school_id %}
             <div class="placeholder"><i class="fa-regular fa-calendar-check"></i><p>Теперь выберите класс, чтобы увидеть расписание.</p></div>
        {% else %}
             <div class="placeholder"><i class="fa-solid fa-school"></i><p>Выберите школу для управления расписанием.</p></div>
        {% endif %}
    </div>

    <!-- === КОНТЕНТ ВКЛАДКИ "УТВЕРЖДЕНИЕ ПЛАНОВ" === -->
    <div id="plan-approval-content" class="tab-content">
        <div class="page-header">
            <div class="page-title">
                <h2><i class="fa-solid fa-check-to-slot"></i> Утверждение учебных планов</h2>
                <p>Просмотр и утверждение поурочных планов, поданных учителями</p>
            </div>
        </div>

        <form method="GET" id="plan-filters-form">
            <input type="hidden" name="tab" value="plan-approval">
            <input type="hidden" name="status" value="{{ current_status|default:'pending' }}">
            <div class="filters-toolbar">
                <div class="filter-group">
                    <label for="subject-filter"><i class="fa-solid fa-filter" style="color: var(--text-secondary);"></i> Предмет</label>
                    <select id="subject-filter" name="subject_id" class="filter-select" onchange="this.form.submit()">
                        <option value="">Все предметы</option>
                        {% for subject in subjects_for_filter %}
                        <option value="{{ subject.pk }}" {% if subject.pk == selected_subject_id %}selected{% endif %}>{{ subject.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                 <div class="filter-group">
                    <label for="teacher-filter">Учитель</label>
                    <select id="teacher-filter" name="teacher_id" class="filter-select" onchange="this.form.submit()">
                        <option value="">Все учителя</option>
                        {% for teacher in teachers_for_filter %}
                        <option value="{{ teacher.pk }}" {% if teacher.pk == selected_teacher_id %}selected{% endif %}>{{ teacher.user.get_full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </form>

        <div class="status-tabs">
            <a href="?tab=plan-approval&status=pending" class="status-tab-link {% if current_status == 'pending' %}active{% endif %}">
                На рассмотрении <span class="count-badge">{{ status_counts.pending }}</span>
            </a>
            <a href="?tab=plan-approval&status=approved" class="status-tab-link {% if current_status == 'approved' %}active{% endif %}">
                Утвержденные <span class="count-badge">{{ status_counts.approved }}</span>
            </a>
            <a href="?tab=plan-approval&status=rejected" class="status-tab-link {% if current_status == 'rejected' %}active{% endif %}">
                Отклоненные <span class="count-badge">{{ status_counts.rejected }}</span>
            </a>
        </div>

        <table class="plans-table">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Учитель</th>
                    <th>Класс</th>
                    <th>Предмет</th>
                    <th>Дата урока</th>
                    <th>Подан</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody id="plans-table-body">
                {% for plan in lesson_plans %}
                <tr id="plan-row-{{ plan.pk }}">
                    <td><b>{{ plan.name }}</b></td>
                    <td>{{ plan.teacher.user.get_full_name }}</td>
                    <td>{{ plan.school_class.name }}</td>
                    <td>{{ plan.subject.name }}</td>
                    <td>{{ plan.date|date:"Y-m-d" }}</td>
                    <td>{{ plan.created_at|date:"Y-m-d H:i" }}</td>
                    <td class="actions-cell">
                        <div class="btn-group">
                            <button class="action-btn view" data-plan-id="{{ plan.pk }}" title="Просмотреть"><i class="fa-solid fa-eye"></i></button>
                            {% if current_status == 'pending' %}
                            <button class="action-btn approve" data-plan-id="{{ plan.pk }}" title="Утвердить"><i class="fa-solid fa-circle-check"></i></button>
                            <button class="action-btn reject" data-plan-id="{{ plan.pk }}" title="Отклонить"><i class="fa-solid fa-circle-xmark"></i></button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align:center; padding: 40px; color: var(--text-secondary);">
                        Нет планов, соответствующих выбранным фильтрам.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}


{% block modals %}
<!-- ===================================================================== -->
<!-- === МОДАЛЬНОЕ ОКНО ДЛЯ ДОБАВЛЕНИЯ/РЕДАКТИРОВАНИЯ УРОКА === -->
<!-- ===================================================================== -->
<div class="modal-overlay" id="lesson-modal-overlay">
    <div class="modal-container">
        <button class="modal-close-btn" id="close-lesson-modal-btn">&times;</button>
        <div class="modal-header">
            <h2 id="lesson-modal-title">Добавить урок</h2>
            <p id="lesson-modal-subtitle">Заполните информацию об уроке</p>
        </div>
        
        <form id="lesson-form" class="modal-form" novalidate>
            {% csrf_token %}
            <!-- Скрытые поля для отправки на сервер -->
            <input type="hidden" name="schedule_id" id="id_schedule_id">
            <input type="hidden" name="school_class_id" value="{{ selected_class_id }}">
            <input type="hidden" name="school_id" value="{{ selected_school_id }}">
            <input type="hidden" name="day_of_week" id="id_day_of_week">
            
            <div class="form-grid">
                <div class="form-group">
                    {{ schedule_form.start_time.label_tag }}
                    {{ schedule_form.start_time }}
                </div>
                <div class="form-group">
                    {{ schedule_form.end_time.label_tag }}
                    {{ schedule_form.end_time }}
                </div>
            </div>

            <div class="form-group">
                {{ schedule_form.subject.label_tag }}
                {{ schedule_form.subject }}
            </div>
            <div class="form-group">
                {{ schedule_form.teacher.label_tag }}
                {{ schedule_form.teacher }}
            </div>
            <div class="form-group">
                {{ schedule_form.classroom.label_tag }}
                {{ schedule_form.classroom }}
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancel-lesson-btn">Отмена</button>
                <button type="submit" class="btn-primary" id="submit-lesson-btn">Добавить</button>
            </div>
        </form>
    </div>
</div>

<!-- ========================================================== -->
<!-- === НОВОЕ МОДАЛЬНОЕ ОКНО ДЛЯ ДЕТАЛЕЙ ПО КЛАССУ (вставить в конце файла, перед ) === -->
<!-- ========================================================== -->
<div class="modal-overlay" id="student-details-modal-overlay" style="display: none;">
    <div class="modal-container modal-lg"> <!-- Добавлен класс modal-lg для ширины -->
        <button class="close-btn" id="close-student-details-modal-btn">&times;</button>
        <div class="modal-header">
            <h2 id="modal-class-name">Успеваемость класса</h2>
            <p>Детальная информация по каждому ученику</p>
        </div>
        
        <div class="table-wrapper" style="max-height: 60vh; overflow-y: auto;">
            <!-- Спиннер для индикации загрузки -->
            <div id="modal-loader" style="text-align: center; padding: 40px; display: none;">
                <i class="fas fa-spinner fa-spin fa-3x"></i>
                <p>Загрузка данных...</p>
            </div>

            <table class="data-table">
                <thead>
                    <tr>
                        <th>ФИО Ученика</th>
                        <th>Средний балл</th>
                        <th>Посещаемость</th>
                    </tr>
                </thead>
                <tbody id="student-details-tbody">
                    <!-- Данные будут вставлены сюда с помощью JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="modal-footer">
            <button type="button" class="btn-secondary" id="cancel-student-details-btn">Закрыть</button>
        </div>
    </div>
</div>

<!-- === МОДАЛЬНОЕ ОКНО ДЛЯ ПРОСМОТРА ПЛАНА === -->
<div class="modal-overlay" id="plan-view-modal" style="display: none;">
    <div class="modal-container">
        <button class="close-btn">&times;</button>
        <div class="modal-header">
            <h6 id="view-plan-title">Просмотр поурочного плана<h6>
            <p>
                <span id="view-plan-class"></span> • 
                <span id="view-plan-subject"></span> • 
                <span id="view-plan-date"></span>
            </p>
        </div>
        <dl class="lp-view-details">
            <dt>Тема урока</dt>
            <dd id="view-plan-topic"></dd>
            
            <dt>Цели и задачи</dt>
            <dd id="view-plan-goals"></dd>
            
            <dt>Учебные материалы</dt>
            <dd id="view-plan-materials">
                <a href="#" id="view-plan-materials-link" target="_blank" class="file-link" style="display: none;">
                    <i class="fa-solid fa-paperclip"></i> 
                    <span></span>
                </a>
                <span id="no-materials-file" style="color: var(--text-secondary);">Файл не прикреплен</span>
            </dd>
        </dl>
        <div class="modal-footer">
            <button type="button" class="btn-secondary close-btn">Закрыть</button>
        </div>
    </div>
</div>

{% endblock %}



{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '{{ csrf_token }}';

    // --- БЛОК 1: ГЛАВНОЕ УПРАВЛЕНИЕ ВКЛАДКАМИ ---
    const navLinks = document.querySelectorAll('.main-nav a[data-page="headteacher"]');
    const tabContents = document.querySelectorAll('.tab-content');

    function switchTab(tabName) {
        navLinks.forEach(link => link.classList.toggle('active', link.dataset.tab === tabName));
        tabContents.forEach(content => content.classList.toggle('active', content.id === tabName + '-content'));
        window.history.pushState({tab: tabName}, '', `?tab=${tabName}`);
    }

    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            switchTab(this.dataset.tab);
        });
    });

    // Активируем нужную вкладку при загрузке страницы, основываясь на URL
    const initialTab = new URLSearchParams(window.location.search).get('tab') || 'performance';
    switchTab(initialTab);
    

    const plansTableBody = document.getElementById('plans-table-body');
    if (plansTableBody) {
        // Находим модальное окно для просмотра и его элементы
        const planViewModal = document.getElementById('plan-view-modal');
        const planViewTitle = document.getElementById('view-plan-title');
        const planViewClass = document.getElementById('view-plan-class');
        const planViewSubject = document.getElementById('view-plan-subject');
        const planViewDate = document.getElementById('view-plan-date');
        const planViewTopic = document.getElementById('view-plan-topic');
        const planViewGoals = document.getElementById('view-plan-goals');
        const planViewMaterialsLink = document.getElementById('view-plan-materials-link');
        const planViewNoFile = document.getElementById('no-materials-file');

        // Логика закрытия модального окна просмотра
        planViewModal.querySelectorAll('.close-btn').forEach(btn => {
            btn.addEventListener('click', () => planViewModal.style.display = 'none');
        });
        planViewModal.addEventListener('click', (e) => {
            if (e.target === planViewModal) planViewModal.style.display = 'none';
        });

        plansTableBody.addEventListener('click', async function(e) {
            const viewBtn = e.target.closest('.action-btn.view');
            const approveBtn = e.target.closest('.action-btn.approve');
            const rejectBtn = e.target.closest('.action-btn.reject');
            
            // --- НОВАЯ ЛОГИКА: Обработка клика по кнопке "Просмотреть" ---
            if (viewBtn) {
                const planId = viewBtn.dataset.planId;
                try {
                    const response = await fetch(`/api/lesson-plans/${planId}/details/`);
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);

                    const data = result.data;
                    const planRow = document.getElementById(`plan-row-${planId}`);

                    // Заполняем модальное окно данными
                    planViewTitle.textContent = data.name;
                    planViewClass.textContent = planRow.cells[2].textContent; // Берем из таблицы для простоты
                    planViewSubject.textContent = planRow.cells[3].textContent; // Берем из таблицы
                    planViewDate.textContent = data.date;
                    planViewTopic.textContent = data.topic || 'Не указана';
                    planViewGoals.textContent = data.goals_and_objectives || 'Не указаны';
                    
                    // Обрабатываем ссылку на прикрепленный файл
                    if (data.learning_materials_url) {
                        planViewMaterialsLink.href = data.learning_materials_url;
                        planViewMaterialsLink.querySelector('span').textContent = data.learning_materials_name;
                        planViewMaterialsLink.style.display = 'inline-flex';
                        planViewNoFile.style.display = 'none';
                    } else {
                        planViewMaterialsLink.style.display = 'none';
                        planViewNoFile.style.display = 'inline';
                    }

                    planViewModal.style.display = 'flex'; // Показываем модальное окно
                } catch (error) {
                    console.error('Ошибка загрузки плана:', error);
                    alert('Не удалось загрузить детали плана.');
                }
                return; // Завершаем выполнение, чтобы не сработал другой код
            }

            // --- Существующая логика для утверждения/отклонения ---
            let action = null;
            let planId = null;

            if (approveBtn) {
                action = 'approve';
                planId = approveBtn.dataset.planId;
            } else if (rejectBtn) {
                action = 'reject';
                planId = rejectBtn.dataset.planId;
            }

            if (!action || !planId) return; 

            try {
                const response = await fetch(`/api/lesson-plans/${planId}/update-status/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                    body: JSON.stringify({ action: action })
                });
                const result = await response.json();

                if (response.ok && result.status === 'success') {
                     const row = document.getElementById(`plan-row-${planId}`);
                    if (row) {
                        row.style.opacity = '0';
                        setTimeout(() => location.reload(), 400); 
                    }
                } else {
                    alert('Ошибка: ' + (result.message || 'Не удалось выполнить действие'));
                }
            } catch (error) {
                console.error('Ошибка при отправке запроса:', error);
                alert('Произошла сетевая ошибка.');
            }
        });
    }


    // --- БЛОК 3: ЛОГИКА ВКЛАДКИ "УСПЕВАЕМОСТЬ" (МОДАЛЬНОЕ ОКНО) ---
    const studentDetailsModal = document.getElementById('student-details-modal-overlay');
    if(studentDetailsModal) {
        const modalTbody = document.getElementById('student-details-tbody');
        const modalTitle = document.getElementById('modal-class-name');
        const modalLoader = document.getElementById('modal-loader');
        
        const openModal = () => studentDetailsModal.style.display = 'flex';
        const closeModal = () => {
            studentDetailsModal.style.display = 'none';
            modalTbody.innerHTML = ''; // Очищаем таблицу при закрытии
        };

        document.getElementById('close-student-details-modal-btn').addEventListener('click', closeModal);
        document.getElementById('cancel-student-details-btn').addEventListener('click', closeModal);
        studentDetailsModal.addEventListener('click', (e) => {
            if (e.target === studentDetailsModal) closeModal();
        });

        document.querySelectorAll('.class-details-link').forEach(link => {
            link.addEventListener('click', async (e) => {
                e.preventDefault();
                const classId = e.currentTarget.dataset.classId;
                
                openModal();
                modalLoader.style.display = 'block';
                modalTbody.style.display = 'none';
                modalTitle.textContent = 'Загрузка...';

                try {
                    const response = await fetch(`/api/class/${classId}/performance/`);
                    if (!response.ok) throw new Error('Ошибка сети или сервера');
                    const data = await response.json();
                    
                    modalTitle.textContent = `Успеваемость класса: ${data.class_name}`;
                    modalTbody.innerHTML = ''; // Очищаем на случай повторного открытия
                    
                    if (data.students && data.students.length > 0) {
                        data.students.forEach(student => {
                            const row = modalTbody.insertRow();
                            row.innerHTML = `
                                <td><strong>${student.full_name}</strong></td>
                                <td style="text-align: right;">${student.avg_grade}</td>
                                <td style="text-align: right;">${student.attendance_percentage}%</td>
                            `;
                        });
                    } else {
                        modalTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 24px;">В этом классе нет учеников.</td></tr>';
                    }

                } catch (error) {
                    console.error("Ошибка при загрузке данных о классе:", error);
                    modalTbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 24px; color: red;">Не удалось загрузить данные.</td></tr>';
                } finally {
                    modalLoader.style.display = 'none';
                    modalTbody.style.display = '';
                }
            });
        });
    }

    
    // --- БЛОК 4: ЛОГИКА ВКЛАДКИ "РАСПИСАНИЕ" ---
    const scheduleContent = document.getElementById('schedule-content');
    if (scheduleContent) {
        // --- 4.1. Фильтры ---
        const schoolSelect = document.getElementById('school-select');
        const classSelect = document.getElementById('class-select');
        const scheduleFilterForm = document.getElementById('schedule-filter-form');

        schoolSelect.addEventListener('change', async function() {
            const schoolId = this.value;
            // При смене школы просто отправляем форму. 
            // Django сам отрендерит пустой список классов.
            scheduleFilterForm.submit(); 
        });

        // ИСПРАВЛЕНО: Правильно обрабатываем событие смены класса
        classSelect.addEventListener('change', function() {
            if (this.value) { // Если выбран какой-то класс (не пустой)
                scheduleFilterForm.submit();
            }
        });

        // --- 4.2. Модальное окно и CRUD (Создание, Редактирование, Удаление) ---
        const lessonModal = document.getElementById('lesson-modal-overlay');
        if (lessonModal) {
            // Находим все элементы модального окна один раз
            const modalTitle = document.getElementById('lesson-modal-title');
            const modalSubtitle = document.getElementById('lesson-modal-subtitle');
            const lessonForm = document.getElementById('lesson-form');
            const submitBtn = document.getElementById('submit-lesson-btn');
            const scheduleIdInput = document.getElementById('id_schedule_id');
            const dayOfWeekInput = document.getElementById('id_day_of_week');

            // Функции для открытия и закрытия модального окна
            const openLessonModal = () => lessonModal.style.display = 'flex';
            const closeLessonModal = () => lessonModal.style.display = 'none';

            // Назначаем события на кнопки закрытия
            document.getElementById('close-lesson-modal-btn').addEventListener('click', closeLessonModal);
            document.getElementById('cancel-lesson-btn').addEventListener('click', closeLessonModal);

            // ИСПОЛЬЗУЕМ ДЕЛЕГИРОВАНИЕ СОБЫТИЙ
            // Один обработчик на весь контейнер расписания
            scheduleContent.addEventListener('click', async function(e) {
                const addBtn = e.target.closest('.add-lesson-to-day-btn');
                const editBtn = e.target.closest('.edit-lesson-btn');
                const deleteBtn = e.target.closest('.delete-lesson-btn');

                // --- Действие: ДОБАВИТЬ урок ---
                if (addBtn) {
                    lessonForm.reset();
                    scheduleIdInput.value = '';
                    dayOfWeekInput.value = addBtn.dataset.dayId;
                    modalTitle.textContent = 'Добавить урок';
                    const selectedClassText = classSelect.options[classSelect.selectedIndex].text;
                    modalSubtitle.textContent = `${addBtn.dataset.dayName}, ${selectedClassText}`;
                    submitBtn.textContent = 'Добавить';
                    openLessonModal();
                    return; // Завершаем выполнение
                }

                // --- Действие: РЕДАКТИРОВАТЬ урок ---
                if (editBtn) {
                    const lessonCard = editBtn.closest('.lesson-card');
                    const lessonId = lessonCard.dataset.lessonId;
                    
                    try {
                        const response = await fetch(`/api/schedule/${lessonId}/details/`);
                        if (!response.ok) throw new Error('Failed to fetch details');
                        const data = await response.json();
                        
                        lessonForm.reset();
                        scheduleIdInput.value = data.id;
                        dayOfWeekInput.value = data.day_of_week;
                        document.getElementById('id_start_time').value = data.start_time;
                        document.getElementById('id_end_time').value = data.end_time;
                        document.getElementById('id_subject').value = data.subject;
                        document.getElementById('id_teacher').value = data.teacher;
                        document.getElementById('id_classroom').value = data.classroom;
                        
                        modalTitle.textContent = 'Редактировать урок';
                        modalSubtitle.textContent = 'Измените данные урока';
                        submitBtn.textContent = 'Сохранить';
                        openLessonModal();
                    } catch (error) {
                        console.error(error);
                        alert('Не удалось загрузить данные урока.');
                    }
                    return;
                }

                // --- Действие: УДАЛИТЬ урок ---
                if (deleteBtn) {
                    if (confirm('Вы уверены, что хотите удалить этот урок?')) {
                        const lessonCard = deleteBtn.closest('.lesson-card');
                        const lessonId = lessonCard.dataset.lessonId;
                        
                        try {
                            const response = await fetch(`/api/schedule/${lessonId}/delete/`, {
                                method: 'POST',
                                headers: {'X-CSRFToken': csrfToken}
                            });
                            if (response.ok) {
                                lessonCard.remove(); // Удаляем элемент со страницы
                            } else {
                                alert('Не удалось удалить урок.');
                            }
                        } catch (error) {
                            console.error(error);
                            alert('Произошла ошибка при удалении.');
                        }
                    }
                }
            });
            
            // Обработчик отправки формы (остается без изменений)
            lessonForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const response = await fetch("{% url 'api_manage_schedule_item' %}", {
                    method: 'POST',
                    body: new FormData(lessonForm),
                    headers: { 'X-CSRFToken': csrfToken }
                });
                
                if (response.ok) {
                    location.reload();
                } else {
                    const result = await response.json();
                    const errorMessages = Object.values(result.errors).map(err => `- ${err[0]}`).join('\n');
                    alert('Ошибка валидации:\n' + errorMessages);
                }
            });
        }
    }
});
</script>
{% endblock %}