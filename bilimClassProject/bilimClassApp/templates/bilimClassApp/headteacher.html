{% extends "bilimClassApp/base_dashboard.html" %}
{% load static %}
{% load custom_filters %} {# Загрузка кастомного фильтра #}

{% block title %}Расписание школы{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/schedule_head_school.css' %}">
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h2><i class="fa-solid fa-calendar-days"></i> Управление расписанием школы</h2>
        <p>Создание и редактирование расписания для всех классов</p>
    </div>
</div>

<div class="content-card">
    <form method="GET" action="{% url 'headteacher' %}" id="schedule-filter-form" class="filters-toolbar">
        <div class="filter-group">
            <label for="school-select">Школа</label>
            <select name="school_id" id="school-select" class="filter-select">
                <option value="">-- Выберите школу --</option>
                {% for school in all_schools %}
                    <option value="{{ school.id }}" {% if school.id == selected_school_id %}selected{% endif %}>
                        {{ school.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="filter-group">
            <label for="class-select">Класс</label>
            <select name="class_id" id="class-select" class="filter-select" {% if not selected_school_id %}disabled{% endif %}>
                <option value="">-- Сначала выберите школу --</option>
                {% for s_class in classes_in_school %}
                     <option value="{{ s_class.id }}" {% if s_class.id == selected_class_id %}selected{% endif %}>
                        {{ s_class.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>
    
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab-button active">Расписание</button>
        </div>
    </div>
    
    <div id="schedule-content">
        {% if selected_class_id %}
            <div class="schedule-grid">
                {% for day_id, day_name in days_of_week.items %}
                    <div class="day-column">
                        <div class="day-header">
                            <h3>{{ day_name }}</h3>
                            <button class="add-lesson-to-day-btn" data-day-id="{{ day_id }}" data-day-name="{{ day_name }}" title="Добавить урок">+</button>
                        </div>
                        <div class="lessons-list">
                            {% for lesson in schedule_by_day|get_item:day_id %}
                                <div class="lesson-card" data-lesson-id="{{ lesson.id }}">
                                    <div class="lesson-time">{{ lesson.start_time|time:"H:i" }} - {{ lesson.end_time|time:"H:i" }}</div>
                                    <div class="lesson-subject">{{ lesson.subject.name }}</div>
                                    <div class="lesson-teacher">{{ lesson.teacher.user.get_full_name|default:"Не назначен" }}</div>
                                    <div class="lesson-classroom">Каб. {{ lesson.classroom|default:"-" }}</div>
                                    
                                    <!-- Вот эти кнопки и их классы важны для JavaScript -->
                                    <div class="lesson-actions">
                                        <button class="edit-lesson-btn" title="Редактировать"><i class="fa-solid fa-pencil"></i></button>
                                        <button class="delete-lesson-btn" title="Удалить"><i class="fa-solid fa-trash-can"></i></button>
                                    </div>
                                </div>
                            {% empty %}
                                <p class="no-lessons">Нет уроков</p>
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="placeholder">
                <i class="fa-regular fa-calendar-check"></i>
                <p>Пожалуйста, выберите школу и класс, чтобы увидеть расписание.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block modals %}
<!-- ===================================================================== -->
<!-- === МОДАЛЬНОЕ ОКНО ДЛЯ ДОБАВЛЕНИЯ/РЕДАКТИРОВАНИЯ УРОКА === -->
<!-- ===================================================================== -->
<div class="modal-overlay" id="lesson-modal-overlay">
    <div class="modal-container">
        <button class="modal-close-btn" id="close-lesson-modal-btn">&times;</button>
        <div class="modal-header">
            <h2 id="lesson-modal-title">Добавить урок</h2>
            <p id="lesson-modal-subtitle">Заполните информацию об уроке</p>
        </div>
        
        <form id="lesson-form" class="modal-form" novalidate>
            {% csrf_token %}
            <!-- Скрытые поля для отправки на сервер -->
            <input type="hidden" name="schedule_id" id="id_schedule_id">
            <input type="hidden" name="school_class_id" value="{{ selected_class_id }}">
            <input type="hidden" name="school_id" value="{{ selected_school_id }}">
            <input type="hidden" name="day_of_week" id="id_day_of_week">
            
            <div class="form-grid">
                <div class="form-group">
                    {{ schedule_form.start_time.label_tag }}
                    {{ schedule_form.start_time }}
                </div>
                <div class="form-group">
                    {{ schedule_form.end_time.label_tag }}
                    {{ schedule_form.end_time }}
                </div>
            </div>

            <div class="form-group">
                {{ schedule_form.subject.label_tag }}
                {{ schedule_form.subject }}
            </div>
            <div class="form-group">
                {{ schedule_form.teacher.label_tag }}
                {{ schedule_form.teacher }}
            </div>
            <div class="form-group">
                {{ schedule_form.classroom.label_tag }}
                {{ schedule_form.classroom }}
            </div>

            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancel-lesson-btn">Отмена</button>
                <button type="submit" class="btn-primary" id="submit-lesson-btn">Добавить</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- БЛОК 1: УПРАВЛЕНИЕ ФИЛЬТРАМИ (ШКОЛА И КЛАСС) ---
    const schoolSelect = document.getElementById('school-select');
    const classSelect = document.getElementById('class-select');
    const filterForm = document.getElementById('schedule-filter-form');

    schoolSelect.addEventListener('change', async function() {
        const schoolId = this.value;
        classSelect.innerHTML = '<option value="">Загрузка...</option>';
        classSelect.disabled = true;

        if (schoolId) {
            try {
                const response = await fetch(`/api/school/${schoolId}/classes/`);
                if (!response.ok) throw new Error('Network response was not ok');
                const classes = await response.json();
                
                classSelect.innerHTML = '<option value="">-- Выберите класс --</option>';
                classes.forEach(function(s_class) {
                    const option = new Option(s_class.name, s_class.id);
                    classSelect.add(option);
                });
                classSelect.disabled = false;
            } catch (error) {
                console.error('Failed to fetch classes:', error);
                classSelect.innerHTML = '<option value="">Ошибка загрузки</option>';
            }
        } else {
            classSelect.innerHTML = '<option value="">-- Сначала выберите школу --</option>';
        }
    });

    classSelect.addEventListener('change', function() {
        if (this.value) {
            filterForm.submit();
        }
    });

    // --- БЛОК 2: УПРАВЛЕНИЕ МОДАЛЬНЫМ ОКНОМ УРОКА ---
    const modalOverlay = document.getElementById('lesson-modal-overlay');
    if (modalOverlay) {
        const modalTitle = document.getElementById('lesson-modal-title');
        const modalSubtitle = document.getElementById('lesson-modal-subtitle');
        const lessonForm = document.getElementById('lesson-form');
        const submitBtn = document.getElementById('submit-lesson-btn');
        const scheduleIdInput = document.getElementById('id_schedule_id');
        const dayOfWeekInput = document.getElementById('id_day_of_week');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const openModal = () => modalOverlay.style.display = 'flex';
        const closeModal = () => modalOverlay.style.display = 'none';

        document.getElementById('close-lesson-modal-btn').addEventListener('click', closeModal);
        document.getElementById('cancel-lesson-btn').addEventListener('click', closeModal);

        // Открытие модального окна для СОЗДАНИЯ урока
        document.querySelectorAll('.add-lesson-to-day-btn').forEach(button => {
            button.addEventListener('click', () => {
                lessonForm.reset();
                scheduleIdInput.value = '';
                dayOfWeekInput.value = button.dataset.dayId;
                
                modalTitle.textContent = 'Добавить урок';
                const selectedClassText = document.querySelector("#class-select option:checked").textContent.trim();
                modalSubtitle.textContent = `${button.dataset.dayName}, ${selectedClassText}`;
                submitBtn.textContent = 'Добавить';
                
                openModal();
            });
        });

        // Открытие модального окна для РЕДАКТИРОВАНИЯ урока
        document.querySelectorAll('.edit-lesson-btn').forEach(button => {
            button.addEventListener('click', async () => {
                const lessonCard = button.closest('.lesson-card');
                const lessonId = lessonCard.dataset.lessonId;
                
                const response = await fetch(`/api/schedule/${lessonId}/details/`);
                if (response.ok) {
                    const data = await response.json();
                    lessonForm.reset();
                    scheduleIdInput.value = data.id;

                    // === ИЗМЕНЕНИЕ ЗДЕСЬ: УСТАНАВЛИВАЕМ ЗНАЧЕНИЕ ДЛЯ СКРЫТОГО ПОЛЯ ===
                    dayOfWeekInput.value = data.day_of_week; 
                    // ================================================================
                    
                    document.getElementById('id_start_time').value = data.start_time;
                    document.getElementById('id_end_time').value = data.end_time;
                    document.getElementById('id_subject').value = data.subject;
                    document.getElementById('id_teacher').value = data.teacher;
                    document.getElementById('id_classroom').value = data.classroom;
                    
                    modalTitle.textContent = 'Редактировать урок';
                    modalSubtitle.textContent = 'Измените данные урока';
                    submitBtn.textContent = 'Сохранить';
                    
                    openModal();
                } else {
                    alert('Не удалось загрузить данные урока.');
                }
            });
        });
        
        // Обработка отправки формы
        lessonForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(lessonForm);
            const response = await fetch("{% url 'api_manage_schedule_item' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            });
            
            if (response.ok) {
                location.reload();
            } else {
                const result = await response.json();
                const errorMessages = Object.values(result.errors).map(err => err[0]).join('\n');
                alert('Ошибка валидации:\n' + errorMessages);
            }
        });

        // Удаление урока
        document.querySelectorAll('.delete-lesson-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                e.preventDefault();
                if (confirm('Вы уверены, что хотите удалить этот урок?')) {
                    const lessonCard = button.closest('.lesson-card');
                    const lessonId = lessonCard.dataset.lessonId;
                    
                    const response = await fetch(`/api/schedule/${lessonId}/delete/`, {
                        method: 'POST',
                        headers: {'X-CSRFToken': csrfToken}
                    });

                    if (response.ok) {
                        lessonCard.remove();
                    } else {
                        alert('Не удалось удалить урок.');
                    }
                }
            });
        });
    }
});
</script>
{% endblock %}