<!-- bilimClassApp/templates/bilimClassApp/journal_view.html (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø) -->
{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –ñ—É—Ä–Ω–∞–ª - Bilim Class</title>
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body class="td-body">

<div class="td-container">
    <header class="td-header">
        <div class="td-logo-section">
            <div class="td-logo-icon">üéì</div>
            <div><h1>–®–∫–æ–ª—å–Ω–∞—è–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</h1><p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—á–µ–±–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º</p></div>
        </div>
        <div class="td-user-section">
            <div class="td-user-info">
                <h3>{{ request.user.get_full_name }}</h3><p>–£—á–∏—Ç–µ–ª—å</p>
            </div>
            <div class="td-user-avatar">{{ request.user.first_name|first }}{{ request.user.last_name|first }}</div>
        </div>
    </header>

    <main>
        <nav class="td-main-nav">
             <ul>
                <li><a href="{% url 'teacher_dashboard' %}"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
                <li><a href="#"><i class="fas fa-tasks"></i> –ü–æ—É—Ä–æ—á–Ω—ã–µ –ø–ª–∞–Ω—ã</a></li>
                <li class="active"><a href="{% url 'teacher_journal' %}"><i class="fas fa-book"></i> –ñ—É—Ä–Ω–∞–ª</a></li>
                <li><a href="#"><i class="fas fa-pencil-alt"></i> –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a></li>
                <li><a href="#"><i class="far fa-calendar-alt"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a></li>
            </ul>
        </nav>
        
        <section class="td-card journal-section">
            <div class="journal-controls">
                <div class="journal-header">
                    <i class="fas fa-book-open"></i>
                    <div>
                        <h3>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª</h3><p>–û—Ü–µ–Ω–∫–∏ –∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å —É—á–∞—â–∏—Ö—Å—è</p>
                    </div>
                </div>
                <div class="journal-filters">
                    <select id="class-select" class="td-form-select">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å --</option>
                        {% for class in teacher_classes %}
                        <option value="{{ class.pk }}">{{ class.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="journal-view-tabs">
                <button class="journal-tab-btn active" data-view="grades">–û—Ü–µ–Ω–∫–∏</button>
                <button class="journal-tab-btn" data-view="attendance">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</button>
            </div>
            
            <div id="journal-grid-container" class="journal-grid-container">
                <p class="td-empty-message">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∂—É—Ä–Ω–∞–ª.</p>
            </div>
        </section>
    </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. –ù–∞—Ö–æ–¥–∏–º —Ç–æ–ª—å–∫–æ —Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ—á–Ω–æ –µ—Å—Ç—å –≤ –≤–∞—à–µ–º HTML ---
    const classSelect = document.getElementById('class-select');
    const gridContainer = document.getElementById('journal-grid-container');
    const tabButtons = document.querySelectorAll('.journal-tab-btn');
    
    let currentView = 'grades';
    let lastLoadedData = null; // –ö—ç—à –¥–ª—è –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å –ø—Ä–∏ —Å–º–µ–Ω–µ –≤–∫–ª–∞–¥–æ–∫

    // --- 2. –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¢–û–õ–¨–ö–û –Ω–∞ –≤—ã–±–æ—Ä –∫–ª–∞—Å—Å–∞ ---
    classSelect.addEventListener('change', tryLoadJournalData);

    // --- 3. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ (–û—Ü–µ–Ω–∫–∏/–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å) ---
    tabButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            currentView = btn.dataset.view;
            tabButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –±—ã–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –∏—Ö
            if (lastLoadedData) {
                renderJournal();
            }
        });
    });

    // --- 4. –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è —Ä–µ—à–∞–µ—Ç, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ª–∏ –∑–∞–ø—Ä–æ—Å ---
    function tryLoadJournalData() {
        const classId = classSelect.value;

        // === –ì–õ–ê–í–ù–û–ï –£–°–õ–û–í–ò–ï: –ï–°–õ–ò –ö–õ–ê–°–° –ù–ï –í–´–ë–†–ê–ù - –ù–ï –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ó–ê–ü–†–û–° ===
        if (!classId) {
            gridContainer.innerHTML = '<p class="td-empty-message">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å, —á—Ç–æ–±—ã –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å –∂—É—Ä–Ω–∞–ª.</p>';
            lastLoadedData = null; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—ç—à
            return; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
        }

        // –ï—Å–ª–∏ –∫–ª–∞—Å—Å –≤—ã–±—Ä–∞–Ω, –≤—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏
        fetchJournalData(classId);
    }

    // --- 5. –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç AJAX-–∑–∞–ø—Ä–æ—Å ---
    async function fetchJournalData(classId) {
        gridContainer.innerHTML = '<p class="td-empty-message">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p>';
        try {
            const response = await fetch(`/api/journal-grid-data/?class_id=${classId}`);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
            lastLoadedData = await response.json(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –∫—ç—à
            renderJournal(); // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
        } catch (error) {
            gridContainer.innerHTML = `<p class="td-empty-message" style="color:red;">–û—à–∏–±–∫–∞: ${error.message}</p>`;
            lastLoadedData = null;
        }
    }
    
    // --- 6. –§—É–Ω–∫—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –æ—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ---
    function renderJournal() {
        if (!lastLoadedData || lastLoadedData.students.length === 0) {
            gridContainer.innerHTML = '<p class="td-empty-message">–í —ç—Ç–æ–º –∫–ª–∞—Å—Å–µ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤.</p>';
            return;
        }
        
        // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏, –≤—ã–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
        if (currentView === 'grades') {
            renderGradesView();
        } else {
            renderAttendanceView();
        }
    }

    // --- –§—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    function renderGradesView() {
        // ... –≤–∞—à –∫–æ–¥ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –æ—Ü–µ–Ω–æ–∫ ...
        let tableHtml = '<table class="journal-table"><thead><tr><th>–£—á–µ–Ω–∏–∫</th>';
        const formattedDates = lastLoadedData.dates.map(d => new Date(d).toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit'}));
        formattedDates.forEach(d => { tableHtml += `<th>${d}</th>`; });
        tableHtml += '<th>–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª</th></tr></thead><tbody>';
        
        lastLoadedData.students.forEach(student => {
            const studentGrades = lastLoadedData.grades_data[student.id];
            tableHtml += `<tr><td>${student.full_name}</td>`;
            lastLoadedData.dates.forEach(dateISO => {
                const gradeInfo = studentGrades[dateISO];
                let cellClass = 'journal-grade-cell';
                let gradeVal = '+';
                
                if (gradeInfo.was_absent) {
                    gradeVal = '–ù';
                    cellClass += ' bad';
                } else if (gradeInfo.grade !== null) {
                    gradeVal = gradeInfo.grade;
                    if(gradeVal >= 85) cellClass += ' good';
                    else if (gradeVal >= 70) cellClass += ' medium';
                    else cellClass += ' bad';
                }
                
                tableHtml += `<td class="${cellClass}">${gradeVal}</td>`;
            });
            tableHtml += `<td><b>${studentGrades.avg_grade}</b></td></tr>`;
        });
        tableHtml += '</tbody></table>';
        gridContainer.innerHTML = tableHtml;
    }

    function renderAttendanceView() {
        // ... –≤–∞—à –∫–æ–¥ –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç–∏ ...
        let tableHtml = '<table class="journal-table"><thead><tr><th>–£—á–µ–Ω–∏–∫</th>';
        const formattedDates = lastLoadedData.dates.map(d => new Date(d).toLocaleDateString('ru-RU', {day: '2-digit', month: '2-digit'}));
        formattedDates.forEach(d => { tableHtml += `<th>${d}</th>`; });
        tableHtml += '<th>–ü—Ä–æ—Ü–µ–Ω—Ç</th></tr></thead><tbody>';

        lastLoadedData.students.forEach(student => {
            const studentAttendance = lastLoadedData.attendance_data[student.id];
            tableHtml += `<tr><td>${student.full_name}</td>`;
            lastLoadedData.dates.forEach(dateISO => {
                const status = studentAttendance[dateISO];
                let cellClass = 'journal-attendance-cell';
                let icon = '<i class="fas fa-check"></i>';
                
                if (status === 'truant' || status === 'valid') {
                    cellClass += ' absent';
                    icon = '<i class="fas fa-times"></i>';
                } else if (status === 'late') {
                    icon = '<i class="fas fa-clock"></i>';
                }
                
                tableHtml += `<td class="${cellClass}">${icon}</td>`;
            });
            tableHtml += `<td><b>${studentAttendance.percentage}%</b></td></tr>`;
        });
        tableHtml += '</tbody></table>';
        gridContainer.innerHTML = tableHtml;
    }
});
</script>
</body>
</html>