{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Школьная Платформа - Профиль</title>

    <!-- Подключаем иконки Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- Подключаем шрифты (рекомендуется для консистентности) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- ===================================================================== -->
    <!-- === ОСНОВНЫЕ СТИЛИ (ОБЪЕДИНЕНЫ И ПЕРЕРАБОТАНЫ) === -->
    <!-- ===================================================================== -->
    <style>
        /* --- Корневые переменные --- */
        :root {
            --bg-main: #F9FAFB;
            --bg-widget: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --accent-primary: #4F46E5;
            --accent-primary-light: rgba(79, 70, 229, 0.1);
            --accent-purple: #8B5CF6;
            --accent-red: #EF4444;
            --accent-green: #10B981;
            --accent-green-bg: #D1FAE5;
            --accent-green-text: #065F46;
            --accent-red-bg: #FEE2E2;
            --accent-red-text: #991B1B;
            --widget-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --header-shadow: 0 4px 12px rgba(16, 24, 40, 0.04);
        }

        /* --- Базовые стили --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background-color: var(--bg-main);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1280px; /* Увеличили максимальную ширину для десктопа */
            margin: 0 auto;
            padding: 24px;
        }

        /* --- Стили для шапки (Header) --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-widget);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--header-shadow);
            margin-bottom: 32px; /* Увеличили отступ */
        }
        .header-logo { display: flex; align-items: center; gap: 14px; }
        .header-logo-icon { width: 44px; height: 44px; background-color: var(--accent-primary); border-radius: 10px; color: white; display: grid; place-items: center; font-size: 20px; }
        .header-logo h1 { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
        .header-logo p { font-size: 13px; color: var(--text-secondary); }
        .header-user { display: flex; align-items: center; gap: 16px; }
        .header-user-info h3 { font-weight: 600; font-size: 15px; text-align: right; }
        .header-user-link { text-decoration: none; color: inherit; }
        .header-user-avatar { width: 44px; height: 44px; border-radius: 10px; background-color: #D8B4FE; color: #581C87; display: grid; place-items: center; font-weight: 600; font-size: 16px; }

        /* --- ОСНОВНАЯ СЕТКА ДЛЯ ДЕСКТОПА --- */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Две равные колонки */
            gap: 32px; /* Пространство между колонками */
            align-items: start; /* Выравнивание блоков по верху */
        }

        /* --- Стили для карточек с формами --- */
        .form-card {
            background-color: var(--bg-widget);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--widget-shadow);
        }

        .form-card h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color); /* Визуальный разделитель */
        }

        /* --- Стили для полей формы --- */
        .form-card form p {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .form-card form label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }

        .logout {
            display: flex;
            justify-self: end;
            font-size: 14px;
            color: gray;
        }

        .form-card form input[type="text"],
        .form-card form input[type="email"],
        .form-card form input[type="password"],
        .form-card form input[type="date"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            color: var(--text-primary);
            background-color: var(--bg-main);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-card form input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-primary-light);
        }

        /* --- Стили для кнопок --- */
        .form-card button[type="submit"] {
            width: 100%;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            /* background-image: linear-gradient(to right, var(--accent-primary) 0%, var(--accent-purple) 100%); */
            background-color: #4F46E5;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2);
            transition: all 0.2s ease-in-out;
            margin-top: 10px;
        }
        .form-card button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3);
        }

        /* --- Стили для сообщений и ошибок --- */
        .message-box, .error-box {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message-box {
            background-color: var(--accent-green-bg);
            color: var(--accent-green-text);
            border: 1px solid var(--accent-green-text);
        }

        .error-box {
            color: var(--accent-red-text);
            background-color: var(--accent-red-bg);
            border: 1px solid var(--accent-red-text);
        }
        .error-box ul {
            margin: 0;
            padding-left: 20px;
        }

        #logout_form {
            display: none;
        }

        /* Вспомогательный класс для скрытия */
        .hidden {
            display: none;
        }
        
        /* Стили для подсказок в форме пароля */
        #password-form ul {
            margin-left: 7%;
            color: var(--text-secondary);
            font-size: 13px;
        }
        #password-form ul li { margin-bottom: 5px; }


        #profile-form textarea {
            border-radius: 10px;
        }

        input {
            border-color: #ccc !important;
        }


        /* ===================================================================
           АДАПТИВНЫЕ СТИЛИ (ПЛАНШЕТЫ И МОБИЛЬНЫЕ)
        =================================================================== */
        @media (max-width: 992px) {
            /* Переключаемся на одноколоночный макет для планшетов */
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {

            #logout_form {
                display: flex;
                width: 100%;
                margin-top: 20px;
            }  

            #logout_form a, button{
                width: 100%;
            }  
            

            .logout {
                display: none;
            }
            .container {
                padding: 16px;
            }
            .page-header {
                padding: 12px 16px;
                margin-bottom: 24px;
            }
            /* Скрываем текст в шапке на мобильных */
            .header-logo p, .header-user-info { display: none; }
            .header-logo h1 { font-size: 16px; }
            .header-logo-icon, .header-user-avatar { width: 40px; height: 40px; }

            .header-user-avatar {
                border-radius: 10px !important;
            }
            
            .form-card {
                padding: 24px;
            }
            .form-card h2 {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ===================================================================== -->
        <!-- === ОБЩАЯ ШАПКА === -->
        <!-- ===================================================================== -->
        <header class="page-header">
            <div class="header-logo">
                <div class="header-logo-icon">🎓</div>
                <div>
                    <h1>Школьная Платформа</h1>
                    <p>Система управления учебным процессом</p>
                </div>
            </div>
            <div class="header-user">
                <div class="header-user-info">
                    <a href="{% url 'profile' %}" class="header-user-link">
                        <h3 id="header-user-fullname">{{ user.get_full_name }}</h3>
                    </a>
                    <a class="logout" href="{% url 'logout' %}" class="header-user-link">
                        Выйти
                    </a>
                </div>
                <a href="{% url 'profile' %}" class="header-user-link">
                    <div class="header-user-avatar" id="header-user-initials">{{ user.first_name|first }}{{ user.last_name|first }}</div>
                </a>
            </div>
        </header>

        <!-- Основной контент страницы -->
        <main>
            <!-- Обертка для сеточного макета -->
            <div class="profile-grid">
                
                <!-- Левая колонка -->
                <div class="grid-column">
                    <div class="form-card">
                        <h2>Редактирование профиля</h2>
                        <div id="profile-message-container" class="message-box hidden"></div>
                        <div id="profile-errors-list" class="error-box hidden"></div>
                        
                        <form id="profile-form" method="post" novalidate>
                            {% csrf_token %}
                            {{ form.as_p }}
                            <button type="submit">Сохранить изменения</button>
                        </form>
                    </div>

                    <div class="form-card" style="margin-top: 32px;">
                        <h2>Смена имени и фамилии</h2>
                        <div id="name-message-container" class="message-box hidden"></div>
                        <div id="name-errors-list" class="error-box hidden"></div>
                
                        <form id="name-form" method="post" action="{% url 'change_name' %}" novalidate>
                            {% csrf_token %}
                            {{ name_form.as_p }}
                            <button type="submit">Сохранить ФИО</button>
                        </form>
                    </div>
                </div>

                <!-- Правая колонка -->
                <div class="grid-column">
                    <div class="form-card">
                        <h2>Смена пароля</h2>
                        <div id="password-message-container" class="message-box hidden"></div>
                        <div id="password-errors-list" class="error-box hidden"></div>
                
                        <form id="password-form" method="post" action="{% url 'change_password' %}" novalidate>
                            {% csrf_token %}
                            {{ password_form.as_p }}
                            <button type="submit">Изменить пароль</button>
                        </form>
                    </div>

                    <div class="form-card" style="margin-top: 32px;">
                        <h2>Смена Email</h2>
                        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">Текущий email: <strong>{{ user.email|default:"не указан" }}</strong></p>
                        <div id="email-message-container" class="message-box hidden"></div>
                        <div id="email-errors-list" class="error-box hidden"></div>
                
                        <form id="email-form" method="post" action="{% url 'change_email' %}" novalidate>
                            {% csrf_token %}
                            {{ email_form.as_p }}
                            <button type="submit">Изменить Email</button>
                        </form>
                    </div>

                    <div id="logout_form" class="form-card" style="margin-top: 32px;">
                        <a href="{% url 'logout' %}"><button type="submit">Выйти</button></a>
                    </div>
                </div>
                
            </div> <!-- .profile-grid -->
        </main>
    </div> <!-- .container -->
   
    <script>
    // ВАШ JAVASCRIPT КОД ОСТАЕТСЯ ЗДЕСЬ БЕЗ ИЗМЕНЕНИЙ
    // Я внес лишь небольшие правки в классы, чтобы соответствовать новой разметке
    document.addEventListener('DOMContentLoaded', function() {
        
        function handleFormSubmit(formId, url, messageContainerId, errorContainerId, successCallback) {
            const form = document.getElementById(formId);
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                // Очистка старых сообщений
                const messageContainer = document.getElementById(messageContainerId);
                const errorsListContainer = document.getElementById(errorContainerId);
                messageContainer.classList.add('hidden');
                errorsListContainer.classList.add('hidden');
                errorsListContainer.innerHTML = '';

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        messageContainer.textContent = data.message;
                        messageContainer.classList.remove('hidden');
                        form.reset();
                        if (successCallback) {
                            successCallback(data);
                        }
                    } else {
                        errorsListContainer.classList.remove('hidden');
                        const ul = document.createElement('ul');
                        if (data.errors) {
                            for (const field in data.errors) {
                                data.errors[field].forEach(error => {
                                    const li = document.createElement('li');
                                    li.textContent = (typeof error === 'object' && error.message) ? error.message : error;
                                    ul.appendChild(li);
                                });
                            }
                        } else {
                            const li = document.createElement('li');
                            li.textContent = data.message || 'Произошла неизвестная ошибка.';
                            ul.appendChild(li);
                        }
                        errorsListContainer.appendChild(ul);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        }
        
        // Инициализация обработчиков для каждой формы
        handleFormSubmit('profile-form', "{% url 'profile' %}", 'profile-message-container', 'profile-errors-list');
        handleFormSubmit('password-form', "{% url 'change_password' %}", 'password-message-container', 'password-errors-list');
        handleFormSubmit('email-form', "{% url 'change_email' %}", 'email-message-container', 'email-errors-list', (data) => {
            // Перезагрузка страницы для обновления email в тексте
            setTimeout(() => location.reload(), 1500);
        });

        // Отдельный обработчик для формы смены имени с обновлением шапки
        handleFormSubmit('name-form', "{% url 'change_name' %}", 'name-message-container', 'name-errors-list', (data) => {
            if (data.new_full_name) {
                document.getElementById('header-user-fullname').textContent = data.new_full_name;
            }
            if (data.new_initials) {
                document.getElementById('header-user-initials').textContent = data.new_initials;
            }
        });
    });
    </script>
</body>
</html>