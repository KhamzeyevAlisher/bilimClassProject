{% load static %}
<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - Sabaq Saqshy</title>

    <!-- Font Awesome –±–µ–ª–≥—ñ—à–µ–ª–µ—Ä—ñ–Ω “õ–æ—Å—É -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <!-- –®—Ä–∏—Ñ—Ç—Ç–∞—Ä–¥—ã “õ–æ—Å—É (“Ø–π–ª–µ—Å—ñ–º–¥—ñ–ª—ñ–∫ “Ø—à—ñ–Ω “±—Å—ã–Ω—ã–ª–∞–¥—ã) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- ===================================================================== -->
    <!-- === –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò (–û–ë–™–ï–î–ò–ù–ï–ù–´ –ò –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–´) === -->
    <!-- ===================================================================== -->
    <style>
        /* --- –ö–æ—Ä–Ω–µ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ --- */
        :root {
            --bg-main: #F9FAFB;
            --bg-widget: #FFFFFF;
            --text-primary: #111827;
            --text-secondary: #6B7280;
            --border-color: #E5E7EB;
            --accent-primary: #4F46E5;
            --accent-primary-light: rgba(79, 70, 229, 0.1);
            --accent-purple: #8B5CF6;
            --accent-red: #EF4444;
            --accent-green: #10B981;
            --accent-green-bg: #D1FAE5;
            --accent-green-text: #065F46;
            --accent-red-bg: #FEE2E2;
            --accent-red-text: #991B1B;
            --widget-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --header-shadow: 0 4px 12px rgba(16, 24, 40, 0.04);
        }

        /* --- –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            /* background-color: var(--bg-main); */
            background-color: #edf2fe;
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1280px; /* –£–≤–µ–ª–∏—á–∏–ª–∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ */
            margin: 0 auto;
            padding: 24px;
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è —à–∞–ø–∫–∏ (Header) --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-widget);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--header-shadow);
            margin-bottom: 32px; /* –£–≤–µ–ª–∏—á–∏–ª–∏ –æ—Ç—Å—Ç—É–ø */
        }
        .header-logo { display: flex; align-items: center; gap: 14px; }
        .header-logo-icon { width: 44px; height: 44px; background-color: var(--accent-primary); border-radius: 10px; color: white; display: grid; place-items: center; font-size: 20px; }
        .header-logo h1 { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
        .header-logo p { font-size: 13px; color: var(--text-secondary); }
        .header-user { display: flex; align-items: center; gap: 16px; }
        .header-user-info h3 { font-weight: 600; font-size: 15px; text-align: right; }
        .header-user-link { text-decoration: none; color: inherit; }
        .header-user-avatar { width: 44px; height: 44px; border-radius: 10px; background-color: #D8B4FE; color: #581C87; display: grid; place-items: center; font-weight: 600; font-size: 16px; }

        /* --- –û–°–ù–û–í–ù–ê–Ø –°–ï–¢–ö–ê –î–õ–Ø –î–ï–°–ö–¢–û–ü–ê --- */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* –î–≤–µ —Ä–∞–≤–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ */
            gap: 32px; /* –ü—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏ */
            align-items: start; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –±–ª–æ–∫–æ–≤ –ø–æ –≤–µ—Ä—Ö—É */
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ —Å —Ñ–æ—Ä–º–∞–º–∏ --- */
        .form-card {
            background-color: var(--bg-widget);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--widget-shadow);
        }

        #id_bio {
            padding: 10px;
        }

        .form-card h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color); /* –í–∏–∑—É–∞–ª—å–Ω—ã–π —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å */
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π —Ñ–æ—Ä–º—ã --- */
        .form-card form p {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .form-card form label {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
        }

        .logout {
            display: flex;
            justify-self: end;
            font-size: 14px;
            color: gray;
        }

        .form-card form input[type="text"],
        .form-card form input[type="email"],
        .form-card form input[type="password"],
        .form-card form input[type="date"] {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            color: var(--text-primary);
            background-color: var(--bg-main);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-card form input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--accent-primary-light);
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ --- */
        .form-card button[type="submit"] {
            width: 100%;
            border: none;
            border-radius: 8px;
            padding: 12px 20px;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            /* background-image: linear-gradient(to right, var(--accent-primary) 0%, var(--accent-purple) 100%); */
            background-color: #4F46E5;
            box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2);
            transition: all 0.2s ease-in-out;
            margin-top: 10px;
        }
        .form-card button[type="submit"]:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3);
        }

        /* --- –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –æ—à–∏–±–æ–∫ --- */
        .message-box, .error-box {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message-box {
            background-color: var(--accent-green-bg);
            color: var(--accent-green-text);
            border: 1px solid var(--accent-green-text);
        }

        .error-box {
            color: var(--accent-red-text);
            background-color: var(--accent-red-bg);
            border: 1px solid var(--accent-red-text);
        }
        .error-box ul {
            margin: 0;
            padding-left: 20px;
        }

        #logout_form {
            display: none;
        }

        /* –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è */
        .hidden {
            display: none;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫ –≤ —Ñ–æ—Ä–º–µ –ø–∞—Ä–æ–ª—è */
        #password-form ul {
            margin-left: 7%;
            color: var(--text-secondary);
            font-size: 13px;
        }
        #password-form ul li { margin-bottom: 5px; }


        #profile-form textarea {
            border-radius: 10px;
        }

        input {
            border-color: #ccc !important;
        }


        /* ===================================================================
           –ê–î–ê–ü–¢–ò–í–ù–´–ï –°–¢–ò–õ–ò (–ü–õ–ê–ù–®–ï–¢–´ –ò –ú–û–ë–ò–õ–¨–ù–´–ï)
        =================================================================== */
        @media (max-width: 992px) {
            /* –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –æ–¥–Ω–æ–∫–æ–ª–æ–Ω–æ—á–Ω—ã–π –º–∞–∫–µ—Ç –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
            .profile-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {

            #logout_form {
                display: flex;
                width: 100%;
                margin-top: 20px;
            }  

            #logout_form a, button{
                width: 100%;
            }  
            

            .logout {
                display: none;
            }
            .container {
                padding: 16px;
            }
            .page-header {
                padding: 12px 16px;
                margin-bottom: 24px;
            }
            /* –°–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –≤ —à–∞–ø–∫–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .header-logo p, .header-user-info { display: none; }
            .header-logo h1 { font-size: 18px; }
            .header-logo-icon, .header-user-avatar { width: 40px; height: 40px; }

            .header-user-avatar {
                border-radius: 10px !important;
            }
            
            .form-card {
                padding:10px;

            }
            .form-card h2 {
                padding: 10px;
                font-size: 18px;
            }


            input, textarea, label, h2{
                width: 90% !important;
                margin-left: 5%;
            }

            .form-card button {
                width: 90% !important;
                margin-left: 5%;
                margin-bottom: 10px;
            }

            #password-form ul li {
                width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
    <!-- ===================================================================== -->
    <!-- === –ë–ê–° –ë”®–õ–Ü–ö (HEADER) === -->
    <!-- ===================================================================== -->
        <header class="page-header">
            <div class="header-logo">
                <div class="header-logo-icon">üéì</div>
                <div>
                    <h1>Sabaq Saqshy</h1>
                    <p>–û“õ—ã—Ç—É –ø—Ä–æ—Ü–µ—Å—ñ–Ω –±–∞—Å“õ–∞—Ä—É –∂“Ø–π–µ—Å—ñ</p>
                </div>
            </div>
            <div class="header-user">
                <div class="header-user-info">
                    <a href="{% url 'profile' %}" class="header-user-link">
                        <h3 id="header-user-fullname">{{ user.get_full_name }}</h3>
                    </a>
                    <a class="logout" href="{% url 'logout' %}" class="header-user-link">
                        –®—ã“ì—É
                    </a>
                </div>
                <a href="{% url 'profile' %}" class="header-user-link">
                    <div class="header-user-avatar" id="header-user-initials">{{ user.first_name|first }}{{ user.last_name|first }}</div>
                </a>
            </div>
        </header>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
        <main>
            <!-- –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–µ—Ç–æ—á–Ω–æ–≥–æ –º–∞–∫–µ—Ç–∞ -->
            <div class="profile-grid">
                
                <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                <div class="grid-column">
                    <div class="form-card">
                        <h2>–ü—Ä–æ—Ñ–∏–ª—å–¥—ñ ”©“£–¥–µ—É</h2>
                        <div id="profile-message-container" class="message-box hidden"></div>
                        <div id="profile-errors-list" class="error-box hidden"></div>
                        
                        <form id="profile-form" method="post" novalidate>
                            {% csrf_token %}
                            {{ form.as_p }}
                            <button type="submit">”®–∑–≥–µ—Ä—ñ—Å—Ç–µ—Ä–¥—ñ —Å–∞“õ—Ç–∞—É</button>
                        </form>
                    </div>

                    <div class="form-card" style="margin-top: 32px;">
                        <h2>–ê—Ç—ã-–∂”©–Ω–¥—ñ ”©–∑–≥–µ—Ä—Ç—É</h2>
                        <div id="name-message-container" class="message-box hidden"></div>
                        <div id="name-errors-list" class="error-box hidden"></div>
                
                        <form id="name-form" method="post" action="{% url 'change_name' %}" novalidate>
                            {% csrf_token %}
                            {{ name_form.as_p }}
                            <button type="submit">–ê—Ç—ã-–∂”©–Ω–¥—ñ —Å–∞“õ—Ç–∞—É</button>
                        </form>
                    </div>
                </div>

                <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
                <div class="grid-column">
                    <div class="form-card">
                        <h2>“ö“±–ø–∏—è—Å”©–∑–¥—ñ ”©–∑–≥–µ—Ä—Ç—É</h2>
                        <div id="password-message-container" class="message-box hidden"></div>
                        <div id="password-errors-list" class="error-box hidden"></div>
                
                        <form id="password-form" method="post" action="{% url 'change_password' %}" novalidate>
                            {% csrf_token %}
                            {{ password_form.as_p }}
                            <button type="submit">“ö“±–ø–∏—è—Å”©–∑–¥—ñ ”©–∑–≥–µ—Ä—Ç—É</button>
                        </form>
                    </div>

                    <div class="form-card" style="margin-top: 32px;">
                        <h2>–≠–ª–µ–∫—Ç—Ä–æ–Ω–¥—ã“õ –ø–æ—à—Ç–∞–Ω—ã ”©–∑–≥–µ—Ä—Ç—É</h2>
                        <p style="font-size: 14px; color: var(--text-secondary); margin-bottom: 20px;">–ê“ì—ã–º–¥–∞“ì—ã email: <strong>{{ user.email|default:"–∫”©—Ä—Å–µ—Ç—ñ–ª–º–µ–≥–µ–Ω" }}</strong></p>
                        <div id="email-message-container" class="message-box hidden"></div>
                        <div id="email-errors-list" class="error-box hidden"></div>
                
                        <form id="email-form" method="post" action="{% url 'change_email' %}" novalidate>
                            {% csrf_token %}
                            {{ email_form.as_p }}
                            <button type="submit">–≠–ª–µ–∫—Ç—Ä–æ–Ω–¥—ã“õ –ø–æ—à—Ç–∞–Ω—ã ”©–∑–≥–µ—Ä—Ç—É</button>
                        </form>
                    </div>

                    <div id="logout_form" class="form-card" style="margin-top: 32px;">
                        <a href="{% url 'logout' %}"><button type="submit">–®—ã“ì—É</button></a>
                    </div>
                </div>
                
            </div> <!-- .profile-grid -->
        </main>
    </div> <!-- .container -->
   
    <script>
    // –í–ê–® JAVASCRIPT –ö–û–î –û–°–¢–ê–ï–¢–°–Ø –ó–î–ï–°–¨ –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
    // –Ø –≤–Ω–µ—Å –ª–∏—à—å –Ω–µ–±–æ–ª—å—à–∏–µ –ø—Ä–∞–≤–∫–∏ –≤ –∫–ª–∞—Å—Å—ã, —á—Ç–æ–±—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –Ω–æ–≤–æ–π —Ä–∞–∑–º–µ—Ç–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        
        function handleFormSubmit(formId, url, messageContainerId, errorContainerId, successCallback) {
            const form = document.getElementById(formId);
            if (!form) return;

            form.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

                // –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
                const messageContainer = document.getElementById(messageContainerId);
                const errorsListContainer = document.getElementById(errorContainerId);
                messageContainer.classList.add('hidden');
                errorsListContainer.classList.add('hidden');
                errorsListContainer.innerHTML = '';

                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        messageContainer.textContent = data.message;
                        messageContainer.classList.remove('hidden');
                        form.reset();
                        if (successCallback) {
                            successCallback(data);
                        }
                    } else {
                        errorsListContainer.classList.remove('hidden');
                        const ul = document.createElement('ul');
                        if (data.errors) {
                            for (const field in data.errors) {
                                data.errors[field].forEach(error => {
                                    const li = document.createElement('li');
                                    li.textContent = (typeof error === 'object' && error.message) ? error.message : error;
                                    ul.appendChild(li);
                                });
                            }
                        } else {
                            const li = document.createElement('li');
                            li.textContent = data.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞.';
                            ul.appendChild(li);
                        }
                        errorsListContainer.appendChild(ul);
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ–æ—Ä–º—ã
        handleFormSubmit('profile-form', "{% url 'profile' %}", 'profile-message-container', 'profile-errors-list');
        handleFormSubmit('password-form', "{% url 'change_password' %}", 'password-message-container', 'password-errors-list');
        handleFormSubmit('email-form', "{% url 'change_email' %}", 'email-message-container', 'email-errors-list', (data) => {
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è email –≤ —Ç–µ–∫—Å—Ç–µ
            setTimeout(() => location.reload(), 1500);
        });

        // –û—Ç–¥–µ–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ä–º—ã —Å–º–µ–Ω—ã –∏–º–µ–Ω–∏ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —à–∞–ø–∫–∏
        handleFormSubmit('name-form', "{% url 'change_name' %}", 'name-message-container', 'name-errors-list', (data) => {
            if (data.new_full_name) {
                document.getElementById('header-user-fullname').textContent = data.new_full_name;
            }
            if (data.new_initials) {
                document.getElementById('header-user-initials').textContent = data.new_initials;
            }
        });
    });

    document.getElementById("password-form").getElementsByTagName("label")[0].textContent = "–ï—Å–∫—ñ “õ“±–ø–∏—è—Å”©–∑";
    document.getElementById("password-form").getElementsByTagName("label")[1].textContent = "–ñ–∞“£–∞ “õ“±–ø–∏—è—Å”©–∑";
    document.getElementById("password-form").getElementsByTagName("label")[2].textContent = "–ñ–∞“£–∞ “õ“±–ø–∏—è—Å”©–∑–¥—ñ —Ä–∞—Å—Ç–∞—É";
    document.getElementById("password-form").getElementsByTagName("li")[0].textContent = "“ö“±–ø–∏—è —Å”©–∑ –±–∞—Å“õ–∞ –∂–µ–∫–µ –∞“õ–ø–∞—Ä–∞—Ç—Ç–∞—Ä—ã“£—ã–∑“ì–∞ —Ç—ã–º “±“õ—Å–∞–º–∞—É—ã –∫–µ—Ä–µ–∫.";
    document.getElementById("password-form").getElementsByTagName("li")[1].textContent = "“ö“±–ø–∏—è —Å”©–∑—ñ“£—ñ–∑–¥–µ –∫–µ–º—ñ–Ω–¥–µ 8 —Ç–∞“£–±–∞ –±–æ–ª—É—ã –∫–µ—Ä–µ–∫.";
    document.getElementById("password-form").getElementsByTagName("li")[2].textContent = "“ö“±–ø–∏—è —Å”©–∑ —Ç—ã–º “õ–∞—Ä–∞–ø–∞–π—ã–º –∂”ô–Ω–µ –∫–µ“£ —Ç–∞—Ä–∞–ª“ì–∞–Ω –±–æ–ª–º–∞—É—ã –∫–µ—Ä–µ–∫.";
    document.getElementById("password-form").getElementsByTagName("li")[3].textContent = "“ö“±–ø–∏—è —Å”©–∑ —Ç–µ–∫ —Å–∞–Ω–¥–∞—Ä–¥–∞–Ω “õ“±—Ä–∞–ª–º–∞—É—ã —Ç–∏—ñ—Å.";

    </script>
</body>
</html>