{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è | Bilim Class</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root{
            --bg-main:#F9FAFB;
            --bg-widget:#FFFFFF;
            --text-primary:#111827;
            --text-secondary:#6B7280;
            --border-color:#E5E7EB;
            --accent-primary:#4F46E5;
            --accent-light:#EEF2FF;
            --status-pending-bg:#FEF3C7;
            --status-pending-text:#92400E;
            --status-review-bg:#DBEAFE;
            --status-review-text:#1E40AF;
            --status-checked-bg:#D1FAE5;
            --status-checked-text:#065F46}
            *{margin:0;padding:0;box-sizing:border-box}
            body{font-family:'Inter',sans-serif;background-color:var(--bg-main);color:var(--text-primary)}.container{max-width:1200px;margin:0 auto;padding:24px}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.header .logo{display:flex;align-items:center;gap:12px}.header .logo-icon{width:40px;height:40px;border-radius:8px;background-color:var(--accent-primary);color:#fff;display:grid;place-items:center;font-size:20px;font-weight:700}.header h1{font-size:18px}.header p{font-size:14px;color:var(--text-secondary)}.header .user-profile{display:flex;align-items:center;gap:16px}.header .user-avatar{width:40px;height:40px;border-radius:50%;background-color:#DDD6FE;color:#5B21B6;display:grid;place-items:center;font-weight:600}.main-nav{background-color:var(--bg-widget);border:1px solid var(--border-color);border-radius:12px;padding:8px;margin-bottom:24px}.main-nav ul{display:flex;list-style:none;gap:8px}.main-nav a{display:flex;align-items:center;gap:8px;padding:10px 16px;text-decoration:none;color:var(--text-secondary);font-weight:600;border-radius:8px;transition:all .2s}.main-nav a.active{background-color:var(--accent-light);color:var(--accent-primary)}.homework-widget{background-color:var(--bg-widget);border:1px solid var(--border-color);border-radius:16px;padding:24px}.widget-header{margin-bottom:24px}.widget-header h2{font-size:20px;font-weight:600}.widget-header p{color:var(--text-secondary)}.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px}.stat-card{display:flex;align-items:center;gap:16px;padding:20px;border:1px solid var(--border-color);border-radius:12px}.stat-icon{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;font-size:16px}.stat-card-pending .stat-icon{background-color:var(--status-pending-bg);color:var(--status-pending-text)}.stat-card-review .stat-icon{background-color:var(--status-review-bg);color:var(--status-review-text)}.stat-card-checked .stat-icon{background-color:var(--status-checked-bg);color:var(--status-checked-text)}.stat-value{font-size:24px;font-weight:700}.stat-label{font-size:14px;color:var(--text-secondary)}.homework-tabs{display:flex;gap:8px;margin-bottom:24px}.tab-btn{padding:8px 16px;background-color:#F3F4F6;border:none;border-radius:8px;font-weight:600;cursor:pointer;color:var(--text-secondary);transition:all .2s}.tab-btn.active{background-color:var(--accent-primary);color:#fff}.homework-list{display:flex;flex-direction:column;gap:16px}.tab-pane{display:none}.tab-pane.active{display:flex;flex-direction:column;gap:16px}.homework-card{border:1px solid var(--border-color);border-radius:12px;padding:20px}.hw-card-header{display:flex;align-items:center;gap:12px;margin-bottom:8px}.hw-card-header h3{font-size:18px;font-weight:600}.hw-status-tag{font-size:12px;font-weight:500;padding:4px 10px;border-radius:99px}.tag-pending{background-color:var(--status-pending-bg);color:var(--status-pending-text)}.tag-review{background-color:var(--status-review-bg);color:var(--status-review-text)}.tag-checked{background-color:var(--status-checked-bg);color:var(--status-checked-text)}.hw-meta{color:var(--text-secondary);font-size:14px;margin-bottom:12px}.hw-description{margin-bottom:16px}.hw-footer{display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border-color);padding-top:16px;margin-top:16px}.hw-deadline{display:flex;align-items:center;gap:8px;color:var(--text-secondary);font-size:14px}.btn-submit{display:flex;align-items:center;gap:8px;padding:10px 16px;background-color:var(--accent-primary);color:#fff;border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer}.btn-submitted{background-color:var(--status-review-bg);color:var(--status-review-text);cursor:default}.btn-checked{background-color:var(--status-checked-bg);color:var(--status-checked-text);cursor:default}.modal-overlay{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);justify-content:center;align-items:center}.modal-container{background-color:var(--bg-widget);border-radius:16px;padding:24px;width:90%;max-width:600px;box-shadow:0 10px 25px rgba(0,0,0,.1);position:relative}.modal-header{margin-bottom:16px}.modal-header h2{font-size:20px;font-weight:600}.modal-header p{color:var(--text-secondary)}.close-btn{position:absolute;top:16px;right:16px;background:0 0;border:none;font-size:24px;color:var(--text-secondary);cursor:pointer}.form-group{display:flex;flex-direction:column;margin-bottom:16px}.form-group label{font-size:14px;font-weight:500;margin-bottom:8px}.form-group textarea{padding:10px 12px;border:1px solid var(--border-color);border-radius:8px;background-color:#F9FAFB;font-family:'Inter',sans-serif;font-size:14px;resize:vertical;min-height:80px}.file-drop-area{border:2px dashed var(--border-color);border-radius:8px;padding:32px;text-align:center;color:var(--text-secondary)}.file-drop-area i{font-size:24px;margin-bottom:12px}.file-drop-area p{font-weight:500}.file-drop-area span{font-size:12px}.modal-footer{display:flex;justify-content:flex-end;gap:12px;margin-top:24px}.btn-secondary{padding:10px 16px;background-color:var(--bg-widget);color:var(--text-primary);border:1px solid var(--border-color);border-radius:8px;font-size:14px;font-weight:600;cursor:pointer}
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üéì</div>
            <div>
                <h1>Bilim Class</h1>
            </div>
        </div>
        <div class="user-profile">
             <div class="user-avatar">{{ request.user.first_name|first }}{{ request.user.last_name|first }}</div>
             <div>
                <p style="font-weight: 600;">{{ request.user.get_full_name }}</p>
                <a href="{% url 'logout' %}" style="font-size: 12px; color: var(--text-secondary);">–í—ã–π—Ç–∏</a>
             </div>
        </div>
    </header>

    <nav class="main-nav">
        <ul>
            <li><a href="#"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="#"><i class="far fa-star"></i> –ú–æ–∏ –æ—Ü–µ–Ω–∫–∏</a></li>
            <li><a href="#" class="active"><i class="fas fa-book-open"></i> –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a></li>
            <li><a href="#"><i class="far fa-calendar-alt"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a></li>
            <li><a href="#"><i class="fas fa-trophy"></i> –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</a></li>
        </ul>
    </nav>

    <main class="homework-widget">
        <div class="widget-header">
            <h2>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
            <p>–í—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card stat-card-pending"><div class="stat-icon">üïí</div><div><div class="stat-value">{{ not_submitted_list.count }}</div><p class="stat-label">–ù–µ —Å–¥–∞–Ω–æ</p></div></div>
            <div class="stat-card stat-card-review"><div class="stat-icon">üìÑ</div><div><div class="stat-value">{{ in_review_list.count }}</div><p class="stat-label">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</p></div></div>
            <div class="stat-card stat-card-checked"><div class="stat-icon">‚úì</div><div><div class="stat-value">{{ checked_list.count }}</div><p class="stat-label">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</p></div></div>
        </div>

        <div class="homework-tabs">
            <button class="tab-btn active" data-tab="not_submitted">–ù–µ —Å–¥–∞–Ω–æ ({{ not_submitted_list.count }})</button>
            <button class="tab-btn" data-tab="in_review">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ ({{ in_review_list.count }})</button>
            <button class="tab-btn" data-tab="checked">–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ ({{ checked_list.count }})</button>
        </div>

        <div class="homework-list" id="homework-list-container">
            <div id="tab-content-not_submitted" class="tab-pane active">
                {% for hw in not_submitted_list %}
                <div class="homework-card">
                    <div class="hw-card-header"><h3>{{ hw.title }}</h3><span class="hw-status-tag tag-pending">–ù–µ —Å–¥–∞–Ω–æ</span></div>
                    <p class="hw-meta">{{ hw.subject.name }} ‚Ä¢ {{ hw.teacher.user.get_full_name }}</p>
                    <p class="hw-description">{{ hw.description }}</p>
                    <div class="hw-footer">
                        <div class="hw-deadline"><i class="far fa-clock"></i> –°—Ä–æ–∫ —Å–¥–∞—á–∏: {{ hw.due_date|date:"d.m.Y" }}</div>
                        <button class="btn-submit open-submission-modal" data-hw-pk="{{ hw.pk }}">–°–¥–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
                    </div>
                </div>
                {% empty %} <p style="text-align:center; padding: 20px; color: var(--text-secondary);">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Å–¥–∞—Ç—å.</p> {% endfor %}
            </div>

            <div id="tab-content-in_review" class="tab-pane">
                {% for submission in in_review_list %}
                <div class="homework-card">
                    <div class="hw-card-header"><h3>{{ submission.homework.title }}</h3><span class="hw-status-tag tag-review">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</span></div>
                    <p class="hw-meta">{{ submission.homework.subject.name }} ‚Ä¢ {{ submission.homework.teacher.user.get_full_name }}</p>
                    <div class="hw-footer">
                        <div class="hw-deadline"><i class="far fa-calendar-check"></i> –°–¥–∞–Ω–æ: {{ submission.submitted_at|date:"d.m.Y" }}</div>
                        <button class="btn-submit btn-submitted" disabled>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</button>
                    </div>
                </div>
                {% empty %} <p style="text-align:center; padding: 20px; color: var(--text-secondary);">–ù–µ—Ç —Ä–∞–±–æ—Ç –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ.</p> {% endfor %}
            </div>

            <div id="tab-content-checked" class="tab-pane">
                {% for submission in checked_list %}
                <div class="homework-card">
                     <div class="hw-card-header"><h3>{{ submission.homework.title }}</h3><span class="hw-status-tag tag-checked">–û—Ü–µ–Ω–∫–∞: {{ submission.grade }}</span></div>
                    <p class="hw-meta">{{ submission.homework.subject.name }} ‚Ä¢ {{ submission.homework.teacher.user.get_full_name }}</p>
                    <p class="hw-description"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —É—á–∏—Ç–µ–ª—è:</strong> {{ submission.teacher_comment|default:"-" }}</p>
                    <div class="hw-footer">
                        <div class="hw-deadline"><i class="far fa-calendar-check"></i> –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: {{ submission.checked_at|date:"d.m.Y" }}</div>
                        <button class="btn-submit btn-checked" disabled>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</button>
                    </div>
                </div>
                {% empty %} <p style="text-align:center; padding: 20px; color: var(--text-secondary);">–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç.</p> {% endfor %}
            </div>
        </div>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–¥–∞—á–∏ –î–ó -->
<div class="modal-overlay" id="submission-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-submission-modal">&times;</button>
        <div class="modal-header">
            <h2 id="modal-hw-title">–°–¥–∞—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
            <p id="modal-hw-subject">–ò—Å—Ç–æ—Ä–∏—è ‚Ä¢ –≠—Å—Å–µ "–í–µ–ª–∏–∫–∞—è –û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –≤–æ–π–Ω–∞"</p>
        </div>
        <form id="submission-form" method="POST" enctype="multipart/form-data" style="margin-top: 24px;">
            {% csrf_token %}
            <div id="modal-hw-description" style="margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border-color);">
                <p><strong>–ó–∞–¥–∞–Ω–∏–µ:</strong> –ù–∞–ø–∏—Å–∞—Ç—å —ç—Å—Å–µ –æ–±—ä–µ–º–æ–º 2-3 —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ —Ç–µ–º—É "–†–æ–ª—å –°–°–°–† –≤ –í–µ–ª–∏–∫–æ–π –û—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–π –≤–æ–π–Ω–µ".</p>
            </div>
            <div class="form-group">
                <label>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã</label>
                <div class="file-drop-area">
                    <i class="fas fa-upload"></i>
                    <p>–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</p>
                    <span>PDF, DOC, DOCX, –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–º–∞–∫—Å. 10 –ú–ë)</span>
                    <input type="file" name="submission_file" style="display: none;">
                </div>
            </div>
            <div class="form-group">
                <label for="submission_text">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <textarea id="submission_text" name="submission_text" placeholder="–î–æ–±–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ä–∞–±–æ—Ç–µ..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancel-submission-btn">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- –ù–ê–ß–ê–õ–û –ë–õ–û–ö–ê –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –£–ß–ï–ù–ò–ö–ê ---

    // 1. –õ–æ–≥–∏–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–∞–±–æ–≤
    const tabs = document.querySelectorAll('.homework-tabs .tab-btn');
    const panes = document.querySelectorAll('.homework-list .tab-pane');

    if (tabs.length > 0 && panes.length > 0) {
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                const targetId = `tab-content-${this.dataset.tab}`;
                panes.forEach(p => {
                    p.classList.toggle('active', p.id === targetId);
                });
            });
        });
    }

    // 2. –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –°–î–ê–ß–ò —Ä–∞–±–æ—Ç—ã
    const submissionModal = document.getElementById('submission-modal');
    const homeworkList = document.getElementById('homework-list-container');
    
    if (submissionModal && homeworkList) {
        const closeSubmissionModalBtn = document.getElementById('close-submission-modal');
        const cancelSubmissionModalBtn = document.getElementById('cancel-submission-btn');
        const submissionForm = document.getElementById('submission-form');

        homeworkList.addEventListener('click', function(e) {
            const openBtn = e.target.closest('.open-submission-modal');
            if (openBtn) {
                const homeworkId = openBtn.dataset.hwPk;
                // –í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç AJAX –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –î–ó
                submissionForm.action = `/api/homework/${homeworkId}/submit/`;
                submissionModal.style.display = 'flex';
            }
        });

        const closeModal = () => { submissionModal.style.display = 'none'; };
        closeSubmissionModalBtn.addEventListener('click', closeModal);
        cancelSubmissionModalBtn.addEventListener('click', closeModal);
        submissionModal.addEventListener('click', (e) => { if (e.target === submissionModal) closeModal(); });

        submissionForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            try {
                const response = await fetch(this.action, {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-CSRFToken': getCookie('csrftoken') }
                });
                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    window.location.reload();
                } else {
                    alert(`–û—à–∏–±–∫–∞: ${result.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç—É.'}`);
                }
            } catch(error) {
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.');
            }
        });
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –î–õ–Ø –°–¢–†–ê–ù–ò–¶–´ –£–ß–ï–ù–ò–ö–ê ---
});
</script>

</body>
</html>