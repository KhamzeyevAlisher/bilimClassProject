{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд Учителя | Школьная Платформа</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/teacher_homework.css' %}">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/teacher_dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/base.css' %}">    

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-main: #F9FAFB; --bg-widget: #FFFFFF; --text-primary: #111827;
            --text-secondary: #6B7280; --border-color: #E5E7EB; --accent-primary: #4F46E5;
            --accent-light: #EEF2FF; --accent-blue: #3B82F6; --accent-orange: #F97316;
            --accent-purple: #8B5CF6; --accent-red: #EF4444; --accent-green: #10B981;
            /* Стили для журнала */
            --grade-5:#D1FAE5; --grade-5-text:#065F46; --grade-4:#DBEAFE;
            --grade-4-text:#1E40AF; --grade-3:#FEF3C7; --grade-3-text:#92400E;
            /* Тень для виджетов */
            --widget-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--accent-light); color: var(--text-primary); }
        .td-container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .td-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .td-logo-section { display: flex; align-items: center; gap: 12px; }
        .td-logo-icon { width: 40px; height: 40px; background-color: var(--accent-primary); border-radius: 8px; color: white; display: grid; place-items: center; font-size: 20px; }
        .td-logo-section h1 { font-size: 18px; } .td-logo-section p { font-size: 14px; color: var(--text-secondary); }
        .td-user-section { display: flex; align-items: center; gap: 16px; }
        .td-user-info { text-align: right; } .td-user-info h3 { font-weight: 600; }
        .td-user-info p { font-size: 14px; color: var(--text-secondary); }
        .td-user-link { text-decoration: none; color: inherit; }
        .td-user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #D8B4FE; color: #581C87; display: grid; place-items: center; font-weight: 600; }
        .td-main-grid { display: grid; }
        .td-main-nav { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 24px; box-shadow: var(--widget-shadow); }
        .td-main-nav ul { display: flex; list-style: none; gap: 8px; }
        .td-main-nav a { display: flex; align-items: center; gap: 8px; padding: 10px 16px; text-decoration: none; color: var(--text-secondary); font-weight: 600; border-radius: 8px; transition: all 0.2s; cursor: pointer; }
        .td-main-nav a:hover { background-color: #F3F4F6; color: var(--text-primary); }
        .td-main-nav a.active { background-color: var(--accent-light); color: var(--accent-primary); }
        .td-card { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; box-shadow: var(--widget-shadow); }
        .td-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .td-card-header i { color: var(--text-secondary); } .td-card-header h3 { font-size: 18px; font-weight: 600; }
        .td-card-subtitle { color: var(--text-secondary); margin-bottom: 20px; }
        
        .td-stats-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .td-stat-card {
            background-color: var(--bg-widget);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--widget-shadow);
        }
        .td-stat-card .stat-info p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0 0 4px 0;
        }
        .td-stat-card .stat-info h2 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-size: 20px;
            color: #FFFFFF;
        }

        .stat-icon i { margin-top: 12px;}

        .stat-icon.blue { background-color: var(--accent-blue); }
        .stat-icon.orange { background-color: var(--accent-orange); }
        .stat-icon.purple { background-color: var(--accent-purple); }
        .stat-icon.red { background-color: var(--accent-red); }

        .td-schedule-list { display: flex; flex-direction: column; gap: 12px; }
        .td-lesson-item { display: flex; align-items: center; gap: 16px; padding: 16px; border-radius: 10px; background-color: #F9FAFB; }
        .td-lesson-time p { font-weight: 600; } .td-lesson-info { flex-grow: 1; }
        .td-right-column { display: flex; flex-direction: column; gap: 24px; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        
        /* СТИЛИ ДЛЯ РАСПИСАНИЯ */
        .schedule-stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
        .schedule-stat-item { background-color: var(--bg-main); border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 16px; }
        .schedule-stat-item .icon-bg { font-size: 18px; width: 48px; height: 48px; border-radius: 50%; display: grid; place-items: center; }
        .schedule-stat-item .icon-bg.blue { background-color: #DBEAFE; color: #1D4ED8; }
        .schedule-stat-item .icon-bg.purple { background-color: #E0E7FF; color: #4338CA; }
        .schedule-stat-item .icon-bg.green { background-color: #D1FAE5; color: #047857; }
        .schedule-week-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; }
        .schedule-day-column { background-color: var(--bg-main); border-radius: 12px; padding: 16px; }
        .schedule-day-column.today { background-color: var(--accent-light); border: 1px solid var(--accent-primary); }
        .day-header { margin-bottom: 16px; text-align: center; }
        .lessons-list { display: flex; flex-direction: column; gap: 12px; }
        .lesson-card {display:flex; flex-direction: column; gap: 10px; background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; }

        /* СТИЛИ ДЛЯ ЖУРНАЛА */
        .journal-widget { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; box-shadow: var(--widget-shadow); }
        .journal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .journal-title h2 { font-size: 20px; font-weight: 600; }
        .journal-title p { color: var(--text-secondary); }
        .class-selector { padding: 10px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 500; background-color: #F9FAFB; font-family: 'Inter', sans-serif; font-size: 14px; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right .75rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; padding-right: 2.5rem; }
        .journal-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .tab-btn { padding: 8px 16px; background: transparent; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 14px; transition: all .2s; }
        .tab-btn.active { background-color: var(--accent-primary); border-color: var(--accent-primary); color: #fff; }
        .journal-table { width: 100%; border-collapse: collapse; display: table; }
        .journal-table tr { display: table-row; }
        .journal-table th, .journal-table td { display: table-cell; vertical-align: middle; }
        .journal-table th { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; text-align: center; padding-bottom: 16px; }
        .journal-table th:first-child { text-align: left; }
        .journal-table td { padding: 6px; text-align: center; border-bottom: 1px solid var(--border-color); }
        .journal-table tr:last-child td { border-bottom: none; }
        .journal-table td:first-child { text-align: left; font-weight: 500; }
        .grade-cell {background-color: #EFF6FF; margin-left: 50%; transform: translateX(-50%); width:73px; border: 1px solid #90a5ea; cursor:pointer;border-radius:8px;min-height:48px;display:flex;align-items:center;justify-content:center;transition:background-color .2s}
        .attendance-cell {background-color: #EFF6FF; width:73px; border: 1px solid #90a5ea; cursor:pointer;border-radius:8px;min-height:48px;display:flex;align-items:center;justify-content:center;transition:background-color .2s}
        .grade-cell:hover, .attendance-cell:hover{background-color:#EFF6FF}
        .grade-badge{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;font-weight:700;font-size:16px}
        .grade-5{background-color:var(--grade-5);color:var(--grade-5-text)}.grade-4{background-color:var(--grade-4);color:var(--grade-4-text)}.grade-3{background-color:var(--grade-3);color:var(--grade-3-text)}
        .grade-badge-container{position:relative;display:inline-flex}
        .grade-comment-icon{font-size:10px;color:var(--text-secondary);position:absolute;bottom:5px;right:5px}
        .attendance-icon{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;font-weight:bold;font-size:16px}
        .status-P{color:#059669;background-color:#ECFDF5}.status-A{color:#DC2626;background-color:#FEF2F2}.status-L{color:#D97706;background-color:#FFFBEB}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.5)}
        .modal-content{background-color:#F9FAFB;margin:15% auto;padding:20px;border:none;width:90%;max-width:400px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.1)}
        .close-btn{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
        #grade-form input,#grade-form textarea{width:100%;padding:12px;font-size:16px;border:1px solid var(--border-color);border-radius:8px;margin:10px 0;font-family:'Inter',sans-serif}
        #grade-form button{width:100%;padding:12px;background-color:var(--accent-primary);color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
        
        /* СТИЛИ ДЛЯ ПОУРОЧНЫХ ПЛАНОВ */
        .lp-widget { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; box-shadow: var(--widget-shadow); }
        
        /* СТИЛИ ДЛЯ ДОМАШНИХ ЗАДАНИЙ */
        .homework-widget { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; box-shadow: var(--widget-shadow); }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .widget-title h2 { font-size: 20px; font-weight: 600; }
        .widget-title p { color: var(--text-secondary); }
        .btn-create { background-color: var(--accent-primary); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s; }
        .btn-create:hover { background-color: #4338CA; }
        .homework-list { display: flex; flex-direction: column; gap: 16px; }
        .homework-card { background-color: var(--bg-main); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
        .hw-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .hw-title-group { display: flex; align-items: center; gap: 12px; }
        .hw-title-group h3 { font-size: 16px; font-weight: 600; }
        .hw-tag { background-color: #E0E7FF; color: #3730A3; font-size: 12px; font-weight: 500; padding: 4px 10px; border-radius: 6px; }
        .hw-actions button { background: none; border: 1px solid var(--border-color); width: 32px; height: 32px; border-radius: 6px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
        .hw-actions button:hover { background-color: var(--accent-light); color: var(--accent-primary); }
        .hw-description { color: var(--text-secondary); margin-bottom: 16px; font-size: 14px; }
        .hw-card-footer { display: flex; justify-content: space-between; align-items: center; }
        .hw-stats { font-size: 13px; color: var(--text-secondary); }
        .btn-view-submissions { background-color: var(--bg-widget); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s; }
        .btn-view-submissions:hover { background-color: #F3F4F6; }
        
        /* Стили для модальных окон */
        .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal-container { background-color: var(--bg-widget); border-radius: 12px; padding: 24px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { text-align: center; margin-bottom: 16px; }
        .modal-header h2 { font-size: 20px; }
        .modal-container .close-btn { position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; grid-column: 1 / -1; }
        .btn-secondary { background-color: var(--bg-widget); border: 1px solid var(--border-color); }

        /* Стили для таблицы сданных работ */
        .submissions-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .submissions-table th, .submissions-table td { padding: 12px; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 14px; }
        .submissions-table th { color: var(--text-secondary); font-weight: 600; }
        .status-tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 99px; font-weight: 500; font-size: 12px; }
        .status-checked { background-color: #D1FAE5; color: #065F46; }
        .status-submitted { background-color: #DBEAFE; color: #1E40AF; }
        .status-awaiting { background-color: #FEF3C7; color: #92400E; }
        .grade-circle { display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 50%; background-color: var(--accent-primary); color: white; font-weight: bold; }
        .file-link { color: var(--accent-primary); text-decoration: none; font-weight: 500; }
        .file-link i { margin-right: 4px; }

        /* --- КРАСИВЫЙ СТИЛЬ ДЛЯ ПОЛЯ ЗАГРУЗКИ ФАЙЛА --- */

/* Стиль для метки (label) над полем ввода */
.form-group label[for*="attached_file"] {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
}

/* Стили для самого поля input[type=file] */
input[name="attached_file"] {
    width: 100%;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--text-secondary);
    
    /* Для выравнивания и аккуратного вида */
    background-color: var(--bg-widget);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 4px;
}

/* Стиль для кнопки "Выберите файл" в современных браузерах */
input[name="attached_file"]::file-selector-button {
    /* Сбрасываем стандартные стили браузера */
    -webkit-appearance: none;
    appearance: none;
    
    /* Наши кастомные стили */
    background-color: var(--accent-primary);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    cursor: pointer;
    margin-right: 16px; /* Отступ между кнопкой и текстом с именем файла */
    transition: background-color 0.2s;
}

/* Эффект при наведении на кнопку */
input[name="attached_file"]::file-selector-button:hover {
    background-color: #4338CA; /* Более темный оттенок --accent-primary */
}

/* --- СТИЛЬ ДЛЯ ГРАДИЕНТНОЙ КНОПКИ --- */

.btn-gradient {
    /* Основные стили кнопки */
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    font-family: 'Inter', sans-serif;
    font-size: 16px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    
    /* Создание градиента */
    background-image: linear-gradient(to right, var(--accent-primary) 0%, var(--accent-purple) 100%);
    
    /* Тень для объема */
    box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2), 0 1px 2px rgba(0,0,0,0.05);
    
    /* Плавный переход для всех свойств */
    transition: all 0.2s ease-in-out;
}

/* Эффект при наведении курсора */
.btn-gradient:hover {
    /* Слегка приподнимаем кнопку */
    transform: translateY(-2px);
    /* Усиливаем тень для "парящего" эффекта */
    box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3), 0 2px 4px rgba(0,0,0,0.1);
}

/* Эффект при нажатии на кнопку */
.btn-gradient:active {
    /* Возвращаем кнопку на место для эффекта "нажатия" */
    transform: translateY(0);
    /* Возвращаем стандартную тень */
    box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2), 0 1px 2px rgba(0,0,0,0.05);
}


    </style>
</head>
<body class="td-body">

<div class="td-container">
    <header class="td-header">
        <div class="td-logo-section">
            <div class="td-logo-icon">🎓</div>
            <div>
                <h1>Школьная Платформа</h1>
                <p>Система управления учебным процессом</p>
            </div>
        </div>
        <div class="td-user-section">
            <div class="td-user-info">
                <a href="{% url 'profile' %}" class="td-user-link">
                    <h3>{{ teacher.user.get_full_name }}</h3>
                </a>
                <p>Учитель</p>
            </div>
            <a href="{% url 'profile' %}" class="td-user-link">
                <div class="td-user-avatar">{{ teacher.user.first_name|first }}{{ teacher.user.last_name|first }}</div>
            </a>
        </div>
    </header>

    <main>
        <!-- ОСНОВНАЯ НАВИГАЦИЯ (ВКЛАДКИ) -->
        <nav class="td-main-nav">
            <ul>
                <li><a class="active" data-tab="dashboard"><i class="fas fa-home"></i> Главная</a></li>
                <li><a data-tab="lesson-plans"><i class="fas fa-file-alt"></i> Поурочные планы</a></li>
                <li><a data-tab="schedule"><i class="far fa-calendar-alt"></i> Расписание</a></li>
                <li><a data-tab="journal"><i class="fas fa-book"></i> Журнал</a></li>
                <li><a data-tab="homework"><i class="fas fa-pencil-alt"></i> Домашние задания</a></li>
            </ul>
        </nav>

        <!-- КОНТЕЙНЕР ДЛЯ ВСЕХ ВКЛАДОК -->
        <div class="tabs-container">
            <!-- Контент для вкладки "Главная" -->
            <div id="dashboard-content" class="tab-content active">
                
                <!-- === НАЧАЛО: ИЗМЕНЕННЫЙ БЛОК СТАТИСТИКИ === -->
                <section class="td-stats-cards">
                    <div class="td-stat-card">
                        <div class="stat-info">
                            <p>Уроков сегодня</p>
                            <h2>{{ lessons_today_count|default:0 }}</h2>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                    <div class="td-stat-card">
                        <div class="stat-info">
                            <p>Планов на проверке</p>
                            <h2>{{ plans_to_check_count|default:0 }}</h2>
                        </div>
                        <div class="stat-icon orange">
                            <i class="fas fa-file-alt"></i>
                        </div>
                    </div>
                    <div class="td-stat-card">
                        <div class="stat-info">
                            <p>Домашних заданий</p>
                            <h2>{{ homeworks_count|default:0 }}</h2>
                        </div>
                        <div class="stat-icon purple">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                    </div>
                    <div class="td-stat-card">
                        <div class="stat-info">
                            <p>Непроверенных работ</p>
                            <h2>{{ unchecked_works_count|default:0 }}</h2>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                    </div>
                </section>
                <!-- === КОНЕЦ: ИЗМЕНЕННЫЙ БЛОК СТАТИСТИКИ === -->

                <section class="td-card">
                    <div class="td-card-header"><i class="far fa-clock"></i><h3>Расписание на сегодня</h3></div>
                    <p class="td-card-subtitle">{{ today|date:"l, j F Y" }}</p>
                    <div class="td-schedule-list">
                        {% for lesson in schedule_today %}
                        <div class="td-lesson-item">
                            <div class="td-lesson-time"><p>{{ lesson.start_time|time:"H:i" }}</p><span>{{ lesson.end_time|time:"H:i" }}</span></div>
                            <div class="td-lesson-info"><h4>{{ lesson.subject.name }}</h4><p>Класс {{ lesson.school_class.name }} • Кабинет {{ lesson.classroom }}</p></div>
                            <span class="td-lesson-status">Предстоит</span>
                        </div>
                        {% empty %}
                        <p style="text-align: center; padding: 20px; color: var(--text-secondary);">На сегодня уроков по расписанию нет.</p>
                        {% endfor %}
                    </div>
                </section>
            </div>

            <!-- Контент для вкладки "Расписание" -->
            <div id="schedule-content" class="tab-content">
                <section class="td-card">
                    <div class="td-card-header"><h3>Расписание уроков</h3></div>
                    <p class="td-card-subtitle">Расписание на текущую неделю для учителя: {{ teacher.user.get_full_name }}</p>

                    <div class="schedule-stats-grid">
                        <div class="schedule-stat-item">
                            <div class="icon-bg blue"><i class="fas fa-calendar-alt"></i></div>
                            <div><h3>{{ lessons_in_week_count }}</h3><p>Уроков в неделю</p></div>
                        </div>
                        <div class="schedule-stat-item">
                            <div class="icon-bg purple"><i class="fas fa-users"></i></div>
                            <div><h3>{{ unique_classes_count }}</h3><p>Классов в неделю</p></div>
                        </div>
                        <div class="schedule-stat-item">
                            <div class="icon-bg green"><i class="fas fa-clock"></i></div>
                            <div><h3>{{ hours_in_week }}</h3><p>Часов в неделю</p></div>
                        </div>
                    </div>

                    <div class="schedule-week-grid">
                        {% for day_data in schedule_for_template %}
                            <div class="schedule-day-column {% if today_weekday == day_data.day_number %}today{% endif %}">
                                <div class="day-header">
                                    <h4>{{ day_data.day_name }}</h4>
                                    <span>{{ day_data.date|date:"d.m.Y" }}</span>
                                </div>
                                <div class="lessons-list">
                                    {% for lesson in day_data.lessons %}
                                        <div class="lesson-card">
                                            <p class="time"><i class="far fa-clock"></i> {{ lesson.start_time|time:"H:i" }}</p>
                                            <p class="subject">{{ lesson.subject.name }}</p>
                                            <p class="details"><i class="fas fa-chalkboard-teacher"></i> Класс: {{ lesson.school_class.name }}</p>
                                            <p class="details"><i class="fas fa-map-marker-alt"></i> Каб: {{ lesson.classroom }}</p>
                                        </div>
                                    {% empty %}
                                        <p style="font-size: 13px; text-align: center; color: var(--text-secondary); padding-top: 20px;">Нет уроков</p>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </section>
            </div>

            <!-- === НАЧАЛО: НОВЫЙ КОНТЕНТ ДЛЯ ВКЛАДКИ "ПОУРОЧНЫЕ ПЛАНЫ" === -->
            <div id="lesson-plans-content" class="tab-content">
                <main class="lp-widget">
                    <div class="widget-header">
                        <div class="widget-title">
                            <h2>Поурочные планы</h2>
                            <p>Управление планами уроков</p>
                        </div>
                        <button class="btn-create" id="create-plan-btn"><i class="fas fa-plus"></i> Создать план</button>
                    </div>

                    <table class="lp-table">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Класс</th>
                                <th>Предмет</th>
                                <th>Дата</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="lesson-plans-tbody">
                            {% for plan in lesson_plans %}
                            <tr id="plan-row-{{ plan.pk }}">
                                <td>{{ plan.name }}</td>
                                <td>{{ plan.school_class.name }}</td>
                                <td>{{ plan.subject.name }}</td>
                                <td>{{ plan.date|date:"d.m.Y" }}</td>
                                <td>
                                    <span class="lp-status {% if plan.status == 'approved' %}approved{% elif plan.status == 'rejected' %}rejected{% else %}pending{% endif %}">
                                        {{ plan.get_status_display }}
                                    </span>
                                </td>
                                <td class="lp-actions">
                                    <button class="view-plan-btn" data-plan-id="{{ plan.pk }}" title="Просмотр"><i class="far fa-eye"></i></button>
                                    <button class="edit-plan-btn" data-plan-id="{{ plan.pk }}" title="Редактировать"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-plan-btn" data-plan-id="{{ plan.pk }}" title="Удалить"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr id="no-plans-row">
                                <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                    Вы еще не создали ни одного поурочного плана.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </main>
            </div>
            <!-- === КОНЕЦ: НОВЫЙ КОНТЕНТ === -->
            
            <!-- Контент для вкладки "Журнал" -->
            <div id="journal-content" class="tab-content">
                <div class="journal-widget">
                    <div class="journal-header">
                        <div class="journal-title">
                            <h2>Электронный журнал</h2>
                            <p>Оценки и посещаемость учащихся</p>
                        </div>
                        <form method="get" id="filter-form" style="display: flex; gap: 16px;">
                            <select name="school_id" onchange="this.form.submit()" class="class-selector">
                                <option value="">Выберите школу</option>
                                {% for school in all_schools %}
                                    <option value="{{ school.pk }}" {% if school.pk == selected_school_id %}selected{% endif %}>{{ school.name }}</option>
                                {% endfor %}
                            </select>
                            <select name="class_id" onchange="this.form.submit()" class="class-selector">
                                <option value="">Выберите класс</option>
                                {% for class in teacher_classes %}
                                    <option value="{{ class.pk }}" {% if class.pk == selected_class_id %}selected{% endif %}>{{ class.name }}</option>
                                {% endfor %}
                            </select>
                            <select name="subject_id" onchange="this.form.submit()" class="class-selector">
                                <option value="">Выберите предмет</option>
                                {% for subject in teacher_subjects %}
                                    <option value="{{ subject.pk }}" {% if subject.pk == selected_subject_id %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    <div class="journal-tabs">
                        <button class="tab-btn active" data-content-type="grades">Оценки</button>
                        <button class="tab-btn" data-content-type="attendance">Посещаемость</button>
                    </div>

                    <div id="journal-content-container">
                        {% if selected_school_id and selected_class_id and selected_subject_id %}
                            {% include "partials/_attendance_table.html" %}
                        {% else %}
                            <p style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                Пожалуйста, выберите школу, класс и предмет для отображения журнала.
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- === НАЧАЛО: КОНТЕНТ ДЛЯ ВКЛАДКИ "ДОМАШНИЕ ЗАДАНИЯ" === -->
            <div id="homework-content" class="tab-content">
                 <main class="homework-widget">
                    <div class="widget-header">
                        <div class="widget-title">
                            <h2>Домашние задания</h2>
                            <p>Создание и проверка домашних заданий</p>
                        </div>
                        <button class="btn-create"><i class="fas fa-plus"></i> Создать задание</button>
                    </div>

                    <div class="homework-list" id="homework-list-container">
                        {% for hw in homeworks %}
                        <div class="homework-card" id="hw-card-{{ hw.pk }}">
                            <div class="hw-card-header">
                                <div class="hw-title-group">
                                    <h3>{{ hw.title }}</h3>
                                    <span class="hw-tag">{{ hw.school_class.name }}</span>
                                    <span class="hw-tag">{{ hw.subject.name }}</span>
                                </div>
                                <div class="hw-actions">
                                    <button class="edit-btn" data-hw-pk="{{ hw.pk }}"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-btn" data-hw-pk="{{ hw.pk }}"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <p class="hw-description">{{ hw.description|truncatewords:20 }}</p>
                            <div class="hw-card-footer">
                                <div class="hw-stats">
                                    <span>Сдано: {{ hw.submission_count }}</span> &nbsp;&nbsp;
                                    <span>Проверено: {{ hw.checked_count }} из {{ hw.submission_count }}</span>
                                </div>
                                <button class="btn-view-submissions" data-hw-pk="{{ hw.pk }}" data-hw-title="{{ hw.title }}" data-hw-info="{{ hw.school_class.name }} • {{ hw.subject.name }}">
                                    <i class="far fa-eye"></i> Просмотреть работы
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <p id="no-homeworks-message" style="text-align:center; color: var(--text-secondary); padding: 20px;">Вы еще не создали ни одного домашнего задания.</p>
                        {% endfor %}
                    </div>
                </main>
            </div>
            <!-- === КОНЕЦ: КОНТЕНТ ДЛЯ ВКЛАДКИ "ДОМАШНИЕ ЗАДАНИЯ" === -->

        </div>
    </main>
</div>

<!-- Модальное окно для Журнала -->
<div id="grade-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3 id="modal-student-name"></h3>
        <p id="modal-date"></p>
        <form id="grade-form">
            <input type="number" id="grade-input" min="0" max="100" placeholder="Оценка (0-100)">
            <textarea id="comment-input" placeholder="Комментарий к оценке..."></textarea>
            <button type="submit">Сохранить</button>
        </form>
    </div>
</div>

<!-- === НАЧАЛО: МОДАЛЬНЫЕ ОКНА ДЛЯ ДОМАШНИХ ЗАДАНИЙ (ВНЕ ОСНОВНОГО КОНТЕЙНЕРА) === -->
<div class="modal-overlay" id="homework-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-homework-modal">&times;</button>
        <div class="modal-header">
            <h2>Создать домашнее задание</h2>
            <p>Заполните информацию о домашнем задании</p>
        </div>
        <form id="homework-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group full-width" style="margin-top: 24px;">
                <label for="{{ homework_form.title.id_for_label }}">Название задания</label>
                {{ homework_form.title }}
            </div>
            <div class="form-grid">
                <div class="form-group"><label for="{{ homework_form.school_class.id_for_label }}">Класс</label>{{ homework_form.school_class }}</div>
                <div class="form-group"><label for="{{ homework_form.subject.id_for_label }}">Предмет</label>{{ homework_form.subject }}</div>
                <div class="form-group"><label for="{{ homework_form.due_date.id_for_label }}">Срок сдачи</label>{{ homework_form.due_date }}</div>
            </div>
            <div class="form-group full-width"><label for="{{ homework_form.description.id_for_label }}">Описание задания</label>{{ homework_form.description }}</div>
            <div class="form-group full-width"><label for="{{ homework_form.attached_file.id_for_label }}">Прикрепить файл (необязательно)</label>{{ homework_form.attached_file }}</div>
            <div class="modal-footer full-width">
                <button type="button" class="btn-secondary" id="cancel-homework-btn">Отмена</button>
                <button type="submit" class="btn-submit">Создать</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="submissions-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-submissions-modal">&times;</button>
        <div class="modal-header"><h2 id="submissions-modal-title"></h2><p id="submissions-modal-info"></p></div>
        <div class="submissions-table-container">
            <table class="submissions-table">
                <thead>
                    <!-- ИЗМЕНЕНА ЭТА СТРОКА -->
                    <tr><th>Ученик</th><th>Файл</th><th>Статус</th><th>Дата сдачи</th><th>Оценка</th><th>Действие</th></tr>
                </thead>
                <tbody id="submissions-tbody"></tbody>
            </table>
        </div>
        <div class="modal-footer"><button type="button" class="btn-secondary" id="cancel-submissions-btn">Закрыть</button></div>
    </div>
</div>
<div class="modal-overlay" id="grading-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-grading-modal">&times;</button>
        <div class="modal-header">
            <h2>Рецензия на работу</h2>
            <p id="grading-student-name"></p>
        </div>
        <form id="grading-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="grade-input">Оценка (0-100)</label>
                <input type="number" id="grade-input" name="grade" min="0" max="100" placeholder="Например, 85">
            </div>
            <div class="form-group">
                <label for="comment-textarea">Комментарий</label>
                <textarea id="comment-textarea" name="comment" placeholder="Отличная работа!"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancel-grading-btn">Отмена</button>
                <button type="submit" class="btn-gradient">Сохранить рецензию</button>
            </div>
        </form>
    </div>
</div>
<!-- === КОНЕЦ: МОДАЛЬНЫЕ ОКНА === -->

<!-- === НАЧАЛО: МОДАЛЬНЫЕ ОКНА ДЛЯ ПОУРОЧНЫХ ПЛАНОВ === -->
<div class="modal-overlay" id="plan-form-modal">
    <div class="modal-container">
        <button class="close-btn">&times;</button>
        <div class="modal-header">
            <h2 id="plan-modal-title">Создать план урока</h2>
            <p>Заполните информацию о поурочном плане</p>
        </div>
        <!-- === ИЗМЕНЕНИЕ 1: Добавлен enctype для загрузки файлов === -->
        <form id="lesson-plan-form" novalidate enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="plan_id" id="plan_id">
            <div class="form-grid">
                <div class="form-group">{{ lesson_plan_form.name.label_tag }} {{ lesson_plan_form.name }}</div>
                <div class="form-group">{{ lesson_plan_form.date.label_tag }} {{ lesson_plan_form.date }}</div>
                <div class="form-group">{{ lesson_plan_form.school_class.label_tag }} {{ lesson_plan_form.school_class }}</div>
                <div class="form-group">{{ lesson_plan_form.subject.label_tag }} {{ lesson_plan_form.subject }}</div>
            </div>
            <div class="form-group full-width">{{ lesson_plan_form.topic.label_tag }} {{ lesson_plan_form.topic }}</div>
            <div class="form-group full-width">{{ lesson_plan_form.goals_and_objectives.label_tag }} {{ lesson_plan_form.goals_and_objectives }}</div>
            
            <!-- === ИЗМЕНЕНИЕ 2: Обновленный блок для поля файла === -->
            <div class="form-group full-width">
                {{ lesson_plan_form.learning_materials.label_tag }}
                <div id="current-materials-file" style="margin-bottom: 8px; font-size: 14px;"></div>
                {{ lesson_plan_form.learning_materials }}
            </div>
            <!-- === КОНЕЦ ИЗМЕНЕНИЯ 2 === -->

            <div class="modal-footer full-width">
                <button type="button" class="btn-secondary close-btn">Отмена</button>
                <button type="submit" class="btn-submit">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="plan-view-modal">
    <div class="modal-container">
        <button class="close-btn">&times;</button>
        <div class="modal-header">
            <h2 id="view-plan-title"></h2>
            <p><span id="view-plan-class"></span> • <span id="view-plan-subject"></span> • <span id="view-plan-date"></span></p>
        </div>
        <dl class="lp-view-details">
            <dt>Тема урока</dt><dd id="view-plan-topic"></dd>
            <dt>Цели и задачи</dt><dd id="view-plan-goals"></dd>
            
            <!-- === ИЗМЕНЕНИЕ 3: Блок для отображения ссылки на файл === -->
            <dt>Учебные материалы</dt>
            <dd id="view-plan-materials">
                <a href="#" id="view-plan-materials-link" target="_blank" class="file-link" style="display: none;">
                    <i class="fas fa-paperclip"></i> <span></span>
                </a>
                <span id="no-materials-file" style="color: var(--text-secondary);">Нет файла</span>
            </dd>
            <!-- === КОНЕЦ ИЗМЕНЕНИЯ 3 === -->

        </dl>
        <div class="modal-footer"><button type="button" class="btn-secondary close-btn">Закрыть</button></div>
    </div>
</div>
<!-- === КОНЕЦ: МОДАЛЬНЫЕ ОКНА === -->


<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. ЛОГИКА ПЕРЕКЛЮЧЕНИЯ ОСНОВНЫХ ВКЛАДОК (Главная, Расписание, Журнал, ДЗ) ---
    const mainNavLinks = document.querySelectorAll('.td-main-nav a[data-tab]');
    const mainContentPanes = document.querySelectorAll('.tab-content');

    mainNavLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault();

            const tabId = this.getAttribute('data-tab');
            mainNavLinks.forEach(navLink => navLink.classList.remove('active'));
            this.classList.add('active');

            mainContentPanes.forEach(pane => {
                pane.classList.toggle('active', pane.id === tabId + '-content');
            });
        });
    });

    // --- 2. ЛОГИКА ДЛЯ ВКЛАДКИ "ЖУРНАЛ" (внутренние табы, модальные окна и AJAX) ---
    const journalContainer = document.getElementById('journal-content');
    if (journalContainer) {
        const journalContentContainer = journalContainer.querySelector('#journal-content-container');
        const journalTabsContainer = journalContainer.querySelector('.journal-tabs');
        const modal = document.getElementById('grade-modal');

        journalTabsContainer.addEventListener('click', async function(e) {
            if (!e.target.classList.contains('tab-btn')) return;
            
            journalTabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            const contentType = e.target.dataset.contentType;
            const params = new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString();
            if (!params.includes('class_id')) return;

            const url = (contentType === 'attendance') ? `{% url 'journal_attendance_content' %}?${params}` : `{% url 'teacher_journal_grades_content' %}?${params}`;
            
            try {
                journalContentContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Загрузка...</p>';
                const response = await fetch(url);
                journalContentContainer.innerHTML = await response.text();
            } catch (error) {
                journalContentContainer.innerHTML = '<p style="color: red; text-align: center;">Ошибка загрузки</p>';
            }
        });

        journalContentContainer.addEventListener('click', function(e) {
            const gradeCell = e.target.closest('.grade-cell');
            if (gradeCell) handleGradeCellClick(gradeCell);

            const attendanceCell = e.target.closest('.attendance-cell');
            if (attendanceCell) handleAttendanceCellClick(attendanceCell);
        });

        const gradeForm = document.getElementById('grade-form');
        let activeGradeCell = null;

        function handleGradeCellClick(cell) {
            activeGradeCell = cell;
            modal.querySelector('#modal-student-name').textContent = `Оценка для: ${cell.closest('tr').cells[0].textContent.trim()}`;
            modal.querySelector('#modal-date').textContent = `Дата: ${cell.dataset.date}`;
            modal.querySelector('#grade-input').value = cell.textContent.trim().replace(/[^0-9]/g, '');
            modal.querySelector('#comment-input').value = cell.dataset.comment || '';
            modal.style.display = 'block';
            modal.querySelector('#grade-input').focus();
        }

        async function handleAttendanceCellClick(cell) {
            const statuses = ['P', 'L', 'A'];
            const currentStatus = cell.dataset.status;
            const nextStatus = statuses[(statuses.indexOf(currentStatus) + 1) % statuses.length];
            
            const row = cell.closest('tr');
            const absentCountCell = row.querySelector('.absent-count');
            let currentAbsences = parseInt(absentCountCell.textContent);
            if (currentStatus === 'A' && nextStatus !== 'A') {
                absentCountCell.textContent = currentAbsences - 1;
            } else if (currentStatus !== 'A' && nextStatus === 'A') {
                absentCountCell.textContent = currentAbsences + 1;
            }

            updateAttendanceIcon(cell, nextStatus);

            const payload = {
                student_id: cell.dataset.studentId, date: cell.dataset.date,
                subject_id: cell.closest('tbody').dataset.subjectId, class_id: cell.closest('tbody').dataset.classId,
                status: nextStatus
            };
            
            try {
                const response = await fetch("{% url 'api_set_attendance' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                    body: JSON.stringify(payload)
                });
                if (!response.ok) updateAttendanceIcon(cell, currentStatus);
            } catch (error) {
                updateAttendanceIcon(cell, currentStatus);
            }
        }
        
        gradeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const payload = {
                student_id: activeGradeCell.dataset.studentId, date: activeGradeCell.dataset.date,
                subject_id: activeGradeCell.closest('tbody').dataset.subjectId, class_id: activeGradeCell.closest('tbody').dataset.classId,
                grade: document.getElementById('grade-input').value,
                comment: document.getElementById('comment-input').value
            };
            const response = await fetch("{% url 'api_set_grade' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                body: JSON.stringify(payload)
            });
            if (response.ok) {
                const result = await response.json();
                updateGradeCell(activeGradeCell, result.grade, result.has_comment);
                activeGradeCell.dataset.comment = payload.comment;
                modal.style.display = 'none';
            } else { alert('Ошибка сохранения оценки!'); }
        });

        modal.querySelector('.close-btn').addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (e) => { if (e.target == modal) modal.style.display = 'none'; });
    }
    
    // === ЛОГИКА ЗАГРУЗКИ ЖУРНАЛА ПРИ ПЕРЕХОДЕ ПО URL С ПАРАМЕТРАМИ ===
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('school_id') && urlParams.has('class_id') && urlParams.has('subject_id')) {
        const journalTabLink = document.querySelector('a[data-tab="journal"]');
        const gradesSubTab = document.querySelector('#journal-content .tab-btn[data-content-type="grades"]');

        if (journalTabLink && gradesSubTab) {
            if (!journalTabLink.classList.contains('active')) {
                journalTabLink.click();
            }
            gradesSubTab.click();
        }
    } 
    else if (urlParams.has('school_id') || urlParams.has('class_id')) {
        const journalTabLink = document.querySelector('a[data-tab="journal"]');
        if (journalTabLink && !journalTabLink.classList.contains('active')) {
            journalTabLink.click();
        }
    }

    // === JAVASCRIPT ДЛЯ ЛОГИКИ ДОМАШНИХ ЗАДАНИЙ ===
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const homeworkTab = document.getElementById('homework-content');
    if (homeworkTab) {
        const homeworkListContainer = document.getElementById('homework-list-container');
        const homeworkModal = document.getElementById('homework-modal');
        const submissionsModal = document.getElementById('submissions-modal');
        const gradingModal = document.getElementById('grading-modal');
        
        if (homeworkModal && homeworkListContainer) {
            const openCreateBtn = homeworkTab.querySelector('.btn-create');
            const homeworkForm = document.getElementById('homework-form');
            const modalTitle = homeworkModal.querySelector('.modal-header h2');
            const submitButton = homeworkForm.querySelector('button[type="submit"]');
            const closeModalBtn = document.getElementById('close-homework-modal');
            const cancelModalBtn = document.getElementById('cancel-homework-btn');

            const openModalForCreate = () => {
                modalTitle.textContent = 'Создать домашнее задание';
                submitButton.textContent = 'Создать';
                homeworkForm.reset();
                homeworkForm.setAttribute('action', "{% url 'api_create_homework' %}");
                homeworkModal.style.display = 'flex';
            };

            const openModalForEdit = async (homeworkId) => {
                modalTitle.textContent = 'Редактировать задание';
                submitButton.textContent = 'Сохранить';
                homeworkForm.reset();
                homeworkForm.setAttribute('action', `/api/homework/${homeworkId}/update/`);
                try {
                    const response = await fetch(`/api/homework/${homeworkId}/details/`);
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    
                    const data = result.data;
                    homeworkForm.querySelector('#id_title').value = data.title;
                    homeworkForm.querySelector('#id_description').value = data.description;
                    homeworkForm.querySelector('#id_school_class').value = data.school_class;
                    homeworkForm.querySelector('#id_subject').value = data.subject;
                    homeworkForm.querySelector('#id_due_date').value = data.due_date;
                    homeworkModal.style.display = 'flex';
                } catch (error) {
                    alert('Не удалось загрузить данные задания: ' + error.message);
                }
            };

            const closeModal = () => { homeworkModal.style.display = 'none'; };

            openCreateBtn.addEventListener('click', openModalForCreate);
            closeModalBtn.addEventListener('click', closeModal);
            cancelModalBtn.addEventListener('click', closeModal);
            homeworkModal.addEventListener('click', (e) => { if (e.target === homeworkModal) closeModal(); });

            homeworkForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const actionUrl = this.getAttribute('action');
                try {
                    const response = await fetch(actionUrl, {
                        method: 'POST', body: formData, headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message || 'Успешно сохранено!');
                        window.location.reload(); 
                    } else {
                        const errorMessages = Object.values(result.errors).map(err => err[0]).join('\n');
                        alert("Ошибка валидации:\n" + errorMessages);
                    }
                } catch (error) {
                    alert('Произошла сетевая ошибка.');
                }
            });
            
            homeworkListContainer.addEventListener('click', function(e) {
                const editButton = e.target.closest('.edit-btn');
                if (editButton) {
                    openModalForEdit(editButton.dataset.hwPk);
                }
            });
        }

        if (submissionsModal && homeworkListContainer) {
            const submissionsTbody = document.getElementById('submissions-tbody');

            const openSubmissionsModal = async (hwId, hwTitle, hwInfo) => {
                submissionsModal.querySelector('#submissions-modal-title').textContent = hwTitle;
                submissionsModal.querySelector('#submissions-modal-info').textContent = hwInfo;
                submissionsTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Загрузка...</td></tr>';
                submissionsModal.style.display = 'flex';

                try {
                    const response = await fetch(`/api/homework/${hwId}/submissions/`);
                    const data = await response.json();
                    if (!response.ok || data.status !== 'success') throw new Error(data.message || 'Не удалось загрузить данные.');

                    submissionsTbody.innerHTML = '';
                    if (data.submissions.length === 0) {
                        submissionsTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Работы еще не сданы.</td></tr>';
                        return;
                    }

                    data.submissions.forEach(sub => {
                        let fileHtml = '<td>-</td>';
                        if (sub.file_url) {
                            fileHtml = `<td><a href="${sub.file_url}" class="file-link" target="_blank" title="Открыть файл"><i class="fas fa-paperclip"></i> Посмотреть</a></td>`;
                        }
                        
                        let statusHtml;
                        if (sub.status === 'Проверено') statusHtml = `<span class="status-tag status-checked"><i class="fas fa-check-circle"></i> Проверено</span>`;
                        else if (sub.status === 'Сдано') statusHtml = `<span class="status-tag status-submitted"><i class="fas fa-check"></i> Сдано</span>`;
                        else statusHtml = `<span class="status-tag status-awaiting"><i class="far fa-clock"></i> Ожидается</span>`;
                        
                        const gradeHtml = sub.grade !== null ? `<td><span class="grade-circle">${sub.grade}</span></td>` : '<td>-</td>';
                        const actionButton = sub.status !== 'Ожидается' ? `<button class="btn-view-submissions" style="padding: 6px 10px; font-size: 12px;">${sub.status === 'Проверено' ? 'Изменить' : 'Проверить'}</button>` : '-';
                        const actionHtml = `<td data-submission-pk="${sub.submission_id}" data-student-name="${sub.full_name}" data-grade="${sub.grade || ''}" data-comment="${sub.teacher_comment || ''}">${actionButton}</td>`;

                        const row = `<tr id="sub-row-${sub.submission_id}"><td>${sub.full_name}</td>${fileHtml}<td>${statusHtml}</td><td>${sub.submitted_at || '-'}</td>${gradeHtml}${actionHtml}</tr>`;
                        submissionsTbody.insertAdjacentHTML('beforeend', row);
                    });
                } catch (error) {
                    submissionsTbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: red;">${error.message}</td></tr>`;
                }
            };

            const closeSubmissionsModal = () => { submissionsModal.style.display = 'none'; };
            submissionsModal.querySelector('#close-submissions-modal').addEventListener('click', closeSubmissionsModal);
            submissionsModal.addEventListener('click', (e) => { if (e.target === submissionsModal) closeSubmissionsModal(); });
            
            homeworkListContainer.addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.btn-view-submissions');
                if (viewBtn) {
                    openSubmissionsModal(viewBtn.dataset.hwPk, viewBtn.dataset.hwTitle, viewBtn.dataset.hwInfo);
                }
            });
        }

        if (gradingModal) {
            const submissionsTbody = document.getElementById('submissions-tbody');
            const gradingForm = document.getElementById('grading-form');
            const studentNameEl = document.getElementById('grading-student-name');
            const gradeInput = gradingModal.querySelector('#grade-input');
            const commentTextarea = gradingModal.querySelector('#comment-textarea');
            let currentSubmissionRow = null;

            const openGradingModal = (cell) => {
                const { submissionPk, studentName, grade, comment } = cell.dataset;
                currentSubmissionRow = document.getElementById(`sub-row-${submissionPk}`);
                studentNameEl.textContent = studentName;
                gradeInput.value = grade || "";
                commentTextarea.value = comment || "";
                gradingForm.dataset.submissionPk = submissionPk;
                gradingModal.style.display = 'flex';
            };

            const closeGradingModal = () => { gradingModal.style.display = 'none'; };
            gradingModal.querySelector('#close-grading-modal').addEventListener('click', closeGradingModal);
            gradingModal.querySelector('#cancel-grading-btn').addEventListener('click', closeGradingModal);
            gradingModal.addEventListener('click', (e) => { if (e.target === gradingModal) closeGradingModal(); });

            gradingForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submissionPk = this.dataset.submissionPk;
                const grade = gradeInput.value;
                const comment = commentTextarea.value;

                try {
                    const response = await fetch(`/api/submission/${submissionPk}/grade/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                        body: JSON.stringify({ grade: grade, comment: comment }),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);

                    if (currentSubmissionRow) {
                        const statusCell = currentSubmissionRow.cells[2];
                        const gradeCell = currentSubmissionRow.cells[4];
                        const actionCell = currentSubmissionRow.cells[5];
                        
                        statusCell.innerHTML = `<span class="status-tag status-checked"><i class="fas fa-check-circle"></i> Проверено</span>`;
                        gradeCell.innerHTML = result.new_grade ? `<span class="grade-circle">${result.new_grade}</span>` : '-';
                        actionCell.dataset.grade = result.new_grade || "";
                        actionCell.dataset.comment = comment;
                        actionCell.querySelector('button').textContent = 'Изменить';
                    }
                    closeGradingModal();
                } catch (error) {
                    alert(`Ошибка: ${error.message}`);
                }
            });

            submissionsTbody.addEventListener('click', (e) => {
                const checkBtn = e.target.closest('td > button');
                if (checkBtn) {
                    openGradingModal(checkBtn.parentElement);
                }
            });
        }
    }
    
    // === JAVASCRIPT ДЛЯ ЛОГИКИ ПОУРОЧНЫХ ПЛАНОВ ===
    const lessonPlansTab = document.getElementById('lesson-plans-content');
    if (lessonPlansTab) {
        const createPlanBtn = document.getElementById('create-plan-btn');
        const plansTbody = document.getElementById('lesson-plans-tbody');
        
        // Модальные окна
        const formModal = document.getElementById('plan-form-modal');
        const viewModal = document.getElementById('plan-view-modal');
        
        // Форма и ее элементы
        const planForm = document.getElementById('lesson-plan-form');
        const planModalTitle = document.getElementById('plan-modal-title');
        const planIdInput = document.getElementById('plan_id');
        const currentFileDiv = document.getElementById('current-materials-file');

        // Открытие/закрытие модальных окон
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        formModal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(formModal)));
        viewModal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(viewModal)));

        // 1. Открытие модального окна для СОЗДАНИЯ плана
        createPlanBtn.addEventListener('click', () => {
            planForm.reset();
            planIdInput.value = '';
            currentFileDiv.innerHTML = ''; // Очищаем информацию о текущем файле
            planModalTitle.textContent = 'Создать план урока';
            planForm.querySelector('button[type="submit"]').textContent = 'Создать';
            openModal(formModal);
        });

        // 2. Обработка кликов по кнопкам в таблице (просмотр, редактирование, удаление)
        plansTbody.addEventListener('click', async (e) => {
            const viewBtn = e.target.closest('.view-plan-btn');
            const editBtn = e.target.closest('.edit-plan-btn');
            const deleteBtn = e.target.closest('.delete-plan-btn');
            
            if (viewBtn) {
                const planId = viewBtn.dataset.planId;
                // Запрос на сервер для получения данных...
                const response = await fetch(`/api/lesson-plans/${planId}/details/`);
                if (response.ok) {
                    const { data } = await response.json();
                    document.getElementById('view-plan-title').textContent = data.name;
                    // API должен возвращать имена, а не ID, для лучшего отображения.
                    // Для примера оставим так, но лучше доработать API.
                    document.getElementById('view-plan-class').textContent = `Класс ID: ${data.school_class}`;
                    document.getElementById('view-plan-subject').textContent = `Предмет ID: ${data.subject}`;
                    document.getElementById('view-plan-date').textContent = data.date;
                    document.getElementById('view-plan-topic').textContent = data.topic || '-';
                    document.getElementById('view-plan-goals').textContent = data.goals_and_objectives || '-';
                    
                    const link = document.getElementById('view-plan-materials-link');
                    const noFile = document.getElementById('no-materials-file');
                    if(data.learning_materials_url) {
                        link.href = data.learning_materials_url;
                        link.querySelector('span').textContent = data.learning_materials_name;
                        link.style.display = 'inline-flex';
                        noFile.style.display = 'none';
                    } else {
                        link.style.display = 'none';
                        noFile.style.display = 'inline';
                    }
                    openModal(viewModal);
                } else {
                    alert('Не удалось загрузить данные плана.');
                }
            }

            if (editBtn) {
                const planId = editBtn.dataset.planId;
                const response = await fetch(`/api/lesson-plans/${planId}/details/`);
                if (response.ok) {
                    const { data } = await response.json();
                    planForm.reset();
                    planIdInput.value = data.id;
                    planModalTitle.textContent = 'Редактировать план урока';
                    planForm.querySelector('button[type="submit"]').textContent = 'Сохранить';

                    // Заполняем поля формы
                    planForm.querySelector('[name="name"]').value = data.name;
                    planForm.querySelector('[name="date"]').value = data.date;
                    planForm.querySelector('[name="school_class"]').value = data.school_class;
                    planForm.querySelector('[name="subject"]').value = data.subject;
                    planForm.querySelector('[name="topic"]').value = data.topic;
                    planForm.querySelector('[name="goals_and_objectives"]').value = data.goals_and_objectives;
                    
                    if (data.learning_materials_url) {
                        currentFileDiv.innerHTML = `Текущий файл: <a href="${data.learning_materials_url}" target="_blank">${data.learning_materials_name}</a>`;
                    } else {
                        currentFileDiv.innerHTML = '';
                    }

                    openModal(formModal);
                } else {
                    alert('Не удалось загрузить данные плана для редактирования.');
                }
            }

            if (deleteBtn) {
                if (confirm('Вы уверены, что хотите удалить этот план?')) {
                    const planId = deleteBtn.dataset.planId;
                    // === ИСПРАВЛЕНИЕ 2: Получаем CSRF-токен перед отправкой ===
                    const csrfToken = planForm.querySelector('input[name="csrfmiddlewaretoken"]').value;

                    const response = await fetch(`/api/lesson-plans/${planId}/delete/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken }
                    });
                    if (response.ok) {
                        document.getElementById(`plan-row-${planId}`).remove();
                    } else {
                        alert('Не удалось удалить план.');
                    }
                }
            }
        });

        // 3. Отправка формы (создание/редактирование)
        planForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // === ИСПРАВЛЕНИЕ 1: Используем правильное имя переменной "planForm" ===
            const csrfToken = planForm.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const formData = new FormData(this);
            const response = await fetch("{% url 'api_manage_lesson_plan' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            });
            
            if (response.ok) {
                window.location.reload(); // Перезагружаем страницу для обновления таблицы
            } else {
                const result = await response.json();
                alert('Ошибка сохранения: ' + JSON.stringify(result.errors || result.message));
            }
        });
    }
    
    // Глобальный listener для Escape, который закрывает все модальные окна
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay, .modal').forEach(modal => modal.style.display = 'none');
        }
    });

    // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ (общие для журнала и ДЗ) ---
    function updateGradeCell(cell, gradeValue, hasComment) {
        if (gradeValue === null || gradeValue === '') {
            cell.innerHTML = '<span style="color: var(--text-secondary); font-size: 20px;">+</span>';
            return;
        }
        const gradeInt = parseInt(gradeValue);
        let badgeClass = (gradeInt >= 85) ? 'grade-5' : (gradeInt >= 65) ? 'grade-4' : 'grade-3';
        const commentIcon = hasComment ? '<span class="grade-comment-icon">💬</span>' : '';
        cell.innerHTML = `<div class="grade-badge-container"><div class="grade-badge ${badgeClass}">${gradeInt}</div>${commentIcon}</div>`;
    }
    function updateAttendanceIcon(cell, statusCode) { 
        let iconHtml = '';
        if (statusCode === 'P') iconHtml = '<span class="attendance-icon status-P">✓</span>';
        else if (statusCode === 'A') iconHtml = '<span class="attendance-icon status-A">✕</span>';
        else if (statusCode === 'L') iconHtml = '<span class="attendance-icon status-L">!</span>';
        cell.innerHTML = iconHtml;
        cell.dataset.status = statusCode;
    }
});
</script>

</body>
</html>