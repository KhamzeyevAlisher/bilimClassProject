{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашборд Учителя | Школьная Платформа</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/teacher_homework.css' %}">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/teacher_dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/base.css' %}">    

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-main: #F9FAFB; --bg-widget: #FFFFFF; --text-primary: #111827;
            --text-secondary: #6B7280; --border-color: #E5E7EB; --accent-primary: #4F46E5;
            --accent-light: #EEF2FF; --accent-blue: #3B82F6; --accent-orange: #F97316;
            --accent-purple: #8B5CF6; --accent-red: #EF4444; --accent-green: #10B981;
            /* Стили для журнала */
            --grade-5:#D1FAE5; --grade-5-text:#065F46; --grade-4:#DBEAFE;
            --grade-4-text:#1E40AF; --grade-3:#FEF3C7; --grade-3-text:#92400E;
            /* Тень для виджетов */
            --widget-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--accent-light); color: var(--text-primary); }
        .td-container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .td-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .td-logo-section { display: flex; align-items: center; gap: 12px; }
        .td-logo-icon { width: 40px; height: 40px; background-color: var(--accent-primary); border-radius: 8px; color: white; display: grid; place-items: center; font-size: 20px; }
        .td-logo-section h1 { font-size: 18px; } .td-logo-section p { font-size: 14px; color: var(--text-secondary); }
        .td-user-section { display: flex; align-items: center; gap: 16px; }
        .td-user-info { text-align: right; } .td-user-info h3 { font-weight: 600; }
        .td-user-info p { font-size: 14px; color: var(--text-secondary); }
        .td-user-link { text-decoration: none; color: inherit; }
        .td-user-avatar { width: 40px; height: 40px; border-radius: 50%; background-color: #D8B4FE; color: #581C87; display: grid; place-items: center; font-weight: 600; }
        .td-main-grid { display: grid; }
        .td-main-nav { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 24px; box-shadow: var(--widget-shadow); }
        .td-main-nav ul { display: flex; list-style: none; gap: 8px; }
        .td-main-nav a { display: flex; align-items: center; gap: 8px; padding: 10px 16px; text-decoration: none; color: var(--text-secondary); font-weight: 600; border-radius: 8px; transition: all 0.2s; cursor: pointer; }
        .td-main-nav a:hover { background-color: #F3F4F6; color: var(--text-primary); }
        .td-main-nav a.active { background-color: var(--accent-light); color: var(--accent-primary); }
        .td-card { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 12px; padding: 24px; box-shadow: var(--widget-shadow); }
        .td-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .td-card-header i { color: var(--text-secondary); } .td-card-header h3 { font-size: 18px; font-weight: 600; }
        .td-card-subtitle { color: var(--text-secondary); margin-bottom: 20px; }
        
        .td-stats-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
        .td-stat-card {
            background-color: var(--bg-widget);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--widget-shadow);
        }
        .td-stat-card .stat-info p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0 0 4px 0;
        }
        .td-stat-card .stat-info h2 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            font-size: 20px;
            color: #FFFFFF;
        }

        .stat-icon i { margin-top: 12px;}

        .stat-icon.blue { background-color: var(--accent-blue); }
        .stat-icon.orange { background-color: var(--accent-orange); }
        .stat-icon.purple { background-color: var(--accent-purple); }
        .stat-icon.red { background-color: var(--accent-red); }

        .td-schedule-list { display: flex; flex-direction: column; gap: 12px; }
        .td-lesson-item { display: flex; align-items: center; gap: 16px; padding: 16px; border-radius: 10px; background-color: #F9FAFB; }
        .td-lesson-time p { font-weight: 600; } .td-lesson-info { flex-grow: 1; }
        .td-right-column { display: flex; flex-direction: column; gap: 24px; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        
        /* СТИЛИ ДЛЯ РАСПИСАНИЯ — обновлённый, более современный вид */
        .schedule-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .schedule-stat-item {
            background: linear-gradient(180deg, #ffffff 0%, #fbfbfd 100%);
            border-radius: 12px;
            padding: 18px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 6px 18px rgba(16,24,40,0.06);
            border: 1px solid rgba(15,23,42,0.04);
        }
        .schedule-stat-item .icon-bg {
            font-size: 18px;
            width: 52px;
            height: 52px;
            border-radius: 10px;
            display: grid;
            place-items: center;
            color: #fff;
        }
        .schedule-stat-item .icon-bg.blue { background-image: linear-gradient(135deg,#60A5FA,#3B82F6); }
        .schedule-stat-item .icon-bg.purple { background-image: linear-gradient(135deg,#A78BFA,#7C3AED); }
        .schedule-stat-item .icon-bg.green { background-image: linear-gradient(135deg,#86EFAC,#10B981); }

        .schedule-week-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
        }
        .schedule-day-column {
            background: transparent;
            border-radius: 12px;
            padding: 0;
        }
        .schedule-day-column .day-header {
            margin-bottom: 12px;
            text-align: center;
            padding: 12px 8px;
            border-radius: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        .schedule-day-column.today .day-header {
            background-color: var(--accent-light);
            border: 1px solid var(--accent-primary);
        }
        .lessons-list { display: flex; flex-direction: column; gap: 12px; padding: 12px; }
        .lesson-card {
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: var(--bg-widget);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px;
            box-shadow: var(--widget-shadow);
        }
        .lesson-card .time { color: var(--text-secondary); font-size: 13px; }
        .lesson-card .subject { font-weight: 700; font-size: 15px; color: var(--text-primary); }
        .lesson-card .details { color: var(--text-secondary); font-size: 13px; display:flex; gap:8px; align-items:center; }

        /* СТИЛИ ДЛЯ ЖУРНАЛА */
        .journal-widget { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; box-shadow: var(--widget-shadow); }
        .journal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .journal-title h2 { font-size: 20px; font-weight: 600; }
        .journal-title p { color: var(--text-secondary); }
        .class-selector {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            font-weight: 500;
            background-color: #F9FAFB;
            font-family: 'Inter', sans-serif;
            font-size: 14px;
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right .75rem center;
            background-repeat: no-repeat;
            background-size: 1.1em 1.1em;
            padding-right: 2.5rem;
            color: var(--text-primary);
            transition: box-shadow .15s ease, border-color .15s ease, transform .06s ease;
        }
        .class-selector:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 6px 18px rgba(79,70,229,0.08);
            transform: translateY(-1px);
        }
        /* Modern option styling (best-effort across browsers) */
        .class-selector option {
            background: #ffffff;
            color: var(--text-primary);
            padding: 8px 12px;
        }
        /* Remove native dropdown arrow on IE/Edge and style the control */
        .class-selector::-ms-expand { display: none; }
        /* Chrome/Safari: subtle scrollbar for long option lists */
        .class-selector::-webkit-scrollbar { width: 8px; }
        .class-selector::-webkit-scrollbar-thumb { background: rgba(16,24,40,0.08); border-radius: 8px; }
        /* Accent color for native selects in modern browsers */
        .class-selector { accent-color: var(--accent-primary); }
        .journal-tabs { display: flex; gap: 8px; margin-bottom: 24px; }
        .tab-btn { padding: 8px 16px; background: transparent; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; cursor: pointer; font-family: 'Inter', sans-serif; font-size: 14px; transition: all .2s; }
        .tab-btn.active { background-color: var(--accent-primary); border-color: var(--accent-primary); color: #fff; }
        .journal-table { width: 100%; border-collapse: collapse; display: table; }
        .journal-table tr { display: table-row; }
        .journal-table th, .journal-table td { display: table-cell; vertical-align: middle; }
        .journal-table th { font-size: 12px; text-transform: uppercase; color: var(--text-secondary); font-weight: 600; text-align: center; padding-bottom: 16px; }
        .journal-table th:first-child { text-align: left; }
        .journal-table td { padding: 6px; text-align: center; border-bottom: 1px solid var(--border-color); }
        .journal-table tr:last-child td { border-bottom: none; }
        .journal-table td:first-child { text-align: left; font-weight: 500; }
        .grade-cell {background-color: #EFF6FF; margin-left: 50%; transform: translateX(-50%); width:73px; border: 1px solid #90a5ea; cursor:pointer;border-radius:8px;min-height:48px;display:flex;align-items:center;justify-content:center;transition:background-color .2s}
        .attendance-cell {background-color: #EFF6FF; width:100px; border: 1px solid #90a5ea; cursor:pointer;border-radius:8px;min-height:48px;display:flex;align-items:center;justify-content:center;transition:background-color .2s}
        .grade-cell:hover, .attendance-cell:hover{background-color:#EFF6FF}
        .grade-badge{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;font-weight:700;font-size:16px}
        .grade-5{background-color:var(--grade-5);color:var(--grade-5-text)}.grade-4{background-color:var(--grade-4);color:var(--grade-4-text)}.grade-3{background-color:var(--grade-3);color:var(--grade-3-text)}
        .grade-badge-container{position:relative;display:inline-flex}
        .grade-comment-icon{font-size:10px;color:var(--text-secondary);position:absolute;bottom:5px;right:5px}
        .attendance-icon{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;font-weight:bold;font-size:16px}
        .status-P{color:#059669;background-color:#ECFDF5}.status-A{color:#DC2626;background-color:#FEF2F2}.status-L{color:#D97706;background-color:#FFFBEB}
        .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.5)}
        .modal-content{background-color:#F9FAFB;margin:15% auto;padding:20px;border:none;width:90%;max-width:400px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.1)}
        .close-btn{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}
        #grade-form input,#grade-form textarea{width:100%;padding:12px;font-size:16px;border:1px solid var(--border-color);border-radius:8px;margin:10px 0;font-family:'Inter',sans-serif}
        #grade-form button{width:100%;padding:12px;background-color:var(--accent-primary);color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
        
        /* СТИЛИ ДЛЯ ПОУРОЧНЫХ ПЛАНОВ */
        .lp-widget { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; box-shadow: var(--widget-shadow); }
        
        /* СТИЛИ ДЛЯ ДОМАШНИХ ЗАДАНИЙ */
        .homework-widget { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; box-shadow: var(--widget-shadow); }
        .widget-header { display: flex; justify-content: space-between; align-items: center;  }
        .widget-title h2 { font-size: 20px; font-weight: 600; }
        .widget-title p { color: var(--text-secondary); }
        .btn-create { background-color: var(--accent-primary); color: white; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s; }
        .btn-create:hover { background-color: #4338CA; }
        .homework-list { display: flex; flex-direction: column; gap: 16px; }
        .homework-card { background-color: var(--bg-main); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; }
        .hw-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .hw-title-group { display: flex; align-items: center; gap: 12px; }
        .hw-title-group h3 { font-size: 16px; font-weight: 600; }
        .hw-tag { background-color: #E0E7FF; color: #3730A3; font-size: 12px; font-weight: 500; padding: 4px 10px; border-radius: 6px; }
        .hw-actions button { background: none; border: 1px solid var(--border-color); width: 32px; height: 32px; border-radius: 6px; cursor: pointer; color: var(--text-secondary); transition: all 0.2s; }
        .hw-actions button:hover { background-color: var(--accent-light); color: var(--accent-primary); }
        .hw-description { color: var(--text-secondary); margin-bottom: 16px; font-size: 14px; }
        .hw-card-footer { display: flex; justify-content: space-between; align-items: center; }
        .hw-stats { font-size: 13px; color: var(--text-secondary); }
        .btn-view-submissions { background-color: var(--bg-widget); border: 1px solid var(--border-color); color: var(--text-primary); padding: 8px 14px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s; }
        .btn-view-submissions:hover { background-color: #F3F4F6; }
        
        /* Стили для модальных окон */
        .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(17, 24, 39, 0.6); z-index: 1000; align-items: center; justify-content: center; }
        .modal-container { background-color: var(--bg-widget); border-radius: 12px; padding: 24px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { text-align: center; margin-bottom: 16px; }
        .modal-header h2 { font-size: 20px; }
        .modal-container .close-btn { position: absolute; top: 16px; right: 16px; background: #e5e7eb ; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
        .form-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .form-group.full-width { grid-column: 1 / -1; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; grid-column: 1 / -1; }
                /* Стили для кнопок в модальных окнах */
        .btn-secondary { 
            width: 40px;
            height: 40px;
            background-color: #f3f4f6;
            color: #6b7280;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .btn-secondary.close-btn::after {
            content: '\f00d';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
        }

        /* Стили для таблицы сданных работ */
        .submissions-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .submissions-table th, .submissions-table td { padding: 12px; border-bottom: 1px solid var(--border-color); text-align: left; font-size: 14px; }
        .submissions-table th { color: var(--text-secondary); font-weight: 600; }
        .status-tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 99px; font-weight: 500; font-size: 12px; }
        .status-checked { background-color: #D1FAE5; color: #065F46; }
        .status-submitted { background-color: #DBEAFE; color: #1E40AF; }
        .status-awaiting { background-color: #FEF3C7; color: #92400E; }
        .grade-circle { display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 50%; background-color: var(--accent-primary); color: white; font-weight: bold; }
        .file-link { color: var(--accent-primary); text-decoration: none; font-weight: 500; }
        .file-link i { margin-right: 4px; }

        /* --- КРАСИВЫЙ СТИЛЬ ДЛЯ ПОЛЯ ЗАГРУЗКИ ФАЙЛА --- */

/* Стиль для метки (label) над полем ввода */
.form-group label[for*="attached_file"] {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    font-size: 14px;
    color: var(--text-primary);
}

/* Стили для самого поля input[type=file] */
input[name="attached_file"] {
    width: 100%;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    color: var(--text-secondary);
    
    /* Для выравнивания и аккуратного вида */
    background-color: var(--bg-widget);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 4px;
}

/* Стиль для кнопки "Выберите файл" в современных браузерах */
input[name="attached_file"]::file-selector-button {
    /* Сбрасываем стандартные стили браузера */
    -webkit-appearance: none;
    appearance: none;
    
    /* Наши кастомные стили */
    background-color: var(--accent-primary);
    color: white;
    border: none;
    padding: 10px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-family: 'Inter', sans-serif;
    font-size: 14px;
    cursor: pointer;
    margin-right: 16px; /* Отступ между кнопкой и текстом с именем файла */
    transition: background-color 0.2s;
}

/* Эффект при наведении на кнопку */
input[name="attached_file"]::file-selector-button:hover {
    background-color: #4338CA; /* Более темный оттенок --accent-primary */
}

/* --- СТИЛЬ ДЛЯ ГРАДИЕНТНОЙ КНОПКИ --- */

.btn-gradient {
    /* Основные стили кнопки */
    border: none;
    border-radius: 8px;
    padding: 12px 20px;
    font-family: 'Inter', sans-serif;
    font-size: 16px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    
    /* Создание градиента */
    background-image: linear-gradient(to right, var(--accent-primary) 0%, var(--accent-purple) 100%);
    
    /* Тень для объема */
    box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2), 0 1px 2px rgba(0,0,0,0.05);
    
    /* Плавный переход для всех свойств */
    transition: all 0.2s ease-in-out;
}

/* Эффект при наведении курсора */
.btn-gradient:hover {
    /* Слегка приподнимаем кнопку */
    transform: translateY(-2px);
    /* Усиливаем тень для "парящего" эффекта */
    box-shadow: 0 6px 12px rgba(79, 70, 229, 0.3), 0 2px 4px rgba(0,0,0,0.1);
}

/* Эффект при нажатии на кнопку */
.btn-gradient:active {
    /* Возвращаем кнопку на место для эффекта "нажатия" */
    transform: translateY(0);
    /* Возвращаем стандартную тень */
    box-shadow: 0 2px 5px rgba(79, 70, 229, 0.2), 0 1px 2px rgba(0,0,0,0.05);
}


    </style>
    
    <!-- Lesson-plans: modern minimal table styling -->
    <style>

    .mobile-menu-header {
        display: none; /* Скрываем шапку по умолчанию */
    }
    .lp-widget { 
        background: transparent; 
        padding: 0; 
        /* margin-bottom: 32px;  */
    }
    .lp-widget .widget-header { 
        background: linear-gradient(180deg, #ffffff 0%, #fbfbfd 100%);
        padding: 24px;
        border-radius: 16px;
        box-shadow: 0 6px 18px rgba(16,24,40,0.06);
        border: 1px solid rgba(15,23,42,0.04);
        
    }
    .lp-widget .widget-title h2 { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
    .lp-widget .widget-title p { color: var(--text-secondary); font-size: 14px; }
    .lp-widget .btn-create {
        background-image: linear-gradient(135deg, #4338CA, #4F46E5);
        padding: 12px 18px;
        border-radius: 12px;
        font-weight: 600;
        font-size: 14px;
        box-shadow: 0 6px 18px rgba(79,70,229,0.14);
        transition: all 0.2s ease;
    }
    .lp-widget .btn-create:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(79,70,229,0.2);
    }
    .lp-table { width: 100%; border-collapse: separate; border-spacing: 0 12px; padding:0px 10px;}
    .lp-table thead th { text-align: left; padding: 12px 16px; color: var(--text-secondary); font-size: 12px; text-transform: uppercase; font-weight: 700; }
    .lp-table tbody tr { background: #fff; border-radius: 16px; box-shadow: 0 6px 18px rgba(16,24,40,0.04); display: table-row; }
    .lp-table td { padding: 24px; vertical-align: middle; font-size: 14px; color: var(--text-primary); }
    .lp-table td:first-child { font-weight: 600; border-radius: 16px 0 0 16px; }
    .lp-table td:last-child { border-radius: 0 16px 16px 0; }
    .lp-actions { display: flex; gap: 8px; justify-content: flex-end; }
    .lp-actions button { background: transparent; border: 1px solid rgba(15,23,42,0.06); width: 36px; height: 36px; border-radius: 8px; cursor: pointer; color: var(--text-secondary); display: grid; place-items: center; }
    .lp-actions button:hover { background: #F3F4F6; color: var(--text-primary); transform: translateY(-1px); }
    .lp-actions .view-plan-btn { border-color: rgba(79,70,229,0.12); }
    .lp-actions .edit-plan-btn { border-color: rgba(16,185,129,0.12); }
    .lp-actions .delete-plan-btn { border-color: rgba(239,68,68,0.08); }

    /* Status pills */
    .lp-status { padding: 6px 10px; border-radius: 999px; font-weight: 600; font-size: 13px; display: inline-flex; align-items: center; gap: 8px; }
    .lp-status.approved { background-color: #D1FAE5; color: #065F46; }
    .lp-status.pending { background-color: #FEF3C7; color: #92400E; }
    .lp-status.rejected { background-color: #FEE2E2; color: #991B1B; }

    /* Empty state card */
    #no-plans-row td { background: transparent; box-shadow: none; padding: 24px; }

    /* Responsive: stack rows on small screens */
    @media (max-width: 1000px) {
        .lp-table thead { display: none; }
        .lp-table tbody tr { display: block; padding: 12px; }
        .lp-table td { display: flex; justify-content: space-between; padding: 8px 0; border: none; }
        .lp-table td::before { content: attr(data-label); color: var(--text-secondary); font-weight: 600; margin-right: 12px; }
        .lp-table td:last-child { margin-top: 8px; }
    }
    </style>
    
    <!-- Modern overrides for teacher dashboard -->
    <style>
    /* Overall page polish */
    body.td-body { background: linear-gradient(180deg, #f8fafc 0%, #f3f4f6 100%); }

    /* Header: cleaner, slightly elevated */
    .td-header {
        background: #fff;
        padding: 18px 22px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(16,24,40,0.06);
        align-items: center;
    }
    .td-logo-icon { width:48px; height:48px; border-radius:12px; font-size:20px; }
    .td-logo-section h1 { font-size:18px; margin-bottom:4px; }
    .td-logo-section p { font-size:13px; color:var(--text-secondary); }

    /* User avatar and info */
    .td-user-section { gap:20px; }
    .td-user-avatar { width:48px; height:48px; border-radius:12px; font-size:16px; }

    /* Main navigation — pill style */
    .td-main-nav { padding:10px; display:flex; justify-content:start; }
    .td-main-nav ul { gap:12px; }
    .td-main-nav a { background:transparent; padding:10px 16px; border-radius:999px; box-shadow: none; }
    .td-main-nav a:hover { transform: translateY(-2px); }
    .td-main-nav a.active { background-image: linear-gradient(90deg, #6d28d9 0%, #4f46e5 100%); color:#fff; box-shadow: 0 6px 18px rgba(79,70,229,0.18); }

    /* Responsive stats grid */
    .td-stats-cards { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .td-stat-card { padding:18px; border-radius:12px; }
    .td-stat-card .stat-info p { color:var(--text-secondary); }

    /* Card surfaces and spacing */
    .td-card { padding:20px; border-radius:12px; }
    .td-card-header { gap:14px; }

    /* Schedule: compact day cards with subtle separators */
    .schedule-week-grid { gap:12px; }
    .schedule-day-column { background: transparent; }
    .schedule-day-column .day-header { font-size:15px; padding:10px; }
    .lessons-list { padding:8px; }
    .lesson-card { padding:10px; border-radius:10px; }
    .lesson-card .subject { font-size:14px; }

    /* Journal table — modernized */
    .journal-table th, .journal-table td { padding:12px 10px; }
    .journal-table th { background: transparent; font-size:12px; color:var(--text-secondary); }
    .journal-table td { background: #fff; border-radius:8px; border:1px solid rgba(229,231,235,0.6); }
    .journal-table tbody tr { display: grid; grid-template-columns: 1fr 240px 140px; gap:8px; align-items:center; margin-bottom:10px; }
    @media(min-width:1000px) { .journal-table tbody tr { display: table-row; } .journal-table td { border-radius: 6px; } }

    /* Homework and lesson-plan buttons uniform look */
    .btn-create, .btn-submit { border-radius: 10px; padding:10px 14px; font-weight:700; }
    .btn-create { background-image: linear-gradient(90deg,#4338CA,#4F46E5); color:#fff; box-shadow:0 6px 18px rgba(79,70,229,0.14); }

    /* Modal polish */
    .modal-overlay .modal-container { border-radius:12px; padding:20px; }
    .modal-container h2 { font-size:18px; }

    /* Small screens — tighten spacing */
    @media(max-width:1000px) {
        .td-header { flex-direction:column; gap:12px; align-items:flex-start; }
        .td-main-nav ul { flex-wrap:wrap; justify-content:center; }
        .journal-table tbody tr { grid-template-columns: 1fr; }
    }
    </style>

    <!-- Spacing fixes for lesson plans -->
    <style>
    .lp-widget .widget-header { padding: 20px !important; }
    .lp-widget .widget-title h2 { margin-bottom: 2px !important; }
    .lp-widget .widget-title p { font-size: 13px !important; }
    </style>

    <!-- Custom dropdown for journal selects (replaces native select for consistent styling) -->
    <style>
    .custom-select { position: relative; display: inline-block; min-width: 180px; }
    .custom-select-trigger {
        display: flex; align-items: center; justify-content: space-between;
        width: 100%; padding: 10px 16px; background: #F9FAFB; border: 1px solid var(--border-color);
        border-radius: 10px; cursor: pointer; font-size: 14px; color: var(--text-primary);
    }
    .custom-select-trigger:after { content: '\f107'; font-family: 'Font Awesome 5 Free'; font-weight: 900; margin-left: 8px; color: var(--text-secondary); }
    .custom-options { position: absolute; top: calc(100% + 8px); left: 0; right: 0; background: #fff; border-radius: 10px; box-shadow: 0 8px 24px rgba(16,24,40,0.08); list-style: none; padding: 8px 6px; margin: 0; max-height: 260px; overflow: auto; display: none; z-index: 1200; }
    .custom-options.open { display: block; }
    .custom-option { padding: 10px 12px; border-radius: 8px; cursor: pointer; color: var(--text-primary); font-size: 14px; }
    .custom-option:hover { background: #F3F4F6; }
    .custom-option.selected { background: linear-gradient(90deg, rgba(79,70,229,0.08), rgba(79,70,229,0.04)); color: var(--accent-primary); font-weight: 600; }
    .custom-select input[type="hidden"] { display: none; }
    @media(max-width:700px) { .custom-select { width: 100%; min-width: 0; } }

    /* =================================================================
   АДАПТИВНЫЕ СТИЛИ ДЛЯ МОБИЛЬНЫХ УСТРОЙСТВ
================================================================= */

/* --- Стили для планшетов и небольших ноутбуков (до 900px) --- */
@media (max-width: 900px) {
    .journal-table tbody tr {
        display: table-row; /* Возвращаем табличное отображение для планшетов */
    }
    .journal-table td {
        border-radius: 6px;
    }
}


/* --- Стили для мобильных устройств (до 780px) --- */
@media (max-width: 780px) {
    /* Адаптация таблицы поурочных планов */
    .lp-table thead {
        display: none; /* Скрываем заголовки таблицы */
    }
    .lp-table tbody tr {
        display: block; /* Строки становятся блоками */
        padding: 12px;
        margin-bottom: 12px; /* Добавляем отступ между карточками планов */
    }
    .lp-table td {
        display: flex; /* Используем flex для выравнивания */
        justify-content: space-between; /* Название слева, значение справа */
        padding: 8px 0;
        border: none;
        text-align: right; /* Выравниваем текст значения по правому краю */
    }
    .lp-table td:first-child {
        font-weight: 600; /* Имя ученика делаем жирным */
        text-align: left; /* А имя - по левому */
    }
    .lp-table td::before {
        content: attr(data-label); /* Добавляем подписи к данным из атрибута */
        color: var(--text-secondary);
        font-weight: 600;
        margin-right: 12px;
        text-align: left; /* Выравниваем подпись по левому краю */
    }
    .lp-table td:last-child {
        margin-top: 8px;
        justify-content: flex-end; /* Кнопки действий прижимаем вправо */
    }
    .lp-table td:last-child::before {
        display: none; /* Убираем подпись для блока с кнопками */
    }
}


/* --- Стили для мобильных устройств (до 700px) --- */
@media (max-width: 700px) {
    /* Общие изменения */
    body { font-size: 14px; }
    .custom-select { width: 100%; min-width: 0; }

    /* Шапка */
    .td-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
    }

    /* Статистика */
    .td-stats-cards {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }

    /* Основная сетка */
    .td-main-grid {
        grid-template-columns: 1fr;
    }
    
    /* Навигация */
    .td-main-nav ul {
        flex-wrap: wrap;
        justify-content: center;
    }

    /* Делаем таблицы горизонтально прокручиваемыми */
    #grades-table, #attendance-table, .lp-table, .submissions-table {
        display: block;
        width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch; /* Плавный скролл на iOS */
    }
    #grades-table thead, #attendance-table thead {
        display: table-header-group;
    }
    #grades-table tr, #attendance-table tr {
        display: flex;
    }
    #grades-table th, #grades-table td, #attendance-table th, #attendance-table td {
        white-space: nowrap; /* Запрещаем перенос строк в ячейках */
    }

    /* Адаптация таблицы журнала */
    .journal-table tbody tr {
        display: grid; /* Строки журнала становятся грид-контейнерами */
        grid-template-columns: 1fr; /* Все ячейки в одну колонку */
        gap: 8px;
        margin-bottom: 10px;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background-color: #fff;
    }
    .journal-table td {
        display: flex; /* Flex для выравнивания подписи и значения */
        justify-content: space-between;
        text-align: right;
        padding: 10px 0;
        border: none;
        background: transparent;
    }
    .journal-table td:first-child {
        padding-top: 0;
        font-size: 16px;
        justify-content: center; /* Имя студента по центру */
    }
    .journal-table td:first-child::before {
        display: none; /* Убираем псевдоэлемент для имени */
    }
    .journal-table td::before {
        content: attr(data-label); /* Добавляем подписи */
        font-weight: 500;
        color: var(--text-secondary);
        text-align: left;
    }

    /* Модальные окна */
    .modal-container {
        width: 96%;
        max-width: 96%;
        padding: 16px;
        border-radius: 10px;
    }
    .form-grid {
        grid-template-columns: 1fr !important;
    }
}


/* --- Стили для самых маленьких экранов (до 480px) --- */
@media (max-width: 480px) {
    /* Статистика в одну колонку */
    .td-stats-cards {
        grid-template-columns: 1fr;
    }

    /* Увеличиваем кнопки и значки для удобства нажатия */
    .grade-badge, .attendance-icon {
        min-width: 40px;
        height: 40px;
        font-size: 15px;
    }

    /* Скрываем менее важные колонки в таблице поурочных планов */
    .lp-table thead th:nth-child(3), /* Предмет */
    .lp-table tbody td:nth-child(3) {
        display: none;
    }
    
    /* Уменьшаем отступы в поле загрузки файла */
    input[type="file"] {
        padding: 8px;
    }
    input[type="file"]::file-selector-button {
        padding: 8px 12px;
        font-size: 13px;
    }
}

/* =================================================================
   УЛУЧШЕННЫЕ СТИЛИ ДЛЯ МОБИЛЬНЫХ УСТРОЙСТВ
   (для экранов шириной 768px и меньше)
================================================================= */
@media (max-width: 768px) {

    /* --- Общие улучшения для контейнера --- */
    .td-container {
        padding: 16px; /* Уменьшаем боковые отступы */
    }

    /* --- Новая мобильная шапка (Header) --- */
    .td-header {
        display: flex;
        flex-direction: row; /* Элементы в строку */
        justify-content: space-between; /* Логотип слева, аватар справа */
        align-items: center; /* Вертикальное выравнивание по центру */
        padding: 12px 16px;
    }
    
    .td-logo-section h1 {
        font-size: 16px; /* Немного уменьшаем заголовок */
        margin-bottom: 2px;
    }

    /* Скрываем подзаголовок и текстовую информацию о пользователе,
       чтобы оставить интерфейс чистым и оставить только самое важное. */
    .td-logo-section p,
    .td-user-info {
        display: none;
    }

    .td-logo-icon,
    .td-user-avatar {
        width: 44px;
        height: 44px;
    }

    /* --- Новая мобильная навигация (Grid Layout) --- */
    .td-main-nav {
        padding: 16px;
        background-color: transparent; /* Убираем фон у контейнера навигации */
        border: none;
        box-shadow: none;
    }

    .td-main-nav ul {
        display: grid;
        /* Создаем идеальную сетку 2x3 для 5-6 элементов */
        grid-template-columns: 1fr 1fr;
        gap: 12px; /* Расстояние между кнопками */
    }

    .td-main-nav a {
        /* Превращаем каждую ссылку в красивую кнопку */
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 16px 8px;
        font-size: 13px;
        gap: 10px; /* Отступ между иконкой и текстом */
        border-radius: 12px; /* Более современное скругление */
        background-color: var(--bg-widget); /* Белый фон */
        border: 1px solid var(--border-color); /* Тонкая рамка */
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .td-main-nav a:hover {
        transform: translateY(-2px); /* Эффект приподнимания при наведении */
        box-shadow: var(--widget-shadow);
    }
    
    .td-main-nav a i {
        font-size: 18px; /* Делаем иконки чуть крупнее */
    }

    /* Стиль для активной/выбранной кнопки */
    .td-main-nav a.active {
        background-image: linear-gradient(135deg, #6d28d9, #4f46e5);
        color: #fff;
        border-color: transparent;
        box-shadow: 0 6px 18px rgba(79, 70, 229, 0.2);
    }

    .td-main-nav a.active i {
        color: #fff;
    }
}

/* =================================================================
   СТИЛИ ДЛЯ МОБИЛЬНОГО БУРГЕР-МЕНЮ
================================================================= */

/* Сначала скрываем новую мобильную панель на больших экранах */
.td-mobile-nav {
    display: none;
}

/* Применяем стили, когда ширина экрана 768px или меньше */
@media (max-width: 768px) {

    /* --- 1. Стили для верхней мобильной панели (остаются без изменений) --- */
    .td-mobile-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 16px;
        background-color: var(--bg-widget);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        box-shadow: var(--widget-shadow);
        margin-bottom: 20px;
    }
    #mobile-nav-title {
        font-size: 18px;
        font-weight: 600;
    }
    #mobile-menu-btn {
        background: transparent;
        border: none;
        font-size: 20px;
        color: var(--text-primary);
        cursor: pointer;
        padding: 8px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        transition: background-color 0.2s;
    }

    
    #mobile-menu-btn:hover {
        background-color: var(--accent-light);
    }
    
    /* --- 2. НОВЫЕ СТИЛИ для самого выезжающего меню --- */
    .td-main-nav {
        position: fixed;
        top: 0;
        right: 0;
        width: 300px; /* Можно сделать чуть шире */
        max-width: 90%;
        height: 100%;
        background-color: var(--bg-widget);
        box-shadow: -4px 0 25px rgba(0, 0, 0, 0.1);
        transform: translateX(100%);
        transition: transform 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Более плавная анимация */
        z-index: 2000;
        padding: 0; /* Убираем внутренние отступы, чтобы шапка прилегала */
        margin: 0;
        border-radius: 0;
        display: flex;
        flex-direction: column; /* Элементы внутри меню будут в столбик */
    }

    .td-main-nav.is-open {
        transform: translateX(0);
    }

    /* --- 3. Стили для новой шапки меню --- */
    .mobile-menu-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0; /* Шапка не должна сжиматься */
    }

    .mobile-menu-header h3 {
        font-size: 18px;
    }

    #mobile-menu-close-btn {
        background: transparent;
        border: none;
        font-size: 22px;
        cursor: pointer;
        padding: 8px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        color: var(--text-secondary);
        transition: background-color 0.2s, color 0.2s;
    }
    #mobile-menu-close-btn:hover {
        background-color: #F3F4F6;
        color: var(--text-primary);
    }
    
    /* --- 4. Стили для списка и ссылок в меню --- */
    .td-main-nav ul {
        /* ВАЖНО: переопределяем старые стили */
        display: flex;
        flex-direction: column; /* Вертикальный список */
        gap: 8px; /* Небольшой отступ между ссылками */
        padding: 16px;
        overflow-y: auto; /* Позволяет прокручивать, если меню не влезает по высоте */
    }

    .td-main-nav a {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 14px 20px;
        font-size: 16px;
        font-weight: 500;
        border-radius: 10px;
        width: 100%;
        color: var(--text-secondary); /* Цвет неактивной ссылки */
    }
    .td-main-nav a:hover {
        background-color: #F3F4F6;
        color: var(--text-primary);
    }
    .td-main-nav a.active {
        background-image: linear-gradient(90deg, #6d28d9, #4f46e5);
        color: #fff;
        font-weight: 600;
    }
    .td-main-nav a.active i {
        color: #fff;
    }

    /* --- 5. Затемняющий фон --- */
    body.menu-open::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(17, 24, 39, 0.6);
        z-index: 1999;
        transition: opacity 0.3s ease;
    }

    /* --- Превращаем заголовок в красивую карточку --- */
    .lp-widget .widget-header {
        background-color: var(--bg-widget);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: var(--widget-shadow);

        /* Вертикальное расположение элементов */
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 16px; /* Расстояние между текстом и кнопкой */
        padding: 20px;
        margin-bottom: 24px; /* Отступ от списка планов */
    }

    #homework-content .widget-header {
        display: block;
        background-color: var(--bg-widget);
        border-radius: 12px;
        border: 1px solid var(--border-color);
        box-shadow: var(--widget-shadow);

        /* Вертикальное расположение элементов */
        flex-direction: column;
        align-items: flex-start;
        gap: 16px; /* Расстояние между текстом и кнопкой */
        padding: 20px;

        margin: 0 auto;
        margin-bottom: 15px;
        margin-top: 15px;
        
        width: 100%;
       
        box-sizing: border-box;
    }

    #homework-content .widget-header h2 {
        text-align: center;
    }

    #homework-content .widget-header p {
        display: none;
    }

    #homework-content .widget-header .btn-create {
        margin-top: 20px;
        justify-self: center;
        width: 80%;
        justify-content: center;
    }

    /* --- Стилизуем кнопку "Создать план" --- */
    .lp-widget .btn-create {
        width: 100%; /* Кнопка на всю ширину карточки */
        justify-content: center; /* Центрируем иконку и текст */
        padding: 14px 16px; /* Делаем кнопку выше для удобства нажатия */
        font-size: 15px;
        border-radius: 10px;
        
        /* Убираем десктопный градиент и ставим основной цвет */
        background-image: none;
        background-color: var(--accent-primary);
        box-shadow: none; /* Убираем лишние тени */
    }
    .lp-widget .btn-create:hover {
        /* Убираем десктопный эффект приподнимания */
        transform: none;
        /* Просто делаем цвет чуть темнее при наведении */
        background-color: #4338CA;
    }

    /* --- Финальные штрихи --- */
    /* Убираем лишний отступ у самого виджета, т.к. header стал карточкой */
    .lp-widget {
        padding: 0;
    }
    
    /* Делаем так, чтобы сам заголовок "Поурочные планы" был крупнее */
    .lp-widget .widget-title h2 {
        font-size: 20px;
    }

    .widget-title {
        margin: 0 auto;
    }


    .widget-header { 
        margin: 0 auto;
        margin-bottom: 15px;
        margin-top: 15px;
        display: block;
        width: 90%;
       
        box-sizing: border-box;
    }

    .lp-table {
        border-spacing: 0;
    }

    /* Скрываем заголовки таблицы */
    .lp-table thead {
        display: none;
    }

    .lp-table tbody {
        display: block;
        width: 95%;
        margin: 0 auto;
    }

    /* --- Стили для карточки плана --- */
    .lp-table tbody tr {
        display: block;
        background: var(--bg-widget);
        border-radius: 12px;
        box-shadow: var(--widget-shadow);
        padding: 20px;
        margin-bottom: 16px;
        border: 1px solid var(--border-color);
    }
    
    #no-plans-row {
        background: transparent;
        box-shadow: none;
        border: none;
        padding: 0;
    }

    /* --- Стили для полей внутри карточки --- */
    .lp-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 14px;
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .lp-table td:first-child,
    .lp-table td:last-child {
        border-radius: 0;
    }
    
    .lp-table td:last-child {
        border-bottom: none;
    }
    
    /* --- Добавляем текстовые метки (Название, Класс и т.д.) --- */
    .lp-table td::before {
        font-weight: 500;
        color: var(--text-secondary);
        text-align: left;
    }

    /* --- Стиль для заголовка (Название) --- */
    .lp-table td:first-child {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
        padding-top: 0;
        font-size: 18px;
        font-weight: 600;
        line-height: 1.4;
    }

    .lp-table td:first-child::before {
        content: 'Название';
        font-size: 12px;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 0;
    }
    
    /* --- Текстовые метки для остальных полей --- */
    .lp-table tr td:nth-of-type(2)::before { content: 'Класс'; }
    .lp-table tr td:nth-of-type(4)::before { content: 'Дата'; }
    .lp-table tr td:nth-of-type(5)::before { content: 'Статус'; }

    /* --- Скрываем ненужные элементы --- */
    /* Скрываем колонку "Предмет", чтобы не загромождать карточку */
    .lp-table tr td:nth-of-type(3) {
        display: none;
    }
    /* Скрываем метку для блока с кнопками */
    .lp-table tr td:nth-of-type(6)::before {
        display: none;
    }

    /* --- Стили для блока с кнопками действий --- */
    .lp-table td:last-child {
        padding-bottom: 0;
        padding-top: 16px;
    }

    .lp-actions {
        width: 100%;
        justify-content: flex-end;
    }

    /* --- Общий контейнер виджета --- */
    .journal-widget {
        padding: 20px; /* Немного уменьшаем отступы на мобильных */
    }

    /* --- Шапка виджета (Заголовок + Фильтры) --- */
    .journal-header {
        flex-direction: column; /* Ставим заголовок и фильтры друг под другом */
        align-items: flex-start; /* Выравниваем все по левому краю */
        gap: 20px; /* Увеличиваем расстояние между заголовком и фильтрами */
        margin-bottom: 24px;
    }

    /* --- Форма с фильтрами --- */
    #filter-form {
        display: flex; /* Убедимся, что это flex-контейнер */
        flex-direction: column; /* Располагаем фильтры в столбик */
        width: 100%; /* Форма должна занимать всю ширину */
        gap: 12px; /* Расстояние между фильтрами */
    }

    /* --- Сами выпадающие списки (фильтры) --- */
    /* Важно: этот селектор нацелен на кастомные выпадающие списки */
    .journal-header .custom-select {
        width: 100%; /* Каждый фильтр занимает всю ширину */
    }

    /* --- Внутренние табы (Оценки / Посещаемость) --- */
    .journal-tabs {
        display: grid; /* Используем grid для идеального разделения 50/50 */
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .tab-btn {
        padding: 12px 10px; /* Делаем кнопки выше для удобства нажатия */
        font-size: 14px;
        text-align: center; /* Центрируем текст внутри кнопки */
    }

    #grades-table tbody tr {
        flex-direction: row;
    }
    
    #journal-content-container {
        overflow-x: auto; /* Включаем горизонтальный скролл */
        padding-bottom: 8px; /* Место для кастомного скроллбара */
        margin: 0 -20px; /* Расширяем контейнер, чтобы таблицы начинались от края */
        padding: 0 20px;
    }

    #journal-content-container thead tr{
        width:100%;
    }

    #journal-content-container thead th{
        width: 14.2857%;
    }

    /* --- 2. Общие стили для обеих таблиц --- */
    #grades-table,
    #attendance-table {
        min-width: 700px; /* Задаем минимальную ширину, чтобы появился скролл */
        border-collapse: separate; /* Позволяет использовать border-spacing */
        border-spacing: 0 12px; /* Расстояние между "карточками" студентов */
        border: none;
    }
    
    #grades-table tbody,
    #attendance-table tbody {
        background-color: transparent;
    }

    /* --- 3. Стилизуем ячейки и заголовок --- */
    #grades-table th,
    #attendance-table th {
        padding: 12px 16px;
        font-size: 13px;
        white-space: nowrap;
        /* "Приклеиваем" заголовок к верху при прокрутке */
        position: sticky;
        top: 0;
        background-color: var(--bg-main, #F9FAFB); /* Фон, чтобы контент не просвечивал */
        z-index: 10;
    }

    #grades-table td,
    #attendance-table td {
        background-color: var(--bg-widget);
        padding: 8px 16px;
        border: none;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
    }

    /* --- 4. "Приклеиваем" колонку с именами студентов --- */
    #grades-table th:first-child,
    #attendance-table th:first-child,
    #grades-table td:first-child,
    #attendance-table td:first-child {
        /* Магия "залипания" колонки слева */
        position: sticky;
        left: 0;
        z-index: 5;
        background-color: var(--bg-widget);
        border-right: 1px solid var(--border-color); /* Линия-разделитель */
    }
    
    /* Самый левый верхний угол должен быть поверх всего */
    #grades-table th:first-child,
    #attendance-table th:first-child {
        z-index: 15;
        background-color: var(--bg-main, #F9FAFB);
    }
    
    /* Стилизуем имя студента */
    #grades-table td:first-child,
    #attendance-table td:first-child {
        font-weight: 600;
        font-size: 15px;
    }

    /* --- 5. Скругляем углы у "карточек" студентов --- */
    #grades-table td:first-child,
    #attendance-table td:first-child {
        border-radius: 12px 0 0 12px;
    }
    #grades-table td:last-of-type,
    #attendance-table td:last-of-type {
        border-radius: 0 12px 12px 0;
    }

    /* --- 6. Кастомный скроллбар --- */
    #journal-content-container::-webkit-scrollbar {
        height: 6px;
    }
    #journal-content-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    #journal-content-container::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 10px;
    }
    #journal-content-container::-webkit-scrollbar-thumb:hover {
        background: #aaa;
    }

    .homework-widget {
        /* Убираем лишние отступы и фон, чтобы карточки стали основным элементом */
        padding: 0;
        background: transparent;
        border: none;
        box-shadow: none;
    }

    /* --- Стили для отдельной карточки --- */
    .homework-card {
        background-color: var(--bg-widget);
        border: 1px solid var(--border-color);
        border-radius: 16px; /* Более заметное скругление */
        padding: 20px;
        box-shadow: var(--widget-shadow);
        display: flex;
        flex-direction: column;
        gap: 16px; /* Равномерный отступ между элементами карточки */
    }
    
    /* --- Шапка карточки (заголовок, теги, кнопки) --- */
    .hw-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* Выравнивание по верху */
        gap: 12px;
        margin-bottom: 0; /* Используем gap вместо margin */
    }

    .hw-title-group {
        display: flex;
        flex-wrap: wrap; /* Позволяет тегам переноситься на новую строку */
        align-items: center;
        gap: 8px; /* Расстояние между тегами */
    }

    .hw-title-group h3 {
        width: 100%; /* Заголовок всегда на своей строке */
        font-size: 18px;
        font-weight: 600;
        margin: 0;
    }
    
    .hw-tag {
        background-color: #EEF2FF; /* Светло-фиолетовый фон */
        color: #4338CA; /* Темно-фиолетовый текст */
        font-size: 12px;
        font-weight: 500;
        padding: 4px 10px;
        border-radius: 6px;
    }

    /* --- Кнопки действий (Редактировать, Удалить) --- */
    .hw-actions {
        display: flex;
        gap: 8px;
    }

    .hw-actions button {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        border: 1px solid var(--border-color);
        background-color: transparent;
        font-size: 14px;
        color: var(--text-secondary);
    }
    .hw-actions button:hover {
        background-color: #F3F4F6;
    }
    
    /* --- Описание задания --- */
    .hw-description {
        margin: 0; /* Отступы контролируются родительским gap */
        color: var(--text-secondary);
    }

    /* --- Подвал карточки (статистика и кнопка) --- */
    .hw-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 16px;
        margin-top: auto; /* Прижимает подвал к низу карточки */
        border-top: 1px solid var(--border-color);
    }

    /* --- Статистика сдачи --- */
    .hw-stats {
        font-size: 13px;
        color: var(--text-secondary);
        line-height: 1.5; /* Улучшаем читаемость */
    }
    .hw-stats span {
        display: block; /* Заставляем статистику располагаться вертикально */
    }
    
    /* --- Кнопка "Просмотреть работы" --- */
    .btn-view-submissions {
        font-size: 14px;
        font-weight: 600;
        padding: 10px 16px;
        border-radius: 10px;
        background-color: #F9FAFB; /* Слегка серый фон */
    }
}

#grade-modal .close-btn {
    position: relative !important;
    top: 0px !important;
    right: 0px !important;
    border-radius: 5px;
}

.close-btn {
    position: relative !important;
    top: 0px !important;
    right: 0px !important;
    border-radius: 5px;
}


    </style>
</head>
<body class="td-body">

<div class="td-container">
    <header class="td-header">
        <div class="td-logo-section">
            <div class="td-logo-icon">🎓</div>
            <div>
                <h1>Школьная Платформа</h1>
                <p>Система управления учебным процессом</p>
            </div>
        </div>
        <div class="td-user-section">
            <div class="td-user-info">
                <a href="{% url 'profile' %}" class="td-user-link">
                    <h3>{{ teacher.user.get_full_name }}</h3>
                </a>
                <p>Учитель</p>
            </div>
            <a href="{% url 'profile' %}" class="td-user-link">
                <div class="td-user-avatar">{{ teacher.user.first_name|first }}{{ teacher.user.last_name|first }}</div>
            </a>
        </div>
    </header>

    <!-- === НАЧАЛО: НОВЫЙ БЛОК ДЛЯ МОБИЛЬНОЙ НАВИГАЦИИ === -->
    <div class="td-mobile-nav">
        <h2 id="mobile-nav-title">Главная</h2>
        <button id="mobile-menu-btn" aria-label="Открыть меню">
            <i class="fas fa-bars"></i>
        </button>
    </div>
    <!-- === КОНЕЦ: НОВЫЙ БЛОК === -->

    <main>
        
        <nav class="td-main-nav">
            <div class="mobile-menu-header">
                <h3>Меню</h3>
                <button id="mobile-menu-close-btn" aria-label="Закрыть меню">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <ul>
                <li><a class="active" data-tab="dashboard"><i class="fas fa-home"></i> Главная</a></li>
                <li><a data-tab="lesson-plans"><i class="fas fa-file-alt"></i> Поурочные планы</a></li>
                <li><a data-tab="schedule"><i class="far fa-calendar-alt"></i> Расписание</a></li>
                <li><a data-tab="journal"><i class="fas fa-book"></i> Журнал</a></li>
                <li><a data-tab="homework"><i class="fas fa-pencil-alt"></i> Домашние задания</a></li>
            </ul>
        </nav>

        <!-- КОНТЕЙНЕР ДЛЯ ВСЕХ ВКЛАДОК -->
        <div class="tabs-container">
            <!-- Контент для вкладки "Главная" -->
            <div id="dashboard-content" class="tab-content active">
                
                <!-- === НАЧАЛО: ИЗМЕНЕННЫЙ БЛОК СТАТИСТИКИ === -->
                <section class="td-stats-cards">
                    <div class="td-stat-card">
                        <div class="stat-info">
                            <p>Уроков сегодня</p>
                            <h2>{{ lessons_today_count|default:0 }}</h2>
                        </div>
                        <div class="stat-icon blue">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                    <div class="td-stat-card">
                        <div class="stat-info">
                            <p>Планов на проверке</p>
                            <h2>{{ plans_to_check_count|default:0 }}</h2>
                        </div>
                        <div class="stat-icon orange">
                            <i class="fas fa-file-alt"></i>
                        </div>
                    </div>
                    <div class="td-stat-card">
                        <div class="stat-info">
                            <p>Домашних заданий</p>
                            <h2>{{ homeworks_count|default:0 }}</h2>
                        </div>
                        <div class="stat-icon purple">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                    </div>
                    <div class="td-stat-card">
                        <div class="stat-info">
                            <p>Непроверенных работ</p>
                            <h2>{{ unchecked_works_count|default:0 }}</h2>
                        </div>
                        <div class="stat-icon red">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                    </div>
                </section>
                <!-- === КОНЕЦ: ИЗМЕНЕННЫЙ БЛОК СТАТИСТИКИ === -->

                <section class="td-card">
                    <div class="td-card-header"><i class="far fa-clock"></i><h3>Расписание на сегодня</h3></div>
                    <p class="td-card-subtitle">{{ today|date:"l, j F Y" }}</p>
                    <div class="td-schedule-list">
                        {% for lesson in schedule_today %}
                        <div class="td-lesson-item">
                            <div class="td-lesson-time"><p>{{ lesson.start_time|time:"H:i" }}</p><span>{{ lesson.end_time|time:"H:i" }}</span></div>
                            <div class="td-lesson-info"><h4>{{ lesson.subject.name }}</h4><p>Класс {{ lesson.school_class.name }} • Кабинет {{ lesson.classroom }}</p></div>
                            <span class="td-lesson-status">Предстоит</span>
                        </div>
                        {% empty %}
                        <p style="text-align: center; padding: 20px; color: var(--text-secondary);">На сегодня уроков по расписанию нет.</p>
                        {% endfor %}
                    </div>
                </section>
            </div>

            <!-- Контент для вкладки "Расписание" -->
            <div id="schedule-content" class="tab-content">
                <section class="td-card">
                    <div class="td-card-header"><h3>Расписание уроков</h3></div>
                    <p class="td-card-subtitle">Расписание на текущую неделю для учителя: {{ teacher.user.get_full_name }}</p>

                    <div class="schedule-stats-grid">
                        <div class="schedule-stat-item">
                            <div class="icon-bg blue"><i class="fas fa-calendar-alt"></i></div>
                            <div><h3>{{ lessons_in_week_count }}</h3><p>Уроков в неделю</p></div>
                        </div>
                        <div class="schedule-stat-item">
                            <div class="icon-bg purple"><i class="fas fa-users"></i></div>
                            <div><h3>{{ unique_classes_count }}</h3><p>Классов в неделю</p></div>
                        </div>
                        <div class="schedule-stat-item">
                            <div class="icon-bg green"><i class="fas fa-clock"></i></div>
                            <div><h3>{{ hours_in_week }}</h3><p>Часов в неделю</p></div>
                        </div>
                    </div>

                    <div class="schedule-week-grid">
                        {% for day_data in schedule_for_template %}
                            <div class="schedule-day-column {% if today_weekday == day_data.day_number %}today{% endif %}">
                                <div class="day-header">
                                    <h4>{{ day_data.day_name }}</h4>
                                    <span>{{ day_data.date|date:"d.m.Y" }}</span>
                                </div>
                                <div class="lessons-list">
                                    {% for lesson in day_data.lessons %}
                                        <div class="lesson-card">
                                            <p class="time"><i class="far fa-clock"></i> {{ lesson.start_time|time:"H:i" }}</p>
                                            <p class="subject">{{ lesson.subject.name }}</p>
                                            <p class="details"><i class="fas fa-chalkboard-teacher"></i> Класс: {{ lesson.school_class.name }}</p>
                                            <p class="details"><i class="fas fa-map-marker-alt"></i> Каб: {{ lesson.classroom }}</p>
                                        </div>
                                    {% empty %}
                                        <p style="font-size: 13px; text-align: center; color: var(--text-secondary); padding-top: 20px;">Нет уроков</p>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </section>
            </div>

            <!-- === НАЧАЛО: НОВЫЙ КОНТЕНТ ДЛЯ ВКЛАДКИ "ПОУРОЧНЫЕ ПЛАНЫ" === -->
            <div id="lesson-plans-content" class="tab-content">
                <main class="lp-widget">
                    <div class="widget-header">
                        <div class="widget-title">
                            <h2>Поурочные планы</h2>
                            <p>Управление планами уроков</p>
                        </div>
                        <button class="btn-create" id="create-plan-btn"><i class="fas fa-plus"></i> Создать</button>
                    </div>

                    <table class="lp-table">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Класс</th>
                                <th>Предмет</th>
                                <th>Дата</th>
                                <th>Статус</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="lesson-plans-tbody">
                            {% for plan in lesson_plans %}
                            <tr id="plan-row-{{ plan.pk }}">
                                <td>{{ plan.name }}</td>
                                <td>{{ plan.school_class.name }}</td>
                                <td>{{ plan.subject.name }}</td>
                                <td>{{ plan.date|date:"d.m.Y" }}</td>
                                <td>
                                    <span class="lp-status {% if plan.status == 'approved' %}approved{% elif plan.status == 'rejected' %}rejected{% else %}pending{% endif %}">
                                        {{ plan.get_status_display }}
                                    </span>
                                </td>
                                <td class="lp-actions">
                                    <button class="view-plan-btn" data-plan-id="{{ plan.pk }}" title="Просмотр"><i class="far fa-eye"></i></button>
                                    <button class="edit-plan-btn" data-plan-id="{{ plan.pk }}" title="Редактировать"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-plan-btn" data-plan-id="{{ plan.pk }}" title="Удалить"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            {% empty %}
                            <tr id="no-plans-row">
                                <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                    Вы еще не создали ни одного поурочного плана.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </main>
            </div>
            <!-- === КОНЕЦ: НОВЫЙ КОНТЕНТ === -->
            
            <!-- Контент для вкладки "Журнал" -->
            <div id="journal-content" class="tab-content">
                <div class="journal-widget">
                    <div class="journal-header">
                        <div class="journal-title">
                            <h2>Электронный журнал</h2>
                            <p>Оценки и посещаемость учащихся</p>
                        </div>
                        <form method="get" id="filter-form" style="display: flex; gap: 16px;">
                            <select name="school_id" onchange="this.form.submit()" class="class-selector">
                                <option value="">Выберите школу</option>
                                {% for school in all_schools %}
                                    <option value="{{ school.pk }}" {% if school.pk == selected_school_id %}selected{% endif %}>{{ school.name }}</option>
                                {% endfor %}
                            </select>
                            <select name="class_id" onchange="this.form.submit()" class="class-selector">
                                <option value="">Выберите класс</option>
                                {% for class in teacher_classes %}
                                    <option value="{{ class.pk }}" {% if class.pk == selected_class_id %}selected{% endif %}>{{ class.name }}</option>
                                {% endfor %}
                            </select>
                            <select name="subject_id" onchange="this.form.submit()" class="class-selector">
                                <option value="">Выберите предмет</option>
                                {% for subject in teacher_subjects %}
                                    <option value="{{ subject.pk }}" {% if subject.pk == selected_subject_id %}selected{% endif %}>{{ subject.name }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    <div class="journal-tabs">
                        <button class="tab-btn active" data-content-type="grades">Оценки</button>
                        <button class="tab-btn" data-content-type="attendance">Посещаемость</button>
                    </div>

                    <div id="journal-content-container">
                        {% if selected_school_id and selected_class_id and selected_subject_id %}
                            {% include "partials/_attendance_table.html" %}
                        {% else %}
                            <p style="text-align: center; color: var(--text-secondary); padding: 20px;">
                                Пожалуйста, выберите школу, класс и предмет для отображения журнала.
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- === НАЧАЛО: КОНТЕНТ ДЛЯ ВКЛАДКИ "ДОМАШНИЕ ЗАДАНИЯ" === -->
            <div id="homework-content" class="tab-content">
                 <main class="homework-widget">
                    <div class="widget-header">
                        <div class="widget-title">
                            <h2>Домашние задания</h2>
                            <p>Создание и проверка домашних заданий</p>
                        </div>
                        <button class="btn-create"><i class="fas fa-plus"></i> Создать задание</button>
                    </div>

                    <div class="homework-list" id="homework-list-container">
                        {% for hw in homeworks %}
                        <div class="homework-card" id="hw-card-{{ hw.pk }}">
                            <div class="hw-card-header">
                                <div class="hw-title-group">
                                    <h3>{{ hw.title }}</h3>
                                    <span class="hw-tag">{{ hw.school_class.name }}</span>
                                    <span class="hw-tag">{{ hw.subject.name }}</span>
                                </div>
                                <div class="hw-actions">
                                    <button class="edit-btn" data-hw-pk="{{ hw.pk }}"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-btn" data-hw-pk="{{ hw.pk }}"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <p class="hw-description">{{ hw.description|truncatewords:20 }}</p>
                            <div class="hw-card-footer">
                                <div class="hw-stats">
                                    <span>Сдано: {{ hw.submission_count }}</span> &nbsp;&nbsp;
                                    <span>Проверено: {{ hw.checked_count }} из {{ hw.submission_count }}</span>
                                </div>
                                <button class="btn-view-submissions" data-hw-pk="{{ hw.pk }}" data-hw-title="{{ hw.title }}" data-hw-info="{{ hw.school_class.name }} • {{ hw.subject.name }}">
                                    <i class="far fa-eye"></i> Просмотреть работы
                                </button>
                            </div>
                        </div>
                        {% empty %}
                        <p id="no-homeworks-message" style="text-align:center; color: var(--text-secondary); padding: 20px;">Вы еще не создали ни одного домашнего задания.</p>
                        {% endfor %}
                    </div>
                </main>
            </div>
            <!-- === КОНЕЦ: КОНТЕНТ ДЛЯ ВКЛАДКИ "ДОМАШНИЕ ЗАДАНИЯ" === -->

        </div>
    </main>
</div>

<!-- <nav class="td-main-nav">
    <div class="mobile-menu-header">
        <h3>Меню</h3>
        <button id="mobile-menu-close-btn" aria-label="Закрыть меню">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <ul>
        <li><a class="active" data-tab="dashboard"><i class="fas fa-home"></i> Главная</a></li>
        <li><a data-tab="lesson-plans"><i class="fas fa-file-alt"></i> Поурочные планы</a></li>
        <li><a data-tab="schedule"><i class="far fa-calendar-alt"></i> Расписание</a></li>
        <li><a data-tab="journal"><i class="fas fa-book"></i> Журнал</a></li>
        <li><a data-tab="homework"><i class="fas fa-pencil-alt"></i> Домашние задания</a></li>
    </ul>
</nav> -->

<!-- Модальное окно для Журнала -->
<div id="grade-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3 id="modal-student-name"></h3>
        <p id="modal-date"></p>
        <form id="grade-form">
            <input type="number" id="grade-input" min="0" max="100" placeholder="Оценка (0-100)">
            <textarea id="comment-input" placeholder="Комментарий к оценке..."></textarea>
            <button type="submit">Сохранить</button>
        </form>
    </div>
</div>

<!-- === НАЧАЛО: МОДАЛЬНЫЕ ОКНА ДЛЯ ДОМАШНИХ ЗАДАНИЙ (ВНЕ ОСНОВНОГО КОНТЕЙНЕРА) === -->
<div class="modal-overlay" id="homework-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-homework-modal">&times;</button>
        <div class="modal-header">
            <h2>Создать домашнее задание</h2>
            <p>Заполните информацию о домашнем задании</p>
        </div>
        <form id="homework-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group full-width" style="margin-top: 24px;">
                <label for="{{ homework_form.title.id_for_label }}">Название задания</label>
                {{ homework_form.title }}
            </div>
            <div class="form-grid">
                <div class="form-group"><label for="{{ homework_form.school_class.id_for_label }}">Класс</label>{{ homework_form.school_class }}</div>
                <div class="form-group"><label for="{{ homework_form.subject.id_for_label }}">Предмет</label>{{ homework_form.subject }}</div>
                <div class="form-group"><label for="{{ homework_form.due_date.id_for_label }}">Срок сдачи</label>{{ homework_form.due_date }}</div>
            </div>
            <div class="form-group full-width"><label for="{{ homework_form.description.id_for_label }}">Описание задания</label>{{ homework_form.description }}</div>
            <div class="form-group full-width"><label for="{{ homework_form.attached_file.id_for_label }}">Прикрепить файл (необязательно)</label>{{ homework_form.attached_file }}</div>
            <div class="modal-footer full-width">
                <button type="button" class="btn-secondary" id="cancel-homework-btn">Отмена</button>
                <button type="submit" class="btn-submit">Создать</button>
            </div>
        </form>
    </div>
</div>
<div class="modal-overlay" id="submissions-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-submissions-modal">&times;</button>
        <div class="modal-header"><h2 id="submissions-modal-title"></h2><p id="submissions-modal-info"></p></div>
        <div class="submissions-table-container">
            <table class="submissions-table">
                <thead>
                    <!-- ИЗМЕНЕНА ЭТА СТРОКА -->
                    <tr><th>Ученик</th><th>Файл</th><th>Статус</th><th>Дата сдачи</th><th>Оценка</th><th>Действие</th></tr>
                </thead>
                <tbody id="submissions-tbody"></tbody>
            </table>
        </div>
        <div class="modal-footer">
            <!-- <button type="button" class="btn-secondary close-btn" id="cancel-submissions-btn"></button> -->
        </div>
    </div>
</div>
<div class="modal-overlay" id="grading-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-grading-modal">&times;</button>
        <div class="modal-header">
            <h2>Рецензия на работу</h2>
            <p id="grading-student-name"></p>
        </div>
        <form id="grading-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="grade-input">Оценка (0-100)</label>
                <input type="number" id="grade-input" name="grade" min="0" max="100" placeholder="Например, 85">
            </div>
            <div class="form-group">
                <label for="comment-textarea">Комментарий</label>
                <textarea id="comment-textarea" name="comment" placeholder="Отличная работа!"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary close-btn" id="cancel-grading-btn"></button>
                <button type="submit" class="btn-gradient">Сохранить рецензию</button>
            </div>
        </form>
    </div>
</div>
<!-- === КОНЕЦ: МОДАЛЬНЫЕ ОКНА === -->

<!-- === НАЧАЛО: МОДАЛЬНЫЕ ОКНА ДЛЯ ПОУРОЧНЫХ ПЛАНОВ === -->
<div class="modal-overlay" id="plan-form-modal">
    <div class="modal-container">
        <!-- <button class="close-btn"></button> -->
        <div class="modal-header">
            <h2 id="plan-modal-title">Создать план урока</h2>
            <p>Заполните информацию о поурочном плане</p>
        </div>
        <!-- === ИЗМЕНЕНИЕ 1: Добавлен enctype для загрузки файлов === -->
        <form id="lesson-plan-form" novalidate enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="plan_id" id="plan_id">
            <div class="form-grid">
                <div class="form-group">{{ lesson_plan_form.name.label_tag }} {{ lesson_plan_form.name }}</div>
                <div class="form-group">{{ lesson_plan_form.date.label_tag }} {{ lesson_plan_form.date }}</div>
                <div class="form-group">{{ lesson_plan_form.school_class.label_tag }} {{ lesson_plan_form.school_class }}</div>
                <div class="form-group">{{ lesson_plan_form.subject.label_tag }} {{ lesson_plan_form.subject }}</div>
            </div>
            <div class="form-group full-width">{{ lesson_plan_form.topic.label_tag }} {{ lesson_plan_form.topic }}</div>
            <div class="form-group full-width">{{ lesson_plan_form.goals_and_objectives.label_tag }} {{ lesson_plan_form.goals_and_objectives }}</div>
            
            <!-- === ИЗМЕНЕНИЕ 2: Обновленный блок для поля файла === -->
            <div class="form-group full-width">
                {{ lesson_plan_form.learning_materials.label_tag }}
                <div id="current-materials-file" style="margin-bottom: 8px; font-size: 14px;"></div>
                {{ lesson_plan_form.learning_materials }}
            </div>
            <!-- === КОНЕЦ ИЗМЕНЕНИЯ 2 === -->

            <div class="modal-footer full-width">
                <button type="button" class="btn-secondary close-btn"></button>
                <button type="submit" class="btn-submit">Сохранить</button>
            </div>
        </form>
    </div>
</div>

<div class="modal-overlay" id="plan-view-modal">
    <div class="modal-container">
        <!-- <button class="close-btn">&times;</button> -->
        <div class="modal-header">
            <h2 id="view-plan-title"></h2>
            <p><span id="view-plan-class"></span> • <span id="view-plan-subject"></span> • <span id="view-plan-date"></span></p>
        </div>
        <dl class="lp-view-details">
            <dt>Тема урока</dt><dd id="view-plan-topic"></dd>
            <dt>Цели и задачи</dt><dd id="view-plan-goals"></dd>
            
            <!-- === ИЗМЕНЕНИЕ 3: Блок для отображения ссылки на файл === -->
            <dt>Учебные материалы</dt>
            <dd id="view-plan-materials">
                <a href="#" id="view-plan-materials-link" target="_blank" class="file-link" style="display: none;">
                    <i class="fas fa-paperclip"></i> <span></span>
                </a>
                <span id="no-materials-file" style="color: var(--text-secondary);">Нет файла</span>
            </dd>
            <!-- === КОНЕЦ ИЗМЕНЕНИЯ 3 === -->

        </dl>
        <div class="modal-footer"><button type="button" class="btn-secondary close-btn"></button></div>
    </div>
</div>
<!-- === КОНЕЦ: МОДАЛЬНЫЕ ОКНА === -->


<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. ЛОГИКА ПЕРЕКЛЮЧЕНИЯ ОСНОВНЫХ ВКЛАДОК (Главная, Расписание, Журнал, ДЗ) ---
    const mainNavLinks = document.querySelectorAll('.td-main-nav a[data-tab]');
    const mainContentPanes = document.querySelectorAll('.tab-content');

    mainNavLinks.forEach(link => {
        link.addEventListener('click', function(event) {
            event.preventDefault();

            if (this.classList.contains('active')) {
                // Если меню открыто на мобильном, просто закроем его
                if (document.querySelector('.td-main-nav').classList.contains('is-open')) {
                    closeMenu();
                }
                return; // Выходим из функции
            }

            const tabId = this.getAttribute('data-tab');
            mainNavLinks.forEach(navLink => navLink.classList.remove('active'));
            this.classList.add('active');

            mainContentPanes.forEach(pane => {
                pane.classList.toggle('active', pane.id === tabId + '-content');
            });
        });
    });

    // --- 2. ЛОГИКА ДЛЯ ВКЛАДКИ "ЖУРНАЛ" (внутренние табы, модальные окна и AJAX) ---
    const journalContainer = document.getElementById('journal-content');
    if (journalContainer) {
        const journalContentContainer = journalContainer.querySelector('#journal-content-container');
        const journalTabsContainer = journalContainer.querySelector('.journal-tabs');
        const modal = document.getElementById('grade-modal');

        journalTabsContainer.addEventListener('click', async function(e) {
            if (!e.target.classList.contains('tab-btn')) return;
            
            journalTabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            const contentType = e.target.dataset.contentType;
            const params = new URLSearchParams(new FormData(document.getElementById('filter-form'))).toString();
            if (!params.includes('class_id')) return;

            const url = (contentType === 'attendance') ? `{% url 'journal_attendance_content' %}?${params}` : `{% url 'teacher_journal_grades_content' %}?${params}`;
            
            try {
                journalContentContainer.innerHTML = '<p style="text-align: center; padding: 20px;">Загрузка...</p>';
                const response = await fetch(url);
                journalContentContainer.innerHTML = await response.text();
            } catch (error) {
                journalContentContainer.innerHTML = '<p style="color: red; text-align: center;">Ошибка загрузки</p>';
            }
        });

        journalContentContainer.addEventListener('click', function(e) {
            const gradeCell = e.target.closest('.grade-cell');
            if (gradeCell) handleGradeCellClick(gradeCell);

            const attendanceCell = e.target.closest('.attendance-cell');
            if (attendanceCell) handleAttendanceCellClick(attendanceCell);
        });

        const gradeForm = document.getElementById('grade-form');
        let activeGradeCell = null;

        function handleGradeCellClick(cell) {
            activeGradeCell = cell;
            modal.querySelector('#modal-student-name').textContent = `Оценка для: ${cell.closest('tr').cells[0].textContent.trim()}`;
            modal.querySelector('#modal-date').textContent = `Дата: ${cell.dataset.date}`;
            modal.querySelector('#grade-input').value = cell.textContent.trim().replace(/[^0-9]/g, '');
            modal.querySelector('#comment-input').value = cell.dataset.comment || '';
            modal.style.display = 'block';
            modal.querySelector('#grade-input').focus();
        }

        async function handleAttendanceCellClick(cell) {
            const statuses = ['P', 'L', 'A'];
            const currentStatus = cell.dataset.status;
            const nextStatus = statuses[(statuses.indexOf(currentStatus) + 1) % statuses.length];
            
            const row = cell.closest('tr');
            const absentCountCell = row.querySelector('.absent-count');
            let currentAbsences = parseInt(absentCountCell.textContent);
            if (currentStatus === 'A' && nextStatus !== 'A') {
                absentCountCell.textContent = currentAbsences - 1;
            } else if (currentStatus !== 'A' && nextStatus === 'A') {
                absentCountCell.textContent = currentAbsences + 1;
            }

            updateAttendanceIcon(cell, nextStatus);

            const payload = {
                student_id: cell.dataset.studentId, date: cell.dataset.date,
                subject_id: cell.closest('tbody').dataset.subjectId, class_id: cell.closest('tbody').dataset.classId,
                status: nextStatus
            };
            
            try {
                const response = await fetch("{% url 'api_set_attendance' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                    body: JSON.stringify(payload)
                });
                if (!response.ok) updateAttendanceIcon(cell, currentStatus);
            } catch (error) {
                updateAttendanceIcon(cell, currentStatus);
            }
        }
        
        gradeForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const payload = {
                student_id: activeGradeCell.dataset.studentId, date: activeGradeCell.dataset.date,
                subject_id: activeGradeCell.closest('tbody').dataset.subjectId, class_id: activeGradeCell.closest('tbody').dataset.classId,
                grade: document.getElementById('grade-input').value,
                comment: document.getElementById('comment-input').value
            };
            const response = await fetch("{% url 'api_set_grade' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                body: JSON.stringify(payload)
            });
            if (response.ok) {
                const result = await response.json();
                updateGradeCell(activeGradeCell, result.grade, result.has_comment);
                activeGradeCell.dataset.comment = payload.comment;
                modal.style.display = 'none';
            } else { alert('Ошибка сохранения оценки!'); }
        });

        modal.querySelector('.close-btn').addEventListener('click', () => modal.style.display = 'none');
        window.addEventListener('click', (e) => { if (e.target == modal) modal.style.display = 'none'; });
    }
    
    // === ЛОГИКА ЗАГРУЗКИ ЖУРНАЛА ПРИ ПЕРЕХОДЕ ПО URL С ПАРАМЕТРАМИ ===
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('school_id') && urlParams.has('class_id') && urlParams.has('subject_id')) {
        const journalTabLink = document.querySelector('a[data-tab="journal"]');
        const gradesSubTab = document.querySelector('#journal-content .tab-btn[data-content-type="grades"]');

        if (journalTabLink && gradesSubTab) {
            if (!journalTabLink.classList.contains('active')) {
                journalTabLink.click();
            }
            gradesSubTab.click();
        }
    } 
    else if (urlParams.has('school_id') || urlParams.has('class_id')) {
        const journalTabLink = document.querySelector('a[data-tab="journal"]');
        if (journalTabLink && !journalTabLink.classList.contains('active')) {
            journalTabLink.click();
        }
    }

    // === JAVASCRIPT ДЛЯ ЛОГИКИ ДОМАШНИХ ЗАДАНИЙ ===
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const homeworkTab = document.getElementById('homework-content');
    if (homeworkTab) {
        const homeworkListContainer = document.getElementById('homework-list-container');
        const homeworkModal = document.getElementById('homework-modal');
        const submissionsModal = document.getElementById('submissions-modal');
        const gradingModal = document.getElementById('grading-modal');
        
        if (homeworkModal && homeworkListContainer) {
            const openCreateBtn = homeworkTab.querySelector('.btn-create');
            const homeworkForm = document.getElementById('homework-form');
            const modalTitle = homeworkModal.querySelector('.modal-header h2');
            const submitButton = homeworkForm.querySelector('button[type="submit"]');
            const closeModalBtn = document.getElementById('close-homework-modal');
            const cancelModalBtn = document.getElementById('cancel-homework-btn');

            const openModalForCreate = () => {
                modalTitle.textContent = 'Создать домашнее задание';
                submitButton.textContent = 'Создать';
                homeworkForm.reset();
                homeworkForm.setAttribute('action', "{% url 'api_create_homework' %}");
                homeworkModal.style.display = 'flex';
            };

            const openModalForEdit = async (homeworkId) => {
                modalTitle.textContent = 'Редактировать задание';
                submitButton.textContent = 'Сохранить';
                homeworkForm.reset();
                homeworkForm.setAttribute('action', `/api/homework/${homeworkId}/update/`);
                try {
                    const response = await fetch(`/api/homework/${homeworkId}/details/`);
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);
                    
                    const data = result.data;
                    homeworkForm.querySelector('#id_title').value = data.title;
                    homeworkForm.querySelector('#id_description').value = data.description;
                    homeworkForm.querySelector('#id_school_class').value = data.school_class;
                    homeworkForm.querySelector('#id_subject').value = data.subject;
                    homeworkForm.querySelector('#id_due_date').value = data.due_date;
                    homeworkModal.style.display = 'flex';
                } catch (error) {
                    alert('Не удалось загрузить данные задания: ' + error.message);
                }
            };

            const closeModal = () => { homeworkModal.style.display = 'none'; };

            openCreateBtn.addEventListener('click', openModalForCreate);
            closeModalBtn.addEventListener('click', closeModal);
            cancelModalBtn.addEventListener('click', closeModal);
            homeworkModal.addEventListener('click', (e) => { if (e.target === homeworkModal) closeModal(); });

            homeworkForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const actionUrl = this.getAttribute('action');
                try {
                    const response = await fetch(actionUrl, {
                        method: 'POST', body: formData, headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    });
                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message || 'Успешно сохранено!');
                        window.location.reload(); 
                    } else {
                        const errorMessages = Object.values(result.errors).map(err => err[0]).join('\n');
                        alert("Ошибка валидации:\n" + errorMessages);
                    }
                } catch (error) {
                    alert('Произошла сетевая ошибка.');
                }
            });
            
            homeworkListContainer.addEventListener('click', function(e) {
                const editButton = e.target.closest('.edit-btn');
                if (editButton) {
                    openModalForEdit(editButton.dataset.hwPk);
                }
            });
        }

        if (submissionsModal && homeworkListContainer) {
            const submissionsTbody = document.getElementById('submissions-tbody');

            const openSubmissionsModal = async (hwId, hwTitle, hwInfo) => {
                submissionsModal.querySelector('#submissions-modal-title').textContent = hwTitle;
                submissionsModal.querySelector('#submissions-modal-info').textContent = hwInfo;
                submissionsTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Загрузка...</td></tr>';
                submissionsModal.style.display = 'flex';

                try {
                    const response = await fetch(`/api/homework/${hwId}/submissions/`);
                    const data = await response.json();
                    if (!response.ok || data.status !== 'success') throw new Error(data.message || 'Не удалось загрузить данные.');

                    submissionsTbody.innerHTML = '';
                    if (data.submissions.length === 0) {
                        submissionsTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Работы еще не сданы.</td></tr>';
                        return;
                    }

                    data.submissions.forEach(sub => {
                        let fileHtml = '<td>-</td>';
                        if (sub.file_url) {
                            fileHtml = `<td><a href="${sub.file_url}" class="file-link" target="_blank" title="Открыть файл"><i class="fas fa-paperclip"></i> Посмотреть</a></td>`;
                        }
                        
                        let statusHtml;
                        if (sub.status === 'Проверено') statusHtml = `<span class="status-tag status-checked"><i class="fas fa-check-circle"></i> Проверено</span>`;
                        else if (sub.status === 'Сдано') statusHtml = `<span class="status-tag status-submitted"><i class="fas fa-check"></i> Сдано</span>`;
                        else statusHtml = `<span class="status-tag status-awaiting"><i class="far fa-clock"></i> Ожидается</span>`;
                        
                        const gradeHtml = sub.grade !== null ? `<td><span class="grade-circle">${sub.grade}</span></td>` : '<td>-</td>';
                        const actionButton = sub.status !== 'Ожидается' ? `<button class="btn-view-submissions" style="padding: 6px 10px; font-size: 12px;">${sub.status === 'Проверено' ? 'Изменить' : 'Проверить'}</button>` : '-';
                        const actionHtml = `<td data-submission-pk="${sub.submission_id}" data-student-name="${sub.full_name}" data-grade="${sub.grade || ''}" data-comment="${sub.teacher_comment || ''}">${actionButton}</td>`;

                        const row = `<tr id="sub-row-${sub.submission_id}"><td>${sub.full_name}</td>${fileHtml}<td>${statusHtml}</td><td>${sub.submitted_at || '-'}</td>${gradeHtml}${actionHtml}</tr>`;
                        submissionsTbody.insertAdjacentHTML('beforeend', row);
                    });
                } catch (error) {
                    submissionsTbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: red;">${error.message}</td></tr>`;
                }
            };

            const closeSubmissionsModal = () => { submissionsModal.style.display = 'none'; };
            submissionsModal.querySelector('#close-submissions-modal').addEventListener('click', closeSubmissionsModal);
            submissionsModal.addEventListener('click', (e) => { if (e.target === submissionsModal) closeSubmissionsModal(); });
            
            homeworkListContainer.addEventListener('click', (e) => {
                const viewBtn = e.target.closest('.btn-view-submissions');
                if (viewBtn) {
                    openSubmissionsModal(viewBtn.dataset.hwPk, viewBtn.dataset.hwTitle, viewBtn.dataset.hwInfo);
                }
            });
        }

        if (gradingModal) {
            const submissionsTbody = document.getElementById('submissions-tbody');
            const gradingForm = document.getElementById('grading-form');
            const studentNameEl = document.getElementById('grading-student-name');
            const gradeInput = gradingModal.querySelector('#grade-input');
            const commentTextarea = gradingModal.querySelector('#comment-textarea');
            let currentSubmissionRow = null;

            const openGradingModal = (cell) => {
                const { submissionPk, studentName, grade, comment } = cell.dataset;
                currentSubmissionRow = document.getElementById(`sub-row-${submissionPk}`);
                studentNameEl.textContent = studentName;
                gradeInput.value = grade || "";
                commentTextarea.value = comment || "";
                gradingForm.dataset.submissionPk = submissionPk;
                gradingModal.style.display = 'flex';
            };

            const closeGradingModal = () => { gradingModal.style.display = 'none'; };
            gradingModal.querySelector('#close-grading-modal').addEventListener('click', closeGradingModal);
            gradingModal.querySelector('#cancel-grading-btn').addEventListener('click', closeGradingModal);
            gradingModal.addEventListener('click', (e) => { if (e.target === gradingModal) closeGradingModal(); });

            gradingForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const submissionPk = this.dataset.submissionPk;
                const grade = gradeInput.value;
                const comment = commentTextarea.value;

                try {
                    const response = await fetch(`/api/submission/${submissionPk}/grade/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                        body: JSON.stringify({ grade: grade, comment: comment }),
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.message);

                    if (currentSubmissionRow) {
                        const statusCell = currentSubmissionRow.cells[2];
                        const gradeCell = currentSubmissionRow.cells[4];
                        const actionCell = currentSubmissionRow.cells[5];
                        
                        statusCell.innerHTML = `<span class="status-tag status-checked"><i class="fas fa-check-circle"></i> Проверено</span>`;
                        gradeCell.innerHTML = result.new_grade ? `<span class="grade-circle">${result.new_grade}</span>` : '-';
                        actionCell.dataset.grade = result.new_grade || "";
                        actionCell.dataset.comment = comment;
                        actionCell.querySelector('button').textContent = 'Изменить';
                    }
                    closeGradingModal();
                } catch (error) {
                    alert(`Ошибка: ${error.message}`);
                }
            });

            submissionsTbody.addEventListener('click', (e) => {
                const checkBtn = e.target.closest('td > button');
                if (checkBtn) {
                    openGradingModal(checkBtn.parentElement);
                }
            });
        }
    }
    
    // === JAVASCRIPT ДЛЯ ЛОГИКИ ПОУРОЧНЫХ ПЛАНОВ ===
    const lessonPlansTab = document.getElementById('lesson-plans-content');
    if (lessonPlansTab) {
        const createPlanBtn = document.getElementById('create-plan-btn');
        const plansTbody = document.getElementById('lesson-plans-tbody');
        
        // Модальные окна
        const formModal = document.getElementById('plan-form-modal');
        const viewModal = document.getElementById('plan-view-modal');
        
        // Форма и ее элементы
        const planForm = document.getElementById('lesson-plan-form');
        const planModalTitle = document.getElementById('plan-modal-title');
        const planIdInput = document.getElementById('plan_id');
        const currentFileDiv = document.getElementById('current-materials-file');

        // Открытие/закрытие модальных окон
        const openModal = (modal) => modal.style.display = 'flex';
        const closeModal = (modal) => modal.style.display = 'none';

        formModal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(formModal)));
        viewModal.querySelectorAll('.close-btn').forEach(btn => btn.addEventListener('click', () => closeModal(viewModal)));

        // 1. Открытие модального окна для СОЗДАНИЯ плана
        createPlanBtn.addEventListener('click', () => {
            planForm.reset();
            planIdInput.value = '';
            currentFileDiv.innerHTML = ''; // Очищаем информацию о текущем файле
            planModalTitle.textContent = 'Создать план урока';
            planForm.querySelector('button[type="submit"]').textContent = 'Создать';
            openModal(formModal);
        });

        // 2. Обработка кликов по кнопкам в таблице (просмотр, редактирование, удаление)
        plansTbody.addEventListener('click', async (e) => {
            const viewBtn = e.target.closest('.view-plan-btn');
            const editBtn = e.target.closest('.edit-plan-btn');
            const deleteBtn = e.target.closest('.delete-plan-btn');
            
            if (viewBtn) {
                const planId = viewBtn.dataset.planId;
                // Запрос на сервер для получения данных...
                const response = await fetch(`/api/lesson-plans/${planId}/details/`);
                if (response.ok) {
                    const { data } = await response.json();
                    document.getElementById('view-plan-title').textContent = data.name;
                    // API должен возвращать имена, а не ID, для лучшего отображения.
                    // Для примера оставим так, но лучше доработать API.
                    document.getElementById('view-plan-class').textContent = `Класс ID: ${data.school_class}`;
                    document.getElementById('view-plan-subject').textContent = `Предмет ID: ${data.subject}`;
                    document.getElementById('view-plan-date').textContent = data.date;
                    document.getElementById('view-plan-topic').textContent = data.topic || '-';
                    document.getElementById('view-plan-goals').textContent = data.goals_and_objectives || '-';
                    
                    const link = document.getElementById('view-plan-materials-link');
                    const noFile = document.getElementById('no-materials-file');
                    if(data.learning_materials_url) {
                        link.href = data.learning_materials_url;
                        link.querySelector('span').textContent = data.learning_materials_name;
                        link.style.display = 'inline-flex';
                        noFile.style.display = 'none';
                    } else {
                        link.style.display = 'none';
                        noFile.style.display = 'inline';
                    }
                    openModal(viewModal);
                } else {
                    alert('Не удалось загрузить данные плана.');
                }
            }

            if (editBtn) {
                const planId = editBtn.dataset.planId;
                const response = await fetch(`/api/lesson-plans/${planId}/details/`);
                if (response.ok) {
                    const { data } = await response.json();
                    planForm.reset();
                    planIdInput.value = data.id;
                    planModalTitle.textContent = 'Редактировать план урока';
                    planForm.querySelector('button[type="submit"]').textContent = 'Сохранить';

                    // Заполняем поля формы
                    planForm.querySelector('[name="name"]').value = data.name;
                    planForm.querySelector('[name="date"]').value = data.date;
                    planForm.querySelector('[name="school_class"]').value = data.school_class;
                    planForm.querySelector('[name="subject"]').value = data.subject;
                    planForm.querySelector('[name="topic"]').value = data.topic;
                    planForm.querySelector('[name="goals_and_objectives"]').value = data.goals_and_objectives;
                    
                    if (data.learning_materials_url) {
                        currentFileDiv.innerHTML = `Текущий файл: <a href="${data.learning_materials_url}" target="_blank">${data.learning_materials_name}</a>`;
                    } else {
                        currentFileDiv.innerHTML = '';
                    }

                    openModal(formModal);
                } else {
                    alert('Не удалось загрузить данные плана для редактирования.');
                }
            }

            if (deleteBtn) {
                if (confirm('Вы уверены, что хотите удалить этот план?')) {
                    const planId = deleteBtn.dataset.planId;
                    // === ИСПРАВЛЕНИЕ 2: Получаем CSRF-токен перед отправкой ===
                    const csrfToken = planForm.querySelector('input[name="csrfmiddlewaretoken"]').value;

                    const response = await fetch(`/api/lesson-plans/${planId}/delete/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrfToken }
                    });
                    if (response.ok) {
                        document.getElementById(`plan-row-${planId}`).remove();
                    } else {
                        alert('Не удалось удалить план.');
                    }
                }
            }
        });

        // 3. Отправка формы (создание/редактирование)
        planForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // === ИСПРАВЛЕНИЕ 1: Используем правильное имя переменной "planForm" ===
            const csrfToken = planForm.querySelector('input[name="csrfmiddlewaretoken"]').value;
            
            const formData = new FormData(this);
            const response = await fetch("{% url 'api_manage_lesson_plan' %}", {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrfToken }
            });
            
            if (response.ok) {
                window.location.reload(); // Перезагружаем страницу для обновления таблицы
            } else {
                const result = await response.json();
                alert('Ошибка сохранения: ' + JSON.stringify(result.errors || result.message));
            }
        });
    }
    
    // Глобальный listener для Escape, который закрывает все модальные окна
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay, .modal').forEach(modal => modal.style.display = 'none');
        }
    });

    // --- ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ (общие для журнала и ДЗ) ---
    function updateGradeCell(cell, gradeValue, hasComment) {
        if (gradeValue === null || gradeValue === '') {
            cell.innerHTML = '<span style="color: var(--text-secondary); font-size: 20px;">+</span>';
            return;
        }
        const gradeInt = parseInt(gradeValue);
        let badgeClass = (gradeInt >= 85) ? 'grade-5' : (gradeInt >= 65) ? 'grade-4' : 'grade-3';
        const commentIcon = hasComment ? '<span class="grade-comment-icon">💬</span>' : '';
        cell.innerHTML = `<div class="grade-badge-container"><div class="grade-badge ${badgeClass}">${gradeInt}</div>${commentIcon}</div>`;
    }
    function updateAttendanceIcon(cell, statusCode) { 
        let iconHtml = '';
        if (statusCode === 'P') iconHtml = '<span class="attendance-icon status-P">✓</span>';
        else if (statusCode === 'A') iconHtml = '<span class="attendance-icon status-A">✕</span>';
        else if (statusCode === 'L') iconHtml = '<span class="attendance-icon status-L">!</span>';
        cell.innerHTML = iconHtml;
        cell.dataset.status = statusCode;
    }
});
</script>

<script>
// Replace native journal selects with a simple custom dropdown for consistent styling
document.addEventListener('DOMContentLoaded', function() {
    const journalSelects = document.querySelectorAll('.journal-header select.class-selector');
    journalSelects.forEach(select => {
        try {
            const form = select.closest('form');
            const wrapper = document.createElement('div'); wrapper.className = 'custom-select';
            const trigger = document.createElement('button'); trigger.type = 'button'; trigger.className = 'custom-select-trigger';
            trigger.textContent = (select.options[select.selectedIndex] && select.options[select.selectedIndex].text) || select.options[0].text || '';
            const list = document.createElement('ul'); list.className = 'custom-options';
            Array.from(select.options).forEach(opt => {
                const li = document.createElement('li'); li.className = 'custom-option'; li.dataset.value = opt.value; li.textContent = opt.text;
                if (opt.disabled) li.classList.add('disabled');
                if (opt.selected) li.classList.add('selected');
                list.appendChild(li);
            });
            const hidden = document.createElement('input'); hidden.type = 'hidden'; hidden.name = select.name; hidden.value = select.value;
            wrapper.appendChild(trigger); wrapper.appendChild(list); wrapper.appendChild(hidden);
            select.parentNode.insertBefore(wrapper, select); select.remove();

            trigger.addEventListener('click', function(e) {
                e.stopPropagation(); document.querySelectorAll('.custom-options.open').forEach(o => { if (!wrapper.contains(o)) o.classList.remove('open'); });
                list.classList.toggle('open');
            });

            list.addEventListener('click', function(e) {
                const li = e.target.closest('.custom-option');
                if (!li || li.classList.contains('disabled')) return;
                hidden.value = li.dataset.value; trigger.textContent = li.textContent;
                list.querySelectorAll('.custom-option').forEach(x => x.classList.remove('selected'));
                li.classList.add('selected'); list.classList.remove('open');
                if (form) form.submit();
            });

            // close when clicking outside
            document.addEventListener('click', function(e) { if (!wrapper.contains(e.target)) list.classList.remove('open'); });
        } catch (err) { console.error('custom-select init error', err); }
    });
});
</script>


<script>
/* Вставьте этот код в тег <script> в конце вашего HTML */
/* ЗАМЕНИТЕ ВАШ СУЩЕСТВУЮЩИЙ СКРИПТ НА ЭТОТ */
document.addEventListener('DOMContentLoaded', function() {
    // --- 2. ЛОГИКА ДЛЯ МОБИЛЬНОГО МЕНЮ ---
    const menuButton = document.getElementById('mobile-menu-btn');
    const closeButton = document.getElementById('mobile-menu-close-btn');
    const navMenu = document.querySelector('.td-main-nav');
    const mobileNavTitle = document.getElementById('mobile-nav-title');
    const navLinks = navMenu.querySelectorAll('a[data-tab]');

    if (menuButton) {
        // Функция для закрытия меню
        const closeMenu = () => {
            navMenu.classList.remove('is-open');
            document.body.classList.remove('menu-open');
        };

        // Открытие меню по клику на бургер
        menuButton.addEventListener('click', function() {
            navMenu.classList.add('is-open');
            document.body.classList.add('menu-open');
        });

        // Закрытие меню по клику на крестик
        closeButton.addEventListener('click', closeMenu);

        // При клике на ссылку в мобильном меню, мы обновляем заголовок и закрываем его
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                mobileNavTitle.textContent = this.textContent.trim();
                // Само переключение вкладок обработается в блоке №1
                closeMenu();
            });
        });
        
        // Закрытие меню при клике вне его (на оверлей)
        document.addEventListener('click', function(event) {
            if (navMenu.classList.contains('is-open') && !navMenu.contains(event.target) && !menuButton.contains(event.target)) {
                 closeMenu();
            }
        });

        // Закрытие по клавише Escape
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && navMenu.classList.contains('is-open')) {
                closeMenu();
            }
        });
    }
});
</script>

</body>
</html>