{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è | –®–∫–æ–ª—å–Ω–∞—è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/base.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <link rel="stylesheet" href="{% static 'bilimClassApp/css/teacher_homework.css' %}">
    <!-- <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root {
            --bg-main: #F9FAFB; --bg-widget: #FFFFFF; --text-primary: #111827;
            --text-secondary: #6B7280; --border-color: #E5E7EB; --accent-primary: #4F46E5;
            --accent-light: #EEF2FF; --accent-red: #EF4444;
            --status-green-bg: #ECFDF5; --status-green-text: #065F46;
            --status-blue-bg: #EFF6FF; --status-blue-text: #1E40AF;
            --status-gray-bg: #F3F4F6; --status-gray-text: #4B5563;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-primary); }
        .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
        
        /* === –®–∞–ø–∫–∞ === */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .logo-section { display: flex; align-items: center; gap: 12px; }
        .logo-section .logo-icon { width: 40px; height: 40px; background-color: var(--accent-primary); border-radius: 8px; color: white; display: grid; place-items: center; font-size: 20px; font-weight: 700; }
        .logo-section h1 { font-size: 20px; font-weight: 700; }
        .logo-section p { font-size: 14px; color: var(--text-secondary); }
        .user-section { font-size: 14px; font-weight: 500; color: var(--text-secondary); }

        /* === –ù–∞–≤–∏–≥–∞—Ü–∏—è === */
        .main-nav { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 12px; padding: 8px; margin-bottom: 24px; }
        .main-nav ul { display: flex; list-style: none; gap: 8px; }
        .main-nav a { display: flex; align-items: center; gap: 8px; padding: 10px 16px; text-decoration: none; color: var(--text-secondary); font-weight: 600; border-radius: 8px; transition: all 0.2s; }
        .main-nav a.active { background-color: var(--accent-light); color: var(--accent-primary); }
        .main-nav i { width: 20px; text-align: center; }

        /* === –û—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥–∂–µ—Ç === */
        .homework-widget { background-color: var(--bg-widget); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; }
        .widget-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .widget-title h2 { font-size: 24px; font-weight: 700; }
        .widget-title p { color: var(--text-secondary); margin-top: 4px; }
        .btn-create { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--accent-primary); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }

        /* === –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø) === */
        .homework-list { display: flex; flex-direction: column; gap: 16px; }
        .homework-card { border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .hw-card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; }
        .hw-card-header h3 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .hw-card-header .hw-info { font-size: 14px; color: var(--text-secondary); }
        .hw-actions { display: flex; gap: 16px; flex-shrink: 0; }
        .hw-actions button { background: none; border: none; cursor: pointer; color: var(--text-secondary); font-size: 16px; padding: 4px; }
        .hw-actions button:hover { color: var(--text-primary); }
        .hw-actions .delete-btn:hover { color: var(--accent-red); }
        .hw-card-body .hw-description { font-size: 14px; color: var(--text-secondary); }
        .hw-card-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .hw-stats { font-size: 14px; color: var(--text-secondary); font-weight: 500; }
        .btn-view-submissions { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: 1px solid var(--border-color); border-radius: 8px; background: none; font-weight: 600; font-size: 14px; cursor: pointer; color: var(--text-primary); }
        
        /* === –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) === */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(17, 24, 39, 0.6); justify-content: center; align-items: center; backdrop-filter: blur(4px); }
        .modal-container { background-color: var(--bg-widget); border-radius: 16px; padding: 24px; width: 90%; max-width: 700px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); position: relative; }
        .modal-header { margin-bottom: 16px; }
        .modal-header h2 { font-size: 20px; font-weight: 600; }
        .modal-header p { color: var(--text-secondary); }
        .close-btn { position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 24px; color: var(--text-secondary); cursor: pointer; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border-color); }
        .btn-secondary { padding: 10px 16px; background-color: var(--bg-widget); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-submit, .btn-gradient { padding: 10px 16px; background: linear-gradient(90deg, #4F46E5, #3B82F6); color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .form-group { display: flex; flex-direction: column; margin-bottom: 16px; }
        .form-group label { font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; background-color: #F9FAFB; font-family: 'Inter', sans-serif; font-size: 14px; width: 100%; }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–∞–±–æ—Ç */
        .submissions-table-container { max-height: 400px; overflow-y: auto; }
        .submissions-table { width: 100%; border-collapse: collapse; }
        .submissions-table th, .submissions-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        .status-tag { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 99px; font-weight: 500; font-size: 12px; }
        .status-checked { background-color: var(--status-green-bg); color: var(--status-green-text); }
        .status-submitted { background-color: var(--status-blue-bg); color: var(--status-blue-text); }
        .status-awaiting { background-color: var(--status-gray-bg); color: var(--status-gray-text); }
        .grade-circle { display: inline-block; width: 24px; height: 24px; line-height: 24px; text-align: center; border-radius: 50%; background-color: var(--status-green-bg); color: var(--status-green-text); font-weight: 600; }
        .btn-check-grade { padding: 6px 12px; border: 1px solid var(--border-color); background: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-check-grade:disabled { cursor: not-allowed; color: #ccc; }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ—Ü–µ–Ω–∑–∏–∏ */
        #grading-modal .modal-container { max-width: 500px; z-index: 1001; padding: 32px; }
        #grading-modal .modal-header h2 { font-size: 22px; font-weight: 700; }
        #grading-modal .modal-header p { display: none; } /* –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–º–µ–Ω–µ–º */
        #grading-modal .form-group label { font-weight: 600; }
        #grading-modal textarea { min-height: 90px; }
        #grading-modal .modal-footer { margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border-color); }
    </style> -->
        
</head>
<body>
<div class="container">
    <header class="header">
        <div class="logo-section">
            <div class="logo-icon">üéì</div>
            <div>
                <h1>–®–∫–æ–ª—å–Ω–∞—è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</h1>
                <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—á–µ–±–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º</p>
            </div>
        </div>
        <div class="user-section">
            <div class="user-info">
                <h3>{{ teacher.user.get_full_name }}</h3>
                <p>–£—á–∏—Ç–µ–ª—å</p>
            </div>
            <div class="user-avatar">{{ teacher.user.first_name|first }}{{ teacher.user.last_name|first }}</div>
        </div>
    </header>

    <nav class="main-nav">
        <ul>
            <li><a href="{% url 'teacher_dashboard' %}"><i class="fas fa-home"></i> –ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="#"><i class="fas fa-tasks"></i> –ü–æ—É—Ä–æ—á–Ω—ã–µ –ø–ª–∞–Ω—ã</a></li>
            <li><a href="{% url 'teacher_journal' %}"><i class="fas fa-book"></i> –ñ—É—Ä–Ω–∞–ª</a></li>
            <li><a href="{% url 'teacher_homework' %}" class="active"><i class="fas fa-pencil-alt"></i> –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a></li>
            <li><a href="#"><i class="far fa-calendar-alt"></i> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a></li>
        </ul>
    </nav>

    <main class="homework-widget">
        <div class="widget-header">
            <div class="widget-title">
                <h2>–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</h2>
                <p>–°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π</p>
            </div>
            <button class="btn-create"><i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
        </div>

        <div class="homework-list" id="homework-list-container">
            {% for hw in homeworks %}
            <div class="homework-card" id="hw-card-{{ hw.pk }}">
                <div class="hw-card-header">
                    <div class="hw-title-group">
                        <h3>{{ hw.title }}</h3>
                        <span class="hw-tag">{{ hw.school_class.name }}</span>
                        <span class="hw-tag">{{ hw.subject.name }}</span>
                    </div>
                    <div class="hw-actions">
                        <button class="edit-btn" data-hw-pk="{{ hw.pk }}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn" data-hw-pk="{{ hw.pk }}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <p class="hw-description">{{ hw.description }}</p>
                <div class="hw-card-footer">
                    <div class="hw-stats">
                        <span>–°–¥–∞–Ω–æ: {{ hw.submission_count }}</span> &nbsp;&nbsp;
                        <span>–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ: {{ hw.checked_count }} –∏–∑ {{ hw.submission_count }}</span>
                    </div>
                    <button class="btn-view-submissions" data-hw-pk="{{ hw.pk }}" data-hw-title="{{ hw.title }}" data-hw-info="{{ hw.school_class.name }} ‚Ä¢ {{ hw.subject.name }}">
                        <i class="far fa-eye"></i>
                        –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–∞–±–æ—Ç—ã
                    </button>
                </div>
            </div>
            {% empty %}
            <p id="no-homeworks-message" style="text-align:center; color: var(--text-secondary); padding: 20px;">–í—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è.</p>
            {% endfor %}
        </div>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –°–û–ó–î–ê–ù–ò–Ø/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –î–ó -->
<div class="modal-overlay" id="homework-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-homework-modal">&times;</button>
        <div class="modal-header">
            <h2>–°–æ–∑–¥–∞—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
            <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ–º–∞—à–Ω–µ–º –∑–∞–¥–∞–Ω–∏–∏</p>
        </div>
        <form id="homework-form" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="form-group full-width" style="margin-top: 24px;">
                <label for="{{ homework_form.title.id_for_label }}">–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
                {{ homework_form.title }}
            </div>
            <div class="form-grid">
                <div class="form-group"><label for="{{ homework_form.school_class.id_for_label }}">–ö–ª–∞—Å—Å</label>{{ homework_form.school_class }}</div>
                <div class="form-group"><label for="{{ homework_form.subject.id_for_label }}">–ü—Ä–µ–¥–º–µ—Ç</label>{{ homework_form.subject }}</div>
                <div class="form-group"><label for="{{ homework_form.due_date.id_for_label }}">–°—Ä–æ–∫ —Å–¥–∞—á–∏</label>{{ homework_form.due_date }}</div>
            </div>
            <div class="form-group full-width"><label for="{{ homework_form.description.id_for_label }}">–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>{{ homework_form.description }}</div>
            <div class="form-group full-width"><label for="{{ homework_form.attached_file.id_for_label }}">–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>{{ homework_form.attached_file }}</div>
            <div class="modal-footer full-width">
                <button type="button" class="btn-secondary" id="cancel-homework-btn">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-submit">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </form>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ü–†–û–°–ú–û–¢–†–ê –†–ê–ë–û–¢ -->
<!-- <div class="modal-overlay" id="submissions-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-submissions-modal">&times;</button>
        <div class="modal-header">
            <h2 id="submissions-modal-title"></h2>
            <p id="submissions-modal-info"></p>
        </div>
        <div class="submissions-table-container">
            <table class="submissions-table">
                <thead>
                    <tr><th>–£—á–µ–Ω–∏–∫</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Å–¥–∞—á–∏</th><th>–û—Ü–µ–Ω–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
                </thead>
                <tbody id="submissions-tbody"></tbody>
            </table>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" id="cancel-submissions-btn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div> -->

<div class="modal-overlay" id="submissions-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-submissions-modal">&times;</button>
        <div class="modal-header"><h2 id="submissions-modal-title"></h2><p id="submissions-modal-info"></p></div>
        <div class="submissions-table-container">
            <table class="submissions-table">
                <thead>
                    <!-- –ò–ó–ú–ï–ù–ï–ù–ê –≠–¢–ê –°–¢–†–û–ö–ê -->
                    <tr><th>–£—á–µ–Ω–∏–∫</th><th>–§–∞–π–ª</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–∞—Ç–∞ —Å–¥–∞—á–∏</th><th>–û—Ü–µ–Ω–∫–∞</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr>
                </thead>
                <tbody id="submissions-tbody"></tbody>
            </table>
        </div>
        <div class="modal-footer"><button type="button" class="btn-secondary" id="cancel-submissions-btn">–ó–∞–∫—Ä—ã—Ç—å</button></div>
    </div>
</div>

<!-- –ù–û–í–û–ï –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –†–ï–¶–ï–ù–ó–ò–ò -->
<div class="modal-overlay" id="grading-modal">
    <div class="modal-container">
        <button class="close-btn" id="close-grading-modal">&times;</button>
        <div class="modal-header">
            <h2>–†–µ—Ü–µ–Ω–∑–∏—è –Ω–∞ —Ä–∞–±–æ—Ç—É</h2>
            <p id="grading-student-name"></p>
        </div>
        <form id="grading-form">
            {% csrf_token %}
            <div class="form-group">
                <label for="grade-input">–û—Ü–µ–Ω–∫–∞ (0-100)</label>
                <input type="number" id="grade-input" name="grade" min="0" max="100" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, 85">
            </div>
            <div class="form-group">
                <label for="comment-textarea">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <textarea id="comment-textarea" name="comment" placeholder="–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" id="cancel-grading-btn">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn-gradient">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–Ω–∑–∏—é</button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // --- –û–ë–™–Ø–í–õ–Ø–ï–ú –í–°–ï –û–°–ù–û–í–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´ –û–î–ò–ù –†–ê–ó ---
    const homeworkListContainer = document.getElementById('homework-list-container');
    const homeworkModal = document.getElementById('homework-modal');
    const submissionsModal = document.getElementById('submissions-modal');
    const gradingModal = document.getElementById('grading-modal');
    
    // --- –ë–õ–û–ö 1: –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –°–û–ó–î–ê–ù–ò–Ø/–†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø ---
    if (homeworkModal && homeworkListContainer) {
        const openCreateBtn = document.querySelector('.btn-create');
        const homeworkForm = document.getElementById('homework-form');
        const modalTitle = homeworkModal.querySelector('h2');
        const submitButton = homeworkForm.querySelector('.btn-submit');
        const closeModalBtn = document.getElementById('close-homework-modal');
        const cancelModalBtn = document.getElementById('cancel-homework-btn');

        const openModalForCreate = () => {
            modalTitle.textContent = '–°–æ–∑–¥–∞—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ';
            submitButton.textContent = '–°–æ–∑–¥–∞—Ç—å';
            homeworkForm.reset();
            homeworkForm.action = "{% url 'api_create_homework' %}";
            homeworkModal.style.display = 'flex';
        };

        const openModalForEdit = async (homeworkId) => {
            modalTitle.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ';
            submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            homeworkForm.reset();
            homeworkForm.action = `/api/homework/${homeworkId}/update/`;
            try {
                const response = await fetch(`/api/homework/${homeworkId}/details/`);
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);
                
                const data = result.data;
                homeworkForm.querySelector('#id_title').value = data.title;
                homeworkForm.querySelector('#id_description').value = data.description;
                homeworkForm.querySelector('#id_school_class').value = data.school_class;
                homeworkForm.querySelector('#id_subject').value = data.subject;
                homeworkForm.querySelector('#id_due_date').value = data.due_date;
                homeworkModal.style.display = 'flex';
            } catch (error) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è.');
            }
        };

        const closeModal = () => { homeworkModal.style.display = 'none'; };

        openCreateBtn.addEventListener('click', openModalForCreate);
        closeModalBtn.addEventListener('click', closeModal);
        cancelModalBtn.addEventListener('click', closeModal);
        homeworkModal.addEventListener('click', (e) => { if (e.target === homeworkModal) closeModal(); });

        homeworkForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            try {
                const response = await fetch(this.action, {
                    method: 'POST', body: formData, headers: { 'X-CSRFToken': getCookie('csrftoken') },
                });
                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    window.location.reload(); 
                } else {
                    alert("–û—à–∏–±–∫–∞: " + JSON.stringify(result.errors));
                }
            } catch (error) {
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞.');
            }
        });
        
        homeworkListContainer.addEventListener('click', function(e) {
            const editButton = e.target.closest('.edit-btn');
            if (editButton) {
                openModalForEdit(editButton.dataset.hwPk);
            }
        });
    }

    // --- –ë–õ–û–ö 2: –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ü–†–û–°–ú–û–¢–†–ê –†–ê–ë–û–¢ ---
    if (submissionsModal && homeworkListContainer) {
        const closeSubmissionsBtn = document.getElementById('close-submissions-modal');
        const cancelSubmissionsBtn = document.getElementById('cancel-submissions-btn');
        const submissionsTbody = document.getElementById('submissions-tbody');

        const openSubmissionsModal = async (hwId, hwTitle, hwInfo) => {
            submissionsModal.querySelector('#submissions-modal-title').textContent = hwTitle;
            submissionsModal.querySelector('#submissions-modal-info').textContent = hwInfo;
            submissionsTbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';
            submissionsModal.style.display = 'flex';

            try {
                const response = await fetch(`/api/homework/${hwId}/submissions/`);
                const data = await response.json();
                if (!response.ok || data.status !== 'success') throw new Error(data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.');

                submissionsTbody.innerHTML = '';
                // –ò–ó–ú–ï–ù–ï–ù COLSPAN –° 5 –ù–ê 6
                if (data.submissions.length === 0) {
                     submissionsTbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">–†–∞–±–æ—Ç—ã –µ—â–µ –Ω–µ —Å–¥–∞–Ω—ã.</td></tr>';
                     return;
                }

                data.submissions.forEach(sub => {
                    let statusHtml, gradeHtml = '<td>-</td>', actionHtml = '<td>-</td>';
                    let actionButton = `<button class="btn-check-grade" disabled>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>`;
                    
                    // --- –ù–û–í–´–ô –ë–õ–û–ö –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò –°–°–´–õ–ö–ò –ù–ê –§–ê–ô–õ ---
                    let fileHtml = '<td>-</td>'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–∏—Ä–µ, –µ—Å–ª–∏ —Ñ–∞–π–ª–∞ –Ω–µ—Ç
                    if (sub.file_url) {
                        fileHtml = `<td>
                            <a href="${sub.file_url}" class="file-link" target="_blank" rel="noopener noreferrer" title="–û—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ">
                                <i class="fas fa-paperclip"></i> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                            </a>
                        </td>`;
                    }
                    // --- –ö–û–ù–ï–¶ –ù–û–í–û–ì–û –ë–õ–û–ö–ê ---

                    if (sub.status === '–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ') {
                        statusHtml = `<span class="status-tag status-checked"><i class="fas fa-check-circle"></i> –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>`;
                        gradeHtml = `<td><span class="grade-circle">${sub.grade}</span></td>`;
                        actionButton = `<button class="btn-check-grade">–ò–∑–º–µ–Ω–∏—Ç—å</button>`;
                    } else if (sub.status === '–°–¥–∞–Ω–æ') {
                        statusHtml = `<span class="status-tag status-submitted"><i class="fas fa-check"></i> –°–¥–∞–Ω–æ</span>`;
                        actionButton = `<button class="btn-check-grade">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>`;
                    } else {
                        statusHtml = `<span class="status-tag status-awaiting"><i class="far fa-clock"></i> –û–∂–∏–¥–∞–µ—Ç—Å—è</span>`;
                    }

                    actionHtml = `<td data-submission-pk="${sub.submission_id}" data-student-name="${sub.full_name}" data-grade="${sub.grade || ''}" data-comment="${sub.teacher_comment || ''}">${actionButton}</td>`;

                    // --- –ò–ó–ú–ï–ù–ï–ù–ê –≠–¢–ê –°–¢–†–û–ö–ê: –î–û–ë–ê–í–õ–ï–ù–ê –ü–ï–†–ï–ú–ï–ù–ù–ê–Ø fileHtml ---
                    const row = `<tr id="sub-row-${sub.submission_id}"><td>${sub.full_name}</td>${fileHtml}<td>${statusHtml}</td><td>${sub.submitted_at || '-'}</td>${gradeHtml}${actionHtml}</tr>`;
                    submissionsTbody.insertAdjacentHTML('beforeend', row);
                });
            } catch (error) {
                // –ò–ó–ú–ï–ù–ï–ù COLSPAN –° 5 –ù–ê 6
                submissionsTbody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: red;">${error.message}</td></tr>`;
            }
        };

        const closeSubmissionsModal = () => { submissionsModal.style.display = 'none'; };
        closeSubmissionsBtn.addEventListener('click', closeSubmissionsModal);
        cancelSubmissionsBtn.addEventListener('click', closeSubmissionsModal);
        submissionsModal.addEventListener('click', (e) => { if (e.target === submissionsModal) closeSubmissionsModal(); });
        
        // –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–´–ô –°–õ–£–®–ê–¢–ï–õ–¨ –°–û–ë–´–¢–ò–ô –î–õ–Ø –ö–ù–û–ü–ö–ò "–ü–†–û–°–ú–û–¢–†–ï–¢–¨ –†–ê–ë–û–¢–´"
        homeworkListContainer.addEventListener('click', (e) => {
            const viewBtn = e.target.closest('.btn-view-submissions');
            if (viewBtn) {
                const { hwPk, hwTitle, hwInfo } = viewBtn.dataset;
                openSubmissionsModal(hwPk, hwTitle, hwInfo);
            }
        });
    }

    // --- –ë–õ–û–ö 3: –õ–æ–≥–∏–∫–∞ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –†–ï–¶–ï–ù–ó–ò–ò ---
    if (gradingModal) {
        const submissionsTbody = document.getElementById('submissions-tbody');
        const gradingForm = document.getElementById('grading-form');
        const studentNameEl = document.getElementById('grading-student-name');
        const gradeInput = document.getElementById('grade-input');
        const commentTextarea = document.getElementById('comment-textarea');
        let currentSubmissionRow = null;

        const openGradingModal = (cell) => {
            const { submissionPk, studentName, grade, comment } = cell.dataset;
            currentSubmissionRow = document.getElementById(`sub-row-${submissionPk}`);
            
            studentNameEl.textContent = studentName;
            gradeInput.value = grade || "";
            commentTextarea.value = comment || "";
            gradingForm.dataset.submissionPk = submissionPk;
            gradingModal.style.display = 'flex';
        };

        const closeGradingModal = () => { gradingModal.style.display = 'none'; };

        gradingModal.querySelector('#close-grading-modal').addEventListener('click', closeGradingModal);
        gradingModal.querySelector('#cancel-grading-btn').addEventListener('click', closeGradingModal);
        gradingModal.addEventListener('click', (e) => { if (e.target === gradingModal) closeGradingModal(); });

        gradingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            const submissionPk = this.dataset.submissionPk;
            const grade = gradeInput.value;
            const comment = commentTextarea.value;

            try {
                const response = await fetch(`/api/submission/${submissionPk}/grade/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') },
                    body: JSON.stringify({ grade: grade, comment: comment }),
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                if (currentSubmissionRow) {
                    const statusCell = currentSubmissionRow.cells[1];
                    const gradeCell = currentSubmissionRow.cells[3];
                    const actionCell = currentSubmissionRow.cells[4];
                    const actionBtn = actionCell.querySelector('.btn-check-grade');

                    statusCell.innerHTML = `<span class="status-tag status-checked"><i class="fas fa-check-circle"></i> –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>`;
                    gradeCell.innerHTML = result.new_grade ? `<span class="grade-circle">${result.new_grade}</span>` : '-';
                    actionBtn.textContent = '–ò–∑–º–µ–Ω–∏—Ç—å';
                    actionCell.dataset.grade = result.new_grade || "";
                    actionCell.dataset.comment = comment;
                }
                closeGradingModal();
            } catch (error) {
                alert(`–û—à–∏–±–∫–∞: ${error.message}`);
            }
        });

        submissionsTbody.addEventListener('click', (e) => {
            const checkBtn = e.target.closest('.btn-check-grade');
            if (checkBtn) {
                // –ü–µ—Ä–µ–¥–∞–µ–º –≤—Å—é —è—á–µ–π–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ data-–∞—Ç—Ä–∏–±—É—Ç—ã
                openGradingModal(checkBtn.parentElement);
            }
        });
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–π listener –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø–æ Escape
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.querySelectorAll('.modal-overlay').forEach(modal => modal.style.display = 'none');
        }
    });
});
</script>
</body>
</html>