{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª | –®–∫–æ–ª—å–Ω–∞—è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root{--bg-main:#F9FAFB;--bg-widget:#FFFFFF;--text-primary:#111827;--text-secondary:#6B7280;--border-color:#E5E7EB;--accent-primary:#4F46E5;--accent-light:#EEF2FF;--grade-5:#D1FAE5;--grade-5-text:#065F46;--grade-4:#DBEAFE;--grade-4-text:#1E40AF;--grade-3:#FEF3C7;--grade-3-text:#92400E}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;background-color:var(--bg-main);color:var(--text-primary)}.container{max-width:1400px;margin:0 auto;padding:24px}.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px}.logo{display:flex;align-items:center;gap:12px}.logo-icon{width:40px;height:40px;background-color:var(--accent-primary);border-radius:8px;color:white;display:grid;place-items:center;font-size:20px;font-weight:bold}.logo h1{font-size:18px;font-weight:600}.logo p{font-size:14px;color:var(--text-secondary)}.user-profile{display:flex;align-items:center;gap:16px}.user-details{text-align:right}.user-details .name{font-weight:600}.user-details .role{font-size:14px;color:var(--text-secondary)}.user-avatar{width:40px;height:40px;border-radius:50%;background-color:#D8B4FE;color:#581C87;display:grid;place-items:center;font-weight:600}.main-nav{background-color:var(--bg-widget);border:1px solid var(--border-color);border-radius:12px;padding:8px;margin-bottom:24px}.main-nav ul{display:flex;list-style:none;justify-content:flex-start;gap:8px}.main-nav a{display:flex;align-items:center;gap:8px;padding:10px 16px;text-decoration:none;color:var(--text-secondary);font-weight:600;border-radius:8px;transition:all .2s}.main-nav a:hover{background-color:#F3F4F6;color:var(--text-primary)}.main-nav a.active{background-color:var(--accent-light);color:var(--accent-primary)}.journal-widget{background-color:var(--bg-widget);border:1px solid var(--border-color);border-radius:16px;padding:24px}.journal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}.journal-title h2{font-size:20px;font-weight:600}.journal-title p{color:var(--text-secondary)}.class-selector{padding:10px 16px;border:1px solid var(--border-color);border-radius:8px;font-weight:500;background-color:#F9FAFB;font-family:'Inter',sans-serif;font-size:14px;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");background-position:right .75rem center;background-repeat:no-repeat;background-size:1.5em 1.5em;padding-right:2.5rem}.journal-tabs{display:flex;gap:8px;margin-bottom:24px}.tab-btn{padding:8px 16px;background:0 0;border:1px solid var(--border-color);border-radius:8px;font-weight:600;cursor:pointer;font-family:'Inter',sans-serif;font-size:14px;transition:all .2s}.tab-btn.active{background-color:var(--accent-primary);border-color:transparent;color:#fff}.journal-table{width:100%;border-collapse:collapse}.journal-table th{font-size:12px;text-transform:uppercase;color:var(--text-secondary);font-weight:600;text-align:center;padding-bottom:12px}.journal-table th:first-child{text-align:left}.journal-table td{padding:8px;text-align:center;border-bottom:1px solid var(--border-color)}.journal-table tr:last-child td{border-bottom:none}.journal-table td:first-child{text-align:left;font-weight:500}.grade-cell{cursor:pointer;border-radius:8px;min-height:48px;display:flex;align-items:center;justify-content:center;transition:background-color .2s}.grade-cell:hover{background-color:#EFF6FF}.grade-badge{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;font-weight:700;font-size:16px}.grade-5{background-color:var(--grade-5);color:var(--grade-5-text)}.grade-4{background-color:var(--grade-4);color:var(--grade-4-text)}.grade-3{background-color:var(--grade-3);color:var(--grade-3-text)}.grade-badge-container{position:relative;display:inline-flex}.grade-comment-icon{font-size:10px;color:var(--text-secondary);position:absolute;bottom:5px;right:5px}.attendance-icon{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;border-radius:50%;font-weight:bold;font-size:16px}.status-P{color:#059669;background-color:#ECFDF5}.status-A{color:#DC2626;background-color:#FEF2F2}.status-L{color:#D97706;background-color:#FFFBEB}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.5)}.modal-content{background-color:#F9FAFB;margin:15% auto;padding:20px;border:none;width:90%;max-width:400px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.1)}.close-btn{color:#aaa;float:right;font-size:28px;font-weight:bold;cursor:pointer}#grade-form input,#grade-form textarea{width:100%;padding:12px;font-size:16px;border:1px solid var(--border-color);border-radius:8px;margin:10px 0;font-family:'Inter',sans-serif}#grade-form textarea{resize:vertical;min-height:60px}#grade-form button{width:100%;padding:12px;background-color:var(--accent-primary);color:#fff;border:none;border-radius:8px;font-size:16px;cursor:pointer}
    </style>
</head>
<body>
<div class="container">
    <header class="header">
        <div class="logo">
            <div class="logo-icon">üéì</div>
            <div>
                <h1>–®–∫–æ–ª—å–Ω–∞—è –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞</h1>
                <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—á–µ–±–Ω—ã–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º</p>
            </div>
        </div>
        <div class="user-profile">
            <div class="user-details">
                <div class="name">{{ teacher.user.get_full_name }}</div>
                <div class="role">–£—á–∏—Ç–µ–ª—å {{ selected_subject.name|default:"" }}</div>
            </div>
            <div class="user-avatar">{{ teacher.user.first_name|first }}{{ teacher.user.last_name|first }}</div>
        </div>
    </header>

    <nav class="main-nav">
        <ul>
            <li><a href="{% url 'teacher_dashboard' %}">–ì–ª–∞–≤–Ω–∞—è</a></li>
            <li><a href="#">–ü–æ—É—Ä–æ—á–Ω—ã–µ –ø–ª–∞–Ω—ã</a></li>
            <li><a href="{% url 'teacher_journal' %}"><i class="fas fa-book"></i> –ñ—É—Ä–Ω–∞–ª</a></li>
            <li><a href="{% url 'teacher_homework' %}"><i class="fas fa-pencil-alt"></i> –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</a></li>
            <li><a href="#">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a></li>
        </ul>
    </nav>

    <main class="journal-widget">
        <div class="journal-header">
            <div class="journal-title">
                <h2>–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –∂—É—Ä–Ω–∞–ª</h2>
                <p>–û—Ü–µ–Ω–∫–∏ –∏ –ø–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å —É—á–∞—â–∏—Ö—Å—è</p>
            </div>
            <form method="get" id="filter-form" style="display: flex; gap: 16px;">
                <select name="school_id" onchange="this.form.submit()" class="class-selector">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É</option>
                    {% for school in all_schools %}
                        <option value="{{ school.pk }}" {% if school.pk == selected_school_id %}selected{% endif %}>{{ school.name }}</option>
                    {% endfor %}
                </select>
                <select name="class_id" onchange="this.form.submit()" class="class-selector">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å</option>
                    {% for class in teacher_classes %}
                        <option value="{{ class.pk }}" {% if class.pk == selected_class_id %}selected{% endif %}>{{ class.name }}</option>
                    {% endfor %}
                </select>
                <select name="subject_id" onchange="this.form.submit()" class="class-selector">
                     <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç</option>
                    {% for subject in teacher_subjects %}
                        <option value="{{ subject.pk }}" {% if subject.pk == selected_subject_id %}selected{% endif %}>{{ subject.name }}</option>
                    {% endfor %}
                </select>
            </form>
        </div>

        <div class="journal-tabs">
            <button class="tab-btn active" data-content-type="grades">–û—Ü–µ–Ω–∫–∏</button>
            <button class="tab-btn" data-content-type="attendance">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</button>
        </div>

        <!-- –ï–î–ò–ù–´–ô –ö–û–ù–¢–ï–ô–ù–ï–† –î–õ–Ø –î–ò–ù–ê–ú–ò–ß–ï–°–ö–û–ì–û –ö–û–ù–¢–ï–ù–¢–ê -->
        <div id="journal-content-container">
            {% if journal_data %}
                {% include "partials/_grades_table.html" %}
            {% else %}
                <p style="text-align: center; color: var(--text-secondary); padding: 20px;">
                    –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —à–∫–æ–ª—É, –∫–ª–∞—Å—Å –∏ –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞.
                </p>
            {% endif %}
        </div>
    </main>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤–≤–æ–¥–∞ –æ—Ü–µ–Ω–∫–∏ -->
<div id="grade-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h3 id="modal-student-name"></h3>
        <p id="modal-date"></p>
        <form id="grade-form">
            <input type="number" id="grade-input" min="0" max="100" placeholder="–û—Ü–µ–Ω–∫–∞ (0-100)">
            <textarea id="comment-input" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –æ—Ü–µ–Ω–∫–µ..."></textarea>
            <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const journalContentContainer = document.getElementById('journal-content-container');
    const tabsContainer = document.querySelector('.journal-tabs');
    const modal = document.getElementById('grade-modal');
    
    // --- –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–õ–ò–ö–û–í –í–ù–£–¢–†–ò –ö–û–ù–¢–ï–ô–ù–ï–†–ê ---
    journalContentContainer.addEventListener('click', function(e) {
        const gradeCell = e.target.closest('.grade-cell');
        const attendanceCell = e.target.closest('.attendance-cell');

        if (gradeCell) {
            handleGradeCellClick(gradeCell);
        } else if (attendanceCell) {
            handleAttendanceCellClick(attendanceCell);
        }
    });

    // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø –¢–ê–ë–û–í ---
    tabsContainer.addEventListener('click', async function(e) {
        if (e.target.classList.contains('tab-btn')) {
            tabsContainer.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');

            const contentType = e.target.dataset.contentType;
            const filterForm = document.getElementById('filter-form');
            const params = new URLSearchParams(new FormData(filterForm)).toString();

            let url;
            if (contentType === 'attendance') {
                url = `{% url 'journal_attendance_content' %}?${params}`;
            } else { // 'grades'
                url = `{% url 'teacher_journal_grades_content' %}?${params}`;
            }
            
            try {
                journalContentContainer.innerHTML = '<p style="text-align: center; padding: 20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</p>';
                const response = await fetch(url);
                journalContentContainer.innerHTML = await response.text();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:', error);
                journalContentContainer.innerHTML = '<p style="color: red; text-align: center; padding: 20px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }
    });

    // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –†–ê–ë–û–¢–´ –° –û–¶–ï–ù–ö–ê–ú–ò ---
    const closeModalBtn = modal.querySelector('.close-btn');
    const gradeForm = document.getElementById('grade-form');
    const gradeInput = document.getElementById('grade-input');
    const commentInput = document.getElementById('comment-input');
    let activeGradeCell = null;

    function handleGradeCellClick(cell) {
        activeGradeCell = cell;
        const studentName = activeGradeCell.closest('tr').cells[0].textContent.trim();
        modal.querySelector('#modal-student-name').textContent = `–û—Ü–µ–Ω–∫–∞ –¥–ª—è: ${studentName}`;
        modal.querySelector('#modal-date').textContent = `–î–∞—Ç–∞: ${activeGradeCell.dataset.date}`;
        gradeInput.value = activeGradeCell.textContent.trim().replace(/[^0-9]/g, '');
        commentInput.value = activeGradeCell.dataset.comment;
        modal.style.display = 'block';
        gradeInput.focus();
    }

    gradeForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const payload = {
            student_id: activeGradeCell.dataset.studentId,
            date: activeGradeCell.dataset.date,
            subject_id: activeGradeCell.closest('tbody').dataset.subjectId,
            class_id: activeGradeCell.closest('tbody').dataset.classId,
            grade: gradeInput.value,
            comment: commentInput.value
        };

        const response = await fetch("{% url 'api_set_grade' %}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
            body: JSON.stringify(payload)
        });

        if (response.ok) {
            const result = await response.json();
            updateGradeCell(activeGradeCell, result.grade, result.has_comment);
            activeGradeCell.dataset.comment = payload.comment;
            modal.style.display = 'none';
        } else {
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ü–µ–Ω–∫–∏!');
        }
    });
    
    closeModalBtn.addEventListener('click', () => modal.style.display = 'none');
    window.addEventListener('click', (e) => { if (e.target == modal) modal.style.display = 'none'; });

    // --- –õ–û–ì–ò–ö–ê –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–û–°–ï–©–ê–ï–ú–û–°–¢–¨–Æ ---
    async function handleAttendanceCellClick(cell) {
        const currentStatusCode = cell.dataset.status;
        let nextStatusCode = (currentStatusCode === 'P') ? 'L' : (currentStatusCode === 'L') ? 'A' : 'P';
        
        updateAttendanceIcon(cell, nextStatusCode); // –û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

        const payload = {
            student_id: cell.dataset.studentId,
            date: cell.dataset.date,
            subject_id: cell.closest('tbody').dataset.subjectId,
            class_id: cell.closest('tbody').dataset.classId,
            status: nextStatusCode
        };
        
        try {
            const response = await fetch("{% url 'api_set_attendance' %}", {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken')},
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                updateAttendanceIcon(cell, currentStatusCode); // –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        } catch (error) {
            updateAttendanceIcon(cell, currentStatusCode); // –û—Ç–∫–∞—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
        }
    }

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function updateGradeCell(cell, gradeValue, hasComment) {
        if (gradeValue === null || gradeValue === '') {
            cell.innerHTML = '<span style="color: var(--text-secondary); font-size: 20px;">+</span>';
            return;
        }
        const gradeInt = parseInt(gradeValue);
        let badgeClass = (gradeInt >= 85) ? 'grade-5' : (gradeInt >= 65) ? 'grade-4' : 'grade-3';
        const commentIcon = hasComment ? '<span class="grade-comment-icon">üí¨</span>' : '';
        cell.innerHTML = `<div class="grade-badge-container"><div class="grade-badge ${badgeClass}">${gradeInt}</div>${commentIcon}</div>`;
    }

    function updateAttendanceIcon(cell, statusCode) {
        let iconHtml = '';
        if (statusCode === 'P') iconHtml = '<span class="attendance-icon status-P">‚úì</span>';
        else if (statusCode === 'A') iconHtml = '<span class="attendance-icon status-A">‚úï</span>';
        else if (statusCode === 'L') iconHtml = '<span class="attendance-icon status-L">!</span>';
        cell.innerHTML = iconHtml;
        cell.dataset.status = statusCode;
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
</body>
</html>